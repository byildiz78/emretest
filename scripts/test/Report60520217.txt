SET TRANSACTION ISOLATION LEVEL READ UNCOMMITTED
DECLARE @depoID INT;
DECLARE @branchID INT;
SET @depoID=(SELECT ISNULL((SELECT TOP 1 w.WarehouseID FROM posDailyClosingHeader AS w WHERE w.ClosingID=@closeID),0));
SET @branchID=(SELECT ISNULL((SELECT TOP 1 w.BranchID FROM posDailyClosingHeader AS w WHERE w.ClosingID=@closeID),0));

IF OBJECT_ID('tempdb..#tempTable') IS NOT NULL
BEGIN
 DROP TABLE #tempTable;
END;
create table #tempTable
( StokID int, StokAdi Varchar(150),Birim Varchar(150),Depo Varchar(150),DonemBaslangici DATETIME,OrtalamaFiyat FLOAT,  Devir FLOAT, Giren FLOAT,IadeGiren FLOAT, TransferGiren FLOAT,UretimdenGiren FLOAT,
 SatisCikan FLOAT,IadeCikan FLOAT,  TransferCikan FLOAT,ReceteTuketim FLOAT, UretimeCikan FLOAT, OlmasiGereken FLOAT, Sayim FLOAT, SatisTutar FLOAT,ReceteTuketimOrt FLOAT
);
INSERT INTO #tempTable ( StokID,StokAdi,Birim,Depo,DonemBaslangici,OrtalamaFiyat, Devir, Giren,IadeGiren, TransferGiren,UretimdenGiren, SatisCikan,IadeCikan, TransferCikan,ReceteTuketim, UretimeCikan, OlmasiGereken,Sayim,SatisTutar)
SELECT p.ProductID,p.ProductName,'','',@date1,0,0,0,0,0,0,0,0,0,0,0,0,0,0 FROM posProducts AS p WHERE p.IsSaleProduct=0 AND p.ProductID IN (SELECT distinct d.ProductID FROM posDailyClosingDetail AS d);

IF @closeID>0
BEGIN
 UPDATE #tempTable SET Devir = posDailyClosingDetail.CountAmount
 FROM #tempTable 
 INNER JOIN posDailyClosingDetail ON #tempTable.StokID=posDailyClosingDetail.ProductID AND posDailyClosingDetail.ClosingID=@closeID;
 UPDATE #tempTable SET OrtalamaFiyat = posDailyClosingDetail.AveragePrice,Sayim=posDailyClosingDetail.CountAmount
 FROM #tempTable 
 INNER JOIN posDailyClosingDetail ON #tempTable.StokID=posDailyClosingDetail.ProductID AND posDailyClosingDetail.ClosingID=@closeID
END

UPDATE #tempTable SET Birim=u.UnitName
FROM #tempTable INNER JOIN posProducts ON #tempTable.StokID=posProducts.ProductID INNER JOIN posProductUnits AS u ON u.UnitID=posProducts.UnitID;

UPDATE #tempTable SET Depo = w.WarehouseName FROM #tempTable INNER JOIN posWarehouse AS w ON w.WarehouseID=@depoID;

UPDATE #tempTable SET Giren= ISNULL(( SELECT sum(d.OutgoingMain) AS summm FROM posOrderDetail AS d 
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID AND h.BranchID=@branchID
WHERE d.DocumentTypeID IN (6) AND d.ProductID=#tempTable.StokID 
AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)),0) +
ISNULL(( SELECT sum(d.OutgoingMain) AS summm
FROM posOrderDetail AS d with(nolock) INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID  AND h.BranchID=@branchID
WHERE d.DocumentTypeID IN (6) AND d.ProductID=p.ProductID AND 
d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)),0);

UPDATE #tempTable SET IadeGiren= ISNULL(( SELECT sum(d.IncomingMain) AS summm FROM posOrderDetail AS d 
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID
WHERE d.DocumentTypeID IN (27) AND d.ProductID=#tempTable.StokID and d.WarehouseID=@depoID
AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0) +
ISNULL(( SELECT sum(d.IncomingMain) AS summm
FROM posOrderDetail AS d with(nolock) INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID 
WHERE d.DocumentTypeID IN (27) AND d.ProductID=p.ProductID and d.WarehouseID=@depoID AND 
d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0);

UPDATE #tempTable SET UretimdenGiren= ISNULL(( SELECT sum(d.IncomingMain) AS summm FROM posOrderDetail AS d 
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID
WHERE d.DocumentTypeID IN (36,37) AND d.ProductID=#tempTable.StokID and d.WarehouseID=@depoID
AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0) +
ISNULL(( SELECT sum(d.IncomingMain) AS summm
FROM posOrderDetail AS d with(nolock) INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID 
WHERE d.DocumentTypeID IN (36,37) AND d.ProductID=p.ProductID and d.WarehouseID=@depoID AND 
d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0);

UPDATE #tempTable SET TransferGiren = ISNULL((
SELECT SUM(d.Quantity *isnull(u.UnitRate,1)) FROM posWarehouseTransferDetail AS d 
INNER JOIN posWarehouseTransfer AS h ON h.TransferID = d.TransferID
LEFT OUTER JOIN posProductUnits AS u ON d.UnitID =u.UnitID  
WHERE d.ProductID=#tempTable.StokID and h.TargetWarehouseID=@depoID AND 
h.TransportDate>=@date1 AND h.TransportDate<dateadd(day,1,@date2)
),0) + ISNULL((
SELECT SUM(d.Quantity *isnull(u.UnitRate,1)) FROM posWarehouseTransferDetail AS d 
INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posWarehouseTransfer AS h ON h.TransferID = d.TransferID
LEFT OUTER JOIN posProductUnits AS u ON d.UnitID =u.UnitID  
WHERE d.ProductID=p.ProductID and h.TargetWarehouseID=@depoID AND 
h.TransportDate>=@date1 AND h.TransportDate<dateadd(day,1,@date2) ),0);

UPDATE #tempTable SET SatisTutar=isnull(SatisTutar,0)+ISNULL(( 
SELECT sum(rs.SatisTutari) AS SatisTutari FROM	(
SELECT r.BranchID, r.SatisTutari,isnull(fd.ProductID,p.ProductID) AS StokId,
isnull(fp.ProductName,p.ProductName) AS StokAdi,isnull(fp.ProductCode,p.ProductCode) AS StokKodu
FROM (
SELECT h.BranchID, t.MenuItemKey,sum(t.ExtendedPrice) AS SatisTutari
  FROM OrderHeaders AS h WITH (NOLOCK) 
INNER JOIN OrderTransactions AS t ON h.BranchID = t.BranchID AND h.OrderKey = t.OrderKey AND t.LineDeleted=0
WHERE 
h.BranchID=@branchID
AND h.LineDeleted=0
AND DATEADD(dd, DATEDIFF(dd, 0,h.OrderDateTime), 0.25)>=@date1
AND DATEADD(dd, DATEDIFF(dd, 0,h.OrderDateTime), 0.25)<=dateadd(day,1,dateadd(day,1,@date2))
GROUP BY h.BranchID,t.MenuItemKey
) AS r
INNER JOIN GlobalMenuItems AS m ON m.BranchID = r.BranchID AND m.MenuItemKey = r.MenuItemKey
INNER JOIN posProducts AS p ON p.ProductKey=m.MenuItemGlobalKey
LEFT OUTER JOIN posManafactureFormulaAssign AS fa ON fa.ProductID = p.ProductID AND fa.BranchID = 1
LEFT OUTER JOIN posManafactureFormulaDetail AS fd ON fd.FormulaID = fa.FormulaID
LEFT OUTER JOIN posManafactureFormula AS f ON f.FormulaID = fd.FormulaID
LEFT OUTER JOIN posProducts AS fp ON fp.ProductID=fd.ProductID
WHERE fp.ProductID=#tempTable.StokID
GROUP BY r.BranchID,fd.ProductID,fp.ProductName,p.ProductID,p.ProductName,fp.ProductCode,p.ProductCode,SatisTutari
) AS rs
),0);

UPDATE #tempTable SET SatisCikan = ISNULL(( SELECT sum(d.OutgoingMain) AS summm FROM posOrderDetail AS d 
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID
WHERE d.DocumentTypeID IN (4,6,13,41) AND d.ProductID=#tempTable.StokID and d.WarehouseID=@depoID
AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0) +
ISNULL(( SELECT sum(d.OutgoingMain) AS summm
FROM posOrderDetail AS d with(nolock) INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID 
WHERE d.DocumentTypeID IN (4,6,13,41) AND d.ProductID=p.ProductID and d.WarehouseID=@depoID AND 
d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0);

UPDATE #tempTable SET SatisCikan=SatisCikan+ISNULL(( 
SELECT sum(rs.Tuketim) AS Tuketim FROM	(
SELECT r.BranchID, sum(r.miktar*isnull(fd.Amount,1)) AS Tuketim,isnull(fd.ProductID,p.ProductID) AS StokId,
isnull(fp.ProductName,p.ProductName) AS StokAdi,isnull(fp.ProductCode,p.ProductCode) AS StokKodu
FROM (
SELECT h.BranchID, t.MenuItemKey,sum(t.Quantity) AS miktar
  FROM OrderHeaders AS h WITH (NOLOCK) 
INNER JOIN OrderTransactions AS t ON h.BranchID = t.BranchID AND h.OrderKey = t.OrderKey AND t.LineDeleted=0
WHERE 
h.BranchID=@branchID
AND h.LineDeleted=0
AND DATEADD(dd, DATEDIFF(dd, 0,h.OrderDateTime), 0.25)>=@date1
AND DATEADD(dd, DATEDIFF(dd, 0,h.OrderDateTime), 0.25)<=dateadd(day,1,dateadd(day,1,@date2))
GROUP BY h.BranchID,t.MenuItemKey
) AS r

INNER JOIN NewGlobalMenuItems AS m ON m.BranchID = r.BranchID AND m.MenuItemKey = r.MenuItemKey
INNER JOIN posProducts AS p ON p.ProductKey=m.MenuItemGlobalKey
LEFT OUTER JOIN posManafactureFormulaAssign AS fa ON fa.ProductID = p.ProductID AND fa.BranchID = r.BranchID
LEFT OUTER JOIN posManafactureFormulaDetail AS fd ON fd.FormulaID = fa.FormulaID
LEFT OUTER JOIN posManafactureFormula AS f ON f.FormulaID = fd.FormulaID
LEFT OUTER JOIN posProducts AS fp ON fp.ProductID=fd.ProductID
WHERE fp.ProductID=#tempTable.StokID
GROUP BY r.BranchID,fd.ProductID,fp.ProductName,p.ProductID,p.ProductName,fp.ProductCode,p.ProductCode
) AS rs
),0);

UPDATE #tempTable SET SatisCikan=ISNULL((
SELECT sum(t.Quantity) AS miktar
  FROM OrderHeaders AS h WITH (NOLOCK) 
INNER JOIN OrderTransactions AS t ON h.BranchID = t.BranchID AND h.OrderKey = t.OrderKey AND t.LineDeleted=0
INNER JOIN GlobalMenuItems AS m ON m.BranchID = t.BranchID AND m.MenuItemKey = t.MenuItemKey
INNER JOIN posProducts AS p ON p.ProductKey=m.MenuItemGlobalKey
WHERE 
h.BranchID=@branchID
AND h.LineDeleted=0
AND DATEADD(dd, DATEDIFF(dd, 0,h.OrderDateTime), 0.25)>=@date1
AND DATEADD(dd, DATEDIFF(dd, 0,h.OrderDateTime), 0.25)<=dateadd(day,1,dateadd(day,1,@date2))
AND p.ProductID=#tempTable.StokID
),0) WHERE isnull(#tempTable.SatisCikan,0)=0;

UPDATE #tempTable SET IadeCikan = ISNULL(( SELECT sum(d.OutgoingMain) AS summm FROM posOrderDetail AS d 
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID
WHERE d.DocumentTypeID IN (43) AND d.ProductID=#tempTable.StokID and d.WarehouseID=@depoID
AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0) +
ISNULL(( SELECT sum(d.OutgoingMain) AS summm
FROM posOrderDetail AS d with(nolock) INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID 
WHERE d.DocumentTypeID IN (43) AND d.ProductID=p.ProductID and d.WarehouseID=@depoID AND 
d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2)
AND isnull(h.IsConverted,0)=0),0);

UPDATE #tempTable SET TransferCikan = ISNULL((
SELECT SUM(d.Quantity *isnull(u.UnitRate,1)) FROM posWarehouseTransferDetail AS d 
INNER JOIN posWarehouseTransfer AS h ON h.TransferID = d.TransferID
LEFT OUTER JOIN posProductUnits AS u ON d.UnitID =u.UnitID  
WHERE d.ProductID=#tempTable.StokID and h.WarehouseID=@depoID AND 
h.TransportDate>=@date1 AND h.TransportDate<dateadd(day,1,@date2) ),0) 
+ISNULL(( SELECT SUM(d.Quantity *isnull(u.UnitRate,1)) FROM posWarehouseTransferDetail AS d 
INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posWarehouseTransfer AS h ON h.TransferID = d.TransferID
LEFT OUTER JOIN posProductUnits AS u ON d.UnitID =u.UnitID  
WHERE d.ProductID=p.ProductID and h.WarehouseID=@depoID AND 
h.TransportDate>=@date1 AND h.TransportDate<dateadd(day,1,@date2) ),0);


UPDATE #tempTable SET ReceteTuketim  = ISNULL(( SELECT sum(d.OutgoingMain) AS summm FROM posOrderDetail AS d 
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID
WHERE d.DocumentTypeID IN (35) AND d.ProductID=#tempTable.StokID and d.WarehouseID=@depoID
AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2) 
AND isnull(h.IsConverted,0)=0),0) +
ISNULL(( SELECT sum(d.OutgoingMain) AS summm
FROM posOrderDetail AS d with(nolock) INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID 
WHERE d.DocumentTypeID IN (35) AND d.ProductID=p.ProductID and d.WarehouseID=@depoID AND 
d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2) 
AND isnull(h.IsConverted,0)=0),0);

;with cte as
(
SELECT d.ProductID, sum(d.OutgoingMain) AS OutgoingMain
FROM #tempTable AS t
	INNER JOIN posOrderDetail AS d ON t.StokID=d.ProductID and d.WarehouseID=@depoID
	INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID
	WHERE d.DocumentTypeID IN (35) 
	AND d.DocumentDateTime>=DATEADD(day,-15, @date2) AND d.DocumentDateTime<dateadd(day,1,@date2) 
	AND isnull(h.IsConverted,0)=0
	GROUP BY d.ProductID
)
UPDATE #tempTable set ReceteTuketimOrt=ROUND(c.OutgoingMain/15,2)
FROM #tempTable as t
inner join cte as c on t.StokID=c.ProductID 

UPDATE #tempTable SET UretimeCikan  = ISNULL(( SELECT sum(d.OutgoingMain) AS summm FROM posOrderDetail AS d 
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID
WHERE d.DocumentTypeID IN (36) AND d.ProductID=#tempTable.StokID and d.WarehouseID=@depoID
AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2) 
AND isnull(h.IsConverted,0)=0),0) +
ISNULL(( SELECT sum(d.OutgoingMain) AS summm
FROM posOrderDetail AS d with(nolock) INNER JOIN posProducts AS p ON p.MainProductID=#tempTable.StokID
INNER JOIN posOrderHeader AS h ON h.OrderID = d.OrderID 
WHERE d.DocumentTypeID IN (36) AND d.ProductID=p.ProductID and d.WarehouseID=@depoID AND 
d.DocumentDateTime>=@date1 AND d.DocumentDateTime<dateadd(day,1,@date2) 
AND isnull(h.IsConverted,0)=0),0);

UPDATE #tempTable SET OlmasiGereken = Devir+Giren+IadeGiren+TransferGiren+UretimdenGiren-SatisCikan-IadeCikan-TransferCikan-UretimeCikan-ReceteTuketim 
SELECT isnull(pc.PickValue,'') AS Kategori,isnull(pg.PickValue,'') AS Grubu,p.ProductCode AS [StokKodu],d.StokAdi AS [StokAdi],d.OlmasiGereken AS [OlmasiGereken],d.Birim,
ISNULL(ReceteTuketimOrt,0) ReceteTuketimOrt, ISNULL(ROUND(OlmasiGereken/NULLIF(ReceteTuketimOrt,0) ,2),0) [KalanStokGunSayisi], ISNULL(ROUND(OlmasiGereken/(NULLIF(ReceteTuketimOrt,0) * 7) ,2),0) [KalanStokHaftalikSayisi]
FROM [#tempTable] AS d
INNER JOIN posProducts AS p ON p.ProductID=d.StokID
LEFT OUTER JOIN posPickList AS pg ON pg.ListID=p.GroupID
LEFT OUTER JOIN posPickList AS pc ON pc.ListID=p.CategoryID
LEFT OUTER JOIN posBranchs AS pb ON pb.WarehouseID=@depoID
--where StokAdi='BALKAN COREGI'
ORDER BY StokAdi;