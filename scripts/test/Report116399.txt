--/*
---- UYARI !!!  BU ÖZEL FIX SADECE 1 KERE ÇALIŞTIRILMALIDIR !!!
--
---- MainMenuItemTransactionKey DÜZELT
--UPDATE
--	t1
--SET 
--	MainMenuItemText = t2.MenuItemText,
--	MainMenuItemTransactionKey = t2.TransactionKey
--FROM OrderTransactions t1
--	LEFT JOIN OrderTransactions t2 ON t2.OrderKey = t1.OrderKey AND t2.CustomField1 = SUBSTRING(t1.CustomField1, 0, CHARINDEX('-',t1.CustomField1)+1) AND t2.TransactionKey <> t1.TransactionKey
--WHERE 
--	t1.CustomField1 IS NOT NULL 
--	AND t1.OrderDateTime BETWEEN '2024-03-11' AND '2024-04-09'
--
---- GERÇEK BİRİM FİYATI BUL
--UPDATE t
--	SET X_DefaultUnitPrice = pr.DefaultUnitPrice
--FROM OrderTransactions t
--	INNER JOIN posBranchs br ON br.BranchID = t.BranchID
--	INNER JOIN NewGlobalMenuItemPrices pr ON pr.PriceTemplateKey = br.PriceTemplateKey AND pr.MenuItemKey = t.MenuItemKey
--WHERE
--	1=1
--	AND t.OrderDateTime BETWEEN '2024-03-11' AND '2024-04-09'
--	AND t.CustomField1 IS NOT NULL
--	AND t.MainMenuItemText LIKE '%RAMAZAN%'
--	AND t.LineDeleted = 0
--	AND t.X_DefaultUnitPrice IS NULL;
--
---- GERÇEK KOMBO FİYATINI BUL
--;WITH list AS (
--	SELECT 
--		t.OrderKey,
--		t.MainMenuItemTransactionKey,
--		t2.MenuItemUnitPrice,
--		SUM(t.X_DefaultUnitPrice) AS X_DefaultUnitPrice,
--		(t2.MenuItemUnitPrice / SUM(t.X_DefaultUnitPrice)) AS Factor
--	FROM OrderTransactions t
--	INNER JOIN OrderTransactions t2 ON t2.TransactionKey = t.MainMenuItemTransactionKey
--	WHERE 
--		1=1
--		AND t.OrderDateTime BETWEEN '2024-03-11' AND '2024-04-09'
--		AND t.CustomField1 IS NOT NULL
--		AND t.MainMenuItemText LIKE '%RAMAZAN%'
--		AND t.LineDeleted = 0
--	GROUP BY
--		t.OrderKey,
--		t.MainMenuItemTransactionKey,
--		t2.MenuItemUnitPrice
--)
--
--	
---- GERÇEK BİRİM FİYATI, GERÇEK KOMBO FİYATINI DİKKATE ALARAK REVİZE ET
--UPDATE tx
--SET 
--	X_DefaultCalcUnitPrice = ROUND(tx.X_DefaultUnitPrice * (CASE WHEN l.Factor > 1 THEN 1 ELSE l.Factor END),2)
--FROM OrderTransactions tx
--INNER JOIN list l on l.MainMenuItemTransactionKey = tx.MainMenuItemTransactionKey AND l.OrderKey = tx.OrderKey
--*/

DECLARE @subeSayisi INT
SET @subeSayisi=(SELECT COUNT(b.BranchID) FROM efr_Branchs AS b WITH (NOLOCK) WHERE b.@BranchID AND ISNULL(b.IsActive,1)=1)

SELECT
b.BranchName AS [Şube],
b.CustomField12 AS [Bölge],
r.[Satış Türü],
ROUND(SUM(r.ToplamCiro),2) AS [Satış],
ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) AS [Yan Ürün Yüzde],
ROUND((isnull((SUM(r.IcecekSayisi)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) AS [İçecek Tabak Yüzde],
ROUND(SUM(r.YanUrunTutar),2) AS [Yan Ürün Tutar],
SUM(r.IcecekSayisi) AS [İçecek Sayısı],
SUM(r.IcecekTutar) AS [İçecek Tutar],
SUM(r.TabakSayisi) AS TabakSayisi,
ROUND(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.KonukSayisi),0),0),2) AS [Ortalama Çek Tutarı],
ROUND(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.TabakSayisi),0),0),2) AS [Ortalama Tabak Tutarı]
FROM
(
SELECT
h.BranchID,
SUM(h.AmountDue) AS ToplamCiro,
0.0 AS YanUrunTutar,
0.0 AS IcecekTutar,
COUNT(h.AutoID) AS CekSayisi,
0 AS TabakSayisi,
0 AS IcecekSayisi,
COUNT(isnull(nullif(h.GuestNumber,0),1)) AS KonukSayisi,
CASE h.OrderType
 WHEN '1' THEN 'MASA SERVIS'
 WHEN '2' THEN 'İSME ÇEK'
 WHEN '3' THEN 'AL GÖTÜR'
 WHEN '4' THEN 'TEZGAH'
 WHEN '5' THEN 'PAKET SERVIS'
 ELSE 'TANIMSIZ'
 END AS 'Satış Türü'
FROM
OrderHeaders AS h WITH (NOLOCK)
WHERE
h.OrderDateTime BETWEEN @date1 AND @date2
AND h.LineDeleted=0
AND h.@BranchID
GROUP BY
h.BranchID,h.OrderType

UNION ALL

SELECT 
	h.BranchID,
	0.0 AS ToplamCiro, 
	SUM(CASE WHEN ISNULL(p.CustomField12,'')='YAN ÜRÜNLER' THEN ( (CASE WHEN t.MenuItemUnitPrice = 0 THEN  t.Quantity * ISNULL(t.X_DefaultCalcUnitPrice, t.MenuItemUnitPrice) ELSE t.ExtendedPrice END) * ISNULL(((h.AmountDue/nullif(isnull(nullif(h.SubTotal,0),h.AmountDue),0))),1)) ELSE 0 END) AS YanUrunTutar,
	ROUND(SUM(CASE WHEN isnull(p.CustomField12,'')='İÇECEKLER' THEN t.ExtendedPrice ELSE 0 END),2) AS IcecekTutar,
	0 AS CekSayisi,
	SUM(CASE WHEN ISNULL(p.CustomField12,'')='TABAKLAR' THEN t.Quantity ELSE 0 END) AS TabakSayisi,
	SUM(CASE WHEN ISNULL(p.CustomField12,'')='İÇECEKLER' THEN t.Quantity ELSE 0 END) AS IcecekSayisi,
	0 AS KonukSayisi,
	CASE h.OrderType
 WHEN '1' THEN 'MASA SERVIS'
 WHEN '2' THEN 'İSME ÇEK'
 WHEN '3' THEN 'AL GÖTÜR'
 WHEN '4' THEN 'TEZGAH'
 WHEN '5' THEN 'PAKET SERVIS'
 ELSE 'TANIMSIZ'
 END AS 'Satış Türü'
FROM 
	OrderHeaders AS h WITH (NOLOCK)
	INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
	LEFT JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
WHERE 
	h.OrderDateTime BETWEEN @date1 AND @date2
	AND h.LineDeleted=0
	AND h.@BranchID
GROUP BY 
	h.BranchID,h.OrderType
) AS r
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID
GROUP BY
b.CustomField12, b.BranchName,r.[Satış Türü]
ORDER BY
ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) DESC