DECLARE @logdatetime DATETIME
DECLARE @statustext VARCHAR(20)
DECLARE @acikkalmasuresi INT = 0 
DECLARE @kapalikalmasuresi INT = 0 
DECLARE @branchid INT = 0 
DECLARE @branchname VARCHAR(200)
DECLARE @opendatetime DATETIME
DECLARE @closedatetime DATETIME
DECLARE @kapandimi BIT = 1

IF OBJECT_ID('tempdb..#tempTable') IS NOT NULL BEGIN DROP TABLE #tempTable END
CREATE TABLE #tempTable(
	BranchID INT,
	BranchName NVARCHAR(150),
	OpenMinute INT,
	CloseMinute INT,
	AllTime INT
)

SET @closedatetime = @date1
DECLARE Activities CURSOR FOR

select LogDateTime,StatusText,b.BranchID,b.BranchName from webBranchStatusLogs l
INNER JOIN efr_Branchs b on b.BranchID=l.BranchID
where b.@BranchID and LogDateTime between @date1 and @date2 and IntegrationName LIKE '%web%'order by b.BranchID,LogDateTime

OPEN Activities

FETCH NEXT FROM Activities INTO @logdatetime,@statustext,@branchid,@branchname

WHILE @@FETCH_STATUS = 0
BEGIN
IF((@statustext='AÇIK' or @statustext='YOĞUN') and @kapandimi=1)
BEGIN
SET @opendatetime = @logdatetime
SET @kapalikalmasuresi = @kapalikalmasuresi + DATEDIFF(MINUTE,@closedatetime,@logdatetime)
SET @kapandimi=0
END
ELSE IF(@statustext='KAPALI')
 BEGIN
  SET @kapandimi=1
  SET @closedatetime = @logdatetime
  SET @acikkalmasuresi = @acikkalmasuresi + DATEDIFF(MINUTE,@opendatetime,@logdatetime)
 END

FETCH NEXT FROM Activities INTO @logdatetime,@statustext,@branchid,@branchname
END
CLOSE Activities
DEALLOCATE Activities

SET @kapalikalmasuresi= @kapalikalmasuresi+DATEDIFF(MINUTE,@date1,@date2)-(@acikkalmasuresi+@kapalikalmasuresi)
 INSERT INTO
	#tempTable(
	BranchID,
	BranchName, 
	OpenMinute, 
	CloseMinute,
	AllTime
)
SELECT @branchid,@branchname,@acikkalmasuresi,@kapalikalmasuresi,DATEDIFF(MINUTE,@date1,@date2)
select branchName,OpenMinute*100/AllTime as [Açık Kalma Yüzdesi],CloseMinute*100/AllTime as [Kapalı Kalma Yüzdesi] from  #tempTable order by BranchID