SELECT
	br.BranchName as [Şube],
	br.BranchID,
	OH.OrderKey,
	OH.OrderID as [Çek No],
	OH.OrderDateTime as [Çek Tarihi],
	op.PaymentDateTime as [Ödeme Tarihi],
	OH.AmountDue as [Çek Tutarı], 
	ISNULL(SUM(OP.AmountPaid),0) as [Ödeme Tutarı],
	(OH.AmountDue-ISNULL(SUM(OP.AmountPaid),0)) AS [Fark]
FROM
	OrderHeaders OH WITH (NOLOCK)
INNER JOIN efr_Branchs BR ON BR.BranchID = OH.BranchID
LEFT OUTER JOIN OrderPayments OP ON OP.OrderKey = OH.OrderKey 
WHERE
	OH.OrderDateTime >=@date1
AND OH.OrderDateTime <=@date2
AND OH.LineDeleted = 0
AND OH.OrderStatus = 2
AND BR.@BranchID
GROUP BY
	BR.BranchName,
	BR.BranchID,
	OH.OrderKey,
	OH.OrderDateTime,
	op.PaymentDateTime,
	OH.AmountDue,
	OH.OrderID
HAVING
 CONVERT(DATE,oh.OrderDateTime,104)<>CONVERT(DATE,op.PaymentDateTime,104)