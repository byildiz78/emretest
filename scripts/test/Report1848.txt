SET NOCOUNT ON;
IF OBJECT_ID('tempdb..#temp') IS NOT NULL BEGIN DROP TABLE #temp; END;
IF OBJECT_ID('tempdb..#sure') IS NOT NULL BEGIN DROP TABLE #sure; END;
CREATE TABLE #temp(BranchID INT,Saat FLOAT,Saniye FLOAT,CekSayisi FLOAT);
CREATE TABLE #sure(BranchID INT,t1012 FLOAT,t1214 FLOAT,t1416 FLOAT,t1618 FLOAT,t1820 FLOAT,t2022 FLOAT,t2224 FLOAT,tGenel FLOAT);

INSERT INTO #temp(BranchID, Saat, Saniye,CekSayisi)
SELECT h.BranchID,round((DATEPART(hour,h.OrderDateTime)/2.0)-0.05,0)*2 AS Saat,DATEDIFF(SECOND,h.OrderDateTime,MAX(p.PaymentDateTime)) AS [Fark],1
  FROM OrderHeaders AS h WITH (NOLOCK)
INNER JOIN OrderPayments AS p ON p.OrderKey = h.OrderKey AND p.LineDeleted=0
WHERE h.@BranchID
AND h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
GROUP BY h.BranchID,h.OrderDateTime;

WITH sonuc AS (
SELECT t.BranchID,t.Saat,SUM(t.CekSayisi) AS Adet FROM #temp AS t GROUP BY t.BranchID,t.Saat)
UPDATE #temp SET CekSayisi =s.Adet
FROM #temp
INNER JOIN sonuc AS s ON s.BranchID= #temp.BranchID AND s.Saat = #temp.Saat;

INSERT INTO #sure(BranchID, t1012, t1214, t1416, t1618, t1820, t2022, t2224,tGenel)
SELECT t.BranchID,SUM(CASE WHEN t.Saat IN (10) THEN t.Saniye/t.CekSayisi ELSE 0 END) AS t1012 
,SUM(CASE WHEN t.Saat IN (12) THEN t.Saniye/t.CekSayisi ELSE 0 END) AS t1214
,SUM(CASE WHEN t.Saat IN (14) THEN t.Saniye/t.CekSayisi ELSE 0 END) AS t1416 
,SUM(CASE WHEN t.Saat IN (16) THEN t.Saniye/t.CekSayisi ELSE 0 END) AS t1618 
,SUM(CASE WHEN t.Saat IN (18) THEN t.Saniye/t.CekSayisi ELSE 0 END) AS t1820
,SUM(CASE WHEN t.Saat IN (20) THEN t.Saniye/t.CekSayisi ELSE 0 END) AS t2022
,SUM(CASE WHEN t.Saat IN (22) THEN t.Saniye/t.CekSayisi ELSE 0 END) AS t2224
,SUM(t.Saniye)/COUNT(t.CekSayisi) AS tGenel
FROM #temp AS t
GROUP BY t.BranchID;

SELECT b.BranchName AS [Şube], cast(round(DATEDIFF(minute,r.Acilis,r.Kapanis)/60,0) AS NVARCHAR)+' Saat '+
cast((DATEDIFF(minute,r.Acilis,r.Kapanis) % 60) AS NVARCHAR) +' dk'
 AS [Toplam Konuk Ağırlanan Süre], r.KonukSayisi AS [Konuk Sayısı]
,round(s.t1012/60,2) AS [10:00-12:00]
,round(s.t1214/60,2) AS [12:00-14:00]
,round(s.t1416/60,2) AS [14:00-16:00]
,round(s.t1618/60,2) AS [16:00-18:00]
,round(s.t1820/60,2) AS [18:00-20:00]
,round(s.t2022/60,2) AS [20:00-22:00]
,round(s.t2224/60,2) AS [22:00-24:00]
,round(s.tGenel/60,2) AS [Genel Ort.]
 FROM (
SELECT h.BranchID,MIN(h.OrderDateTime) AS Acilis,MAX(p.PaymentDateTime) AS Kapanis,SUM(isnull(nullif(h.GuestNumber,0),1)) AS KonukSayisi 
FROM OrderHeaders AS h WITH (NOLOCK)
INNER JOIN OrderPayments AS p ON p.OrderKey = h.OrderKey AND p.LineDeleted=0
WHERE h.@BranchID
AND h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
GROUP BY h.BranchID) AS r
INNER JOIN #sure AS s ON s.BranchID = r.BranchID
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID

IF OBJECT_ID('tempdb..#temp') IS NOT NULL BEGIN DROP TABLE #temp; END;
IF OBJECT_ID('tempdb..#sure') IS NOT NULL BEGIN DROP TABLE #sure; END;