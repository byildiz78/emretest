DECLARE @ciro DECIMAL(18,2)

select top 1 @ciro=ciro from (
SELECT SUM(amountdue) as ciro FROM OrderHeaders h
where h.OrderDateTime between @date1 and @date2 and h.LineDeleted=0
group by BranchID) as tablo order by ciro desc

select *,ROUND((TC*100)/@ciro,1) as Oran,CASE WHEN GHTC>TC THEN ROUND((NULLIF(TC,0)/NULLIF(GHTC,0))*100,1)-100 ELSE ROUND((NULLIF(TC,0)/NULLIF(GHTC,0))*100,1) END GecenHaftaOran from (
select br.BranchName as SubeAdi
,(select ROUND(SUM(h.AmountDue),2) as Tutar from OrderHeaders h 
where h.OrderDateTime>@date1 and h.OrderDateTime<@date2 and h.LineDeleted=0 and h.BranchID=br.BranchID) as TC
,(select ROUND(SUM(h.AmountDue),2) as Tutar from OrderHeaders h 
where h.OrderDateTime>DATEADD(DAY,-7,@date1) and h.OrderDateTime<convert(varchar, CONVERT(DATETIME,DATEADD(DAY,-8,@date2)), 23) +' '+ convert(varchar,getdate(), 24) and h.LineDeleted=0 and h.BranchID=br.BranchID) as GHTC
,(select ROUND(SUM(h.AmountDue),2) as Tutar from OrderHeaders h 
where h.OrderDateTime>DATEADD(DAY,-7,@date1) and h.OrderDateTime<DATEADD(DAY,-7,@date2) and h.LineDeleted=0 and h.BranchID=br.BranchID) as GHTCTUM,
(SELECT CAST(SUM(t.Quantity) AS INT) from OrderTransactions t inner join posProducts p on p.ProductKey=t.MenuItemKey and p.CustomField12='TABAKLAR' where t.OrderDateTime BETWEEN @date1 and @date2 and t.LineDeleted=0 and t.BranchID=br.BranchID) as KisiSayisi,
(SELECT CAST(SUM(t.Quantity) AS INT) from OrderTransactions t inner join posProducts p on p.ProductKey=t.MenuItemKey and p.CustomField12='TABAKLAR' where t.OrderDateTime>DATEADD(DAY,-7,@date1) and t.OrderDateTime<convert(varchar, CONVERT(DATETIME,DATEADD(DAY,-8,@date2)), 23) +' '+ convert(varchar,getdate(), 24) and t.LineDeleted=0 and t.BranchID=br.BranchID) as GHKisiSayisi,
(SELECT CAST(SUM(t.Quantity) AS INT) from OrderTransactions t inner join posProducts p on p.ProductKey=t.MenuItemKey and p.CustomField12='TABAKLAR' where t.OrderDateTime>DATEADD(DAY,-7,@date1) and t.OrderDateTime<DATEADD(DAY,-7,@date2) and t.LineDeleted=0 and t.BranchID=br.BranchID) as GHKisiSayisiTUM
from efr_Branchs br where br.IsActive=1 and br.@BranchID
) AS TABLO
order by TC desc
