SET NOCOUNT ON;
SET LANGUAGE english;
DECLARE @s1 DATETIME;SET @s1=@date1;
DECLARE @s2 DATETIME;SET @s2=@date2;
SET LANGUAGE turkish;
IF OBJECT_ID('tempdb..#tempTable') IS NOT NULL BEGIN DROP TABLE #tempTable;END;
create table #tempTable(BranchID INT,OrderKey UNIQUEIDENTIFIER,OrderDateTime DATETIME,MenuItemText NVARCHAR(150),MenuGrubu NVARCHAR(150),MenuKategori NVARCHAR(150),Quantity FLOAT,UnitPrice FLOAT,ExtendedPrice FLOAT,indirim FLOAT,tutar FLOAT,satir FLOAT,indirimNakit FLOAT,OrderType NVARCHAR(150));
INSERT INTO #tempTable(BranchID, OrderKey, OrderDateTime, MenuItemText,MenuGrubu,MenuKategori, Quantity, UnitPrice,ExtendedPrice, indirim,tutar,indirimNakit,OrderType)
SELECT t.BranchID,
t.OrderKey,
dateadd(hour,-4,t.OrderDateTime),
t.MenuItemText,t.MenuItemGroupText,
t.MenumItemCategoryText,
t.Quantity,t.MenuItemUnitPrice,
t.ExtendedPrice,
ROUND((t.Quantity*t.MenuItemUnitPrice)-t.ExtendedPrice,2) AS indirim,
h.AmountDue,
isnull(h.DiscountCashAmount,0),
CASE h.OrderType
            WHEN '1' THEN 'MASA SERVIS'
            WHEN '2' THEN 'İSME ÇEK'
            WHEN '3' THEN 'AL GÖTÜR'
            WHEN '4' THEN 'TEZGAH'
            WHEN '5' THEN 'PAKET SERVIS'
            ELSE 'TANIMSIZ'
       END AS 'Satış Türü'
FROM OrderHeaders AS h WITH(NOLOCK)

INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0

WHERE h.OrderDateTime>@s1
AND h.OrderDateTime<@s2
AND h.LineDeleted=0
AND h.@BranchID;

UPDATE #tempTable SET UnitPrice=ExtendedPrice/Quantity,indirim=0 WHERE UnitPrice=0 AND Quantity>0;
WITH sonuc AS (SELECT s.OrderKey,SUM(s.ExtendedPrice) AS toplam FROM #tempTable AS s GROUP BY s.OrderKey )
UPDATE #tempTable SET satir = s.toplam
FROM #tempTable
INNER JOIN sonuc AS s ON #tempTable.OrderKey = s.OrderKey;

--DELETE FROM #tempTable WHERE ExtendedPrice=0 AND satir=0;

UPDATE #tempTable SET indirimNakit = round(indirimNakit*ExtendedPrice/satir,5) WHERE satir>0;
SELECT b.BranchName
AS Şube, 
DATENAME(MONTH,t.OrderDateTime) AS Ay,
DATEADD(D,0,DATEDIFF(dd, 0,t.OrderDateTime)) AS Gün,
t.MenuKategori AS Kategori,
t.MenuGrubu AS Grubu,
t.MenuItemText AS Menü,
t.OrderType as Tip,
t.UnitPrice AS Fiyat,
SUM(t.Quantity) AS Miktar,
SUM(t.Quantity*t.UnitPrice) AS [Brüt Tutar],
round(SUM((t.Quantity*t.UnitPrice)-t.ExtendedPrice),2) AS [Ürün İndirimi],
round(SUM(t.ExtendedPrice),2) AS [Ürün Tutar],
round(SUM((t.indirimNakit)),2) AS [Nakit İndirim],
round(SUM((t.Quantity*t.UnitPrice)*((t.satir-t.tutar)/isnull(nullif(t.satir,0),1))),2)-round(SUM((t.indirimNakit)),2) AS [Çek İndirimi],
round(SUM((t.Quantity*t.UnitPrice)*((t.satir-t.tutar)/isnull(nullif(t.satir,0),1))),2)+round(SUM((t.Quantity*t.UnitPrice)-t.ExtendedPrice),2) AS [Toplam İndirim],
round(SUM(round(t.ExtendedPrice*(t.tutar/isnull(nullif(t.satir,0),1)),5)),2) AS [Net Tutar]
FROM #tempTable AS t
INNER JOIN efr_Branchs AS b ON b.BranchID=t.BranchID
GROUP BY b.BranchName,t.MenuItemText,t.MenuGrubu,t.MenuKategori,t.UnitPrice,t.OrderType
,DATENAME(MONTH,t.OrderDateTime),DATEADD(D,0,DATEDIFF(dd, 0,t.OrderDateTime))
ORDER BY b.BranchName,DATEADD(D,0,DATEDIFF(dd, 0,t.OrderDateTime)),t.MenuItemText;
IF OBJECT_ID('tempdb..#tempTable') IS NOT NULL BEGIN DROP TABLE #tempTable;END;
SET LANGUAGE english;