SELECT 
	b.BranchName AS [Şube],
	--FORMAT(bt.LastInstantControlDatetime, 'dd.MM.yyyy HH:mm:ss') AS [Son Genel Veri Gönderim Zamanı],
	FORMAT(MAX(t.OrderDateTime), 'dd.MM.yyyy HH:mm:ss') AS [Son Satış Zamanı]
FROM 
	efr_BranchTerminals AS bt
INNER JOIN efr_Branchs b ON b.BranchID = bt.BranchID
LEFT JOIN OrderTransactions t ON t.BranchID = b.BranchID
WHERE 
	1=1
	AND b.IsActive = 1
      

GROUP BY 
	b.BranchName,
	bt.LastInstantControlDatetime
HAVING
	MAX(t.OrderDateTime) < DATEADD(minute,-30,GETDATE())
ORDER BY 
	MAX(t.OrderDateTime) DESC