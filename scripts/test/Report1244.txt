
SELECT b.BranchName AS [Şube], 
SUM((CASE WHEN r.FarkDakika <= 1 THEN r.Quantity ELSE 0 END)) AS [< 1 DK],
SUM((CASE WHEN r.FarkDakika < 5 AND r.FarkDakika > 1 THEN r.Quantity ELSE 0 END)) AS [1-5 DK], 
SUM((CASE WHEN r.FarkDakika < 7 AND r.FarkDakika >= 5 THEN r.Quantity ELSE 0 END)) AS [6-7 DK],
 SUM((CASE WHEN r.FarkDakika <10 AND r.FarkDakika >= 7 THEN r.Quantity ELSE 0 END)) AS [7-10 DK], 
 SUM((CASE WHEN r.FarkDakika >= 10 THEN r.Quantity ELSE 0 END)) AS [> 10 DK], 
ROUND((SUM(r.FarkDakika) / SUM(r.Quantity)), 3) AS [ORTALAMA SÜRE]
FROM (
SELECT BranchID, cast(DATEDIFF(minute, TransactionDateTime, CAST(
case when len(isnull(CustomField5,''))<9 or isnull(CustomField5,'') not LIKE '%201%' and isnull(CustomField5,'') not LIKE '%202%' or isnull(CustomField5,'') LIKE '%t%' THEN dateadd(minute,1,TransactionDateTime) ELSE  CustomField5 END
AS DATETIME)) AS FLOAT)/Quantity AS FarkDakika,Quantity
FROM OrderTransactions WITH (NOLOCK)
WHERE 
OrderTransactions.@BranchID
AND OrderTransactions.Transactiondatetime >= @date1 
AND OrderTransactions.Transactiondatetime <= @date2 
AND OrderTransactions.MenuItemGroupText IN ('01-BAŞLANGIÇ VE TATLILAR','BALIKLAR','04-YOBURGER!','07-İSVEÇ KÖFTE','05-HAMBURGER','03-TENDERS','08-BUTTA','WINGS','IZGARABUTT','13-YODÜRÜM!','06-PERİ PERİ','09-ÇOCUK MENÜSÜ','10-PERSONEL MENÜ','02-İLAVE ve SOSLAR')
 AND LineDeleted = 0 
) AS r
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID
WHERE R.FarkDakika<70 AND R.FarkDakika>=1
GROUP BY b.BranchName

