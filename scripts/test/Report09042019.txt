DECLARE @subeSayisi INT;SET @subeSayisi=(SELECT COUNT(b.BranchID) FROM efr_Branchs AS b WITH (NOLOCK) WHERE b.@BranchID AND b.VerisonInfo IS NOT NULL AND ISNULL(b.IsActive,1)=1);

SELECT b.BranchName AS [Şube],
b.CustomField12 AS [Bölge],
round(SUM(r.ToplamCiro),2) AS [Satış],
ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) AS [Yan Ürün Yüzde],
ROUND((isnull((SUM(r.IcecekSayisi)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) AS [İçecek Tabak Yüzde],
round(SUM(r.YanUrunTutar),2) AS [Yan Ürün Tutar],
SUM(r.IcecekSayisi) AS [İçecek Sayısı],
SUM(r.IcecekTutar) AS [İçecek Tutar],
SUM(r.TabakSayisi) AS TabakSayisi,
round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.KonukSayisi),0),0),2) AS [Ortalama Çek Tutarı],
round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.TabakSayisi),0),0),2) AS [Ortalama Tabak Tutarı],
r.Gun as Gün
 FROM (
SELECT h.BranchID,SUM(h.AmountDue) AS ToplamCiro, 0.0 AS YanUrunTutar, 0.0 AS IcecekTutar
,COUNT(h.AutoID) AS CekSayisi,0 AS TabakSayisi,0 AS IcecekSayisi,COUNT(isnull(nullif(h.GuestNumber,0),1)) AS KonukSayisi, DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, h.OrderDateTime))) Gun
 FROM OrderHeaders AS h WITH (NOLOCK)
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
GROUP BY h.BranchID, DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, h.OrderDateTime)))
UNION ALL
SELECT h.BranchID,0.0 AS ToplamCiro, 
SUM(CASE WHEN ISNULL(p.CustomField12,'')='YAN ÜRÜNLER' THEN (isnull(nullif(t.ExtendedPrice,0),t.Quantity*t.MenuItemUnitPrice) *ISNULL(((h.AmountDue/nullif(isnull(nullif(h.SubTotal,0),h.AmountDue),0))),1)) ELSE 0 END) AS YanUrunTutar,
SUM(CASE WHEN isnull(p.CustomField12,'')='İÇECEKLER' THEN t.ExtendedPrice ELSE 0 END) AS IcecekTutar
,0 AS CekSayisi,
SUM(CASE WHEN ISNULL(p.CustomField12,'')='TABAKLAR' THEN t.Quantity ELSE 0 END) AS TabakSayisi,
SUM(CASE WHEN ISNULL(p.CustomField12,'')='İÇECEKLER' THEN t.Quantity ELSE 0 END) AS IcecekSayisi,0 AS KonukSayisi,
DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, t.OrderDateTime))) as Gun
 FROM OrderHeaders AS h WITH (NOLOCK)
 INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
GROUP BY h.BranchID,DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, t.OrderDateTime)))
) AS r
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID
GROUP BY b.CustomField12,b.BranchName,r.Gun
ORDER BY  r.Gun;