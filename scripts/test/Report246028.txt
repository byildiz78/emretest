SELECT b.BranchName AS [Şube], w.WarehouseName AS [Depo],c.PickValue AS [Kategori],g.PickValue AS Grup,wt.WarehouseName AS [Hedef Depo],p.ProductCode AS [Stok Kodu], p.ProductName AS [Stok Adı]
,u.UnitName AS [Birim],sum(d.Quantity) AS Miktar,
isnull(isnull(NULLIF(isnull(pl.SalePrice,p.LastPurchasePrice),0),p.LastSalePrice),0) [Fiyat],
round(SUM(d.Quantity*isnull(isnull(NULLIF(isnull(pl.SalePrice,p.LastPurchasePrice),0),p.LastSalePrice),0)),2) AS Tutar
FROM posWarehouseTransfer AS t
INNER JOIN posBranchs AS b ON  b.WarehouseID = t.WarehouseID
INNER JOIN efr_Branchs AS eb ON  eb.BranchID = b.BranchID
INNER JOIN posWarehouse AS w ON w.WarehouseID = t.WarehouseID
INNER JOIN posWarehouse AS wt ON wt.WarehouseID = t.TargetWarehouseID
INNER JOIN posWarehouseTransferDetail AS d ON d.TransferID=t.TransferID
INNER JOIN posProducts AS p ON p.ProductID=d.ProductID
INNER JOIN posProductUnits AS u ON u.UnitID = d.UnitID
INNER JOIN posPickList AS c ON c.ListID=p.CategoryID
INNER JOIN posPickList AS g ON g.ListID=p.GroupID
LEFT OUTER JOIN posPriceList AS pl ON 
pl.ListName LIKE 
(CASE WHEN ISNULL(eb.CustomField1,'bayi')='bayi' THEN 'FRANCHISE FİYAT LİSTESİ' 
ELSE 'ŞUBE FİYAT LİSTESİxxx' END)
AND pl.ProductID=p.ProductID AND pl.SalePrice>0
WHERE t.TransferDate>@date1
AND t.TransferDate<@date2
AND b.@BranchID
AND wt.WarehouseName LIKE '%zay%'
GROUP BY b.BranchName, w.WarehouseName,wt.WarehouseName,p.ProductCode, p.ProductName,u.UnitName,c.PickValue,g.PickValue,p.LastSalePrice,p.LastPurchasePrice,pl.SalePrice