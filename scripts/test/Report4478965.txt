DECLARE @dt1 DATETIME,@dt2 DATETIME
SELECT @dt1=@date1,@dt2=@date2

DECLARE @ciro FLOAT;
SET @ciro=(
SELECT round((isnull((SUM(h.AmountDue)),0.0)),2)
FROM OrderHeaders AS h WITH(NOLOCK)
WHERE h.OrderDateTime between @dt1 and @dt2
AND h.@BranchID
AND h.linedeleted=0
);

DECLARE @paketdisiciro FLOAT;
SET @paketdisiciro=(
SELECT round((isnull((SUM(h.AmountDue)),0.0)),2)
FROM OrderHeaders AS h WITH(NOLOCK)
WHERE h.OrderDateTime between @dt1 and @dt2
AND h.@BranchID
AND h.linedeleted=0
AND h.OrderType<>5
);

DECLARE @yanuruntutar FLOAT;
SET @yanuruntutar=(
SELECT 
ROUND(SUM(t.ExtendedPrice * isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1) ), 2)
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON h.OrderKey = t.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey
WHERE t.OrderDateTime BETWEEN @dt1 AND @dt2
and t.@BranchID 
AND t.LineDeleted=0
and h.OrderType <> 5
AND h.linedeleted=0
AND ISNULL(m.CustomField12,'')='YAN ÜRÜNLER'
);

DECLARE @seftenisteciro FLOAT;
SET @seftenisteciro=(
SELECT round((isnull((SUM(h.AmountDue)),0.0)),2)
FROM OrderHeaders AS h WITH(NOLOCK)
WHERE h.OrderDateTime between @dt1 and @dt2
AND h.OrderType=5
AND h.@BranchID
AND h.linedeleted=0
);

declare @tabak int
set @tabak=(
SELECT 
round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) AS reportValue
FROM OrderTransactions AS t WITH(NOLOCK)
LEFT JOIN posProducts as p WITH (NOLOCK) on p.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
AND t.@BranchID 
AND t.linedeleted=0
AND p.CustomField12='TABAKLAR'
);

declare @paketdisitabak int
set @paketdisitabak=(
SELECT 
round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) AS reportValue
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
LEFT JOIN posProducts as p WITH (NOLOCK) on p.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
AND t.@BranchID 
AND t.linedeleted=0
and h.OrderType<>5
AND p.CustomField12='TABAKLAR'
);

declare @seftenistetabak FLOAT
set @seftenistetabak=(
SELECT 
round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) AS reportValue
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as p WITH (NOLOCK) on p.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
AND t.@BranchID 
AND t.linedeleted=0
and h.OrderType=5
AND p.CustomField12='TABAKLAR'
);

declare @AdisyonSayisi FLOAT;
set @AdisyonSayisi =(
select count(1) from OrderHeaders h WITH (NOLOCK)
where h.OrderType=5
and h.LineDeleted=0
and h.OrderDateTime between @dt1 and @dt2
and h.@BranchID 
);

declare @aktifSubeSayisi FLOAT;
set @aktifSubeSayisi =(
SELECT COUNT(DISTINCT br.BranchID)
FROM efr_Branchs br WITH (NOLOCK) 
LEFT OUTER JOIN Orderheaders h WITH (NOLOCK) ON h.BranchID = br.BranchID
AND h.orderdatetime between @dt1 and @dt2
AND h.BranchID=br.BranchID
AND h.linedeleted=0 
WHERE 1=1
AND br.@BranchID 
AND ISNULL(br.IsActive,1)=1
AND ISNULL(br.ShowDashboard,0)=1
);


SELECT 
@aktifSubeSayisi as [Aktif Şube Sayısı],
@ciro as [Toplam Ciro],
@tabak as [Ziyaretçi Sayısı],
round((isnull((@ciro / nullif(@tabak,0)),0.0)),2) as [Kişi Ortalama Tutar],
@seftenisteciro as [Şeften İste Ciro],
ROUND(@seftenisteciro/@ciro*100,2) as [Şeften İste Ciro %],
@seftenistetabak as [Şeften iste Tabak],
round(round((isnull((nullif(@seftenistetabak,0)),0.0)),0)/@tabak*100,2) as [Şeften İste Tabak %],
@AdisyonSayisi as [Şeften İste Adisyon Sayısı],
ROUND(@seftenisteciro/(case when @AdisyonSayisi=0 then 1 else @AdisyonSayisi end),2) as [Şeften İste Sepet Ortalaması (TL)],

@yanuruntutar as [Restoran Yan Ürün Tutar],
ROUND(@yanuruntutar/nullif(@paketdisiciro,0)*100,2) as [Restoran Yan Ürün %],

SUM(CASE WHEN p.CustomField12 = 'PERSONEL MENÜ' THEN t.Quantity ELSE 0 END) [Personel Menü Adet],
ROUND(SUM(CASE WHEN p.CustomField12 = 'PERSONEL MENÜ' THEN t.Quantity ELSE 0 END)/nullif(@tabak,0)*100,2) as [Personel Menü %],

SUM(CASE WHEN p.CustomField12 like '%İÇECEK%'  THEN t.Quantity ELSE 0 END) [İçecek Sayısı],
ROUND(SUM(CASE WHEN p.CustomField12  like '%İÇECEK%' THEN t.Quantity ELSE 0 END)/@paketdisitabak*100,2) as [Toplam İçecek Ziyaretçi Sayısı %],

SUM(CASE WHEN p.CustomField12 LIKE '%SAĞLIKLI%' THEN t.Quantity ELSE 0 END) [Sağlıklı İçecekler],
ROUND(SUM(CASE WHEN p.CustomField12 LIKE '%SAĞLIKLI%' THEN t.Quantity ELSE 0 END)/@paketdisitabak*100,2) as [Sağlıklı İçecek Ziyaretçi Sayısı %],

SUM(CASE WHEN p.CustomField13 = 'ÇORBA' THEN t.Quantity ELSE 0 END) as [Çorba Sayısı],
ROUND(SUM(CASE WHEN p.CustomField13 = 'ÇORBA' THEN t.Quantity ELSE 0 END)/@paketdisitabak*100,2) as [Çorba Ziyaretçi sayısı %],

SUM(CASE WHEN p.CustomField13 = 'BAŞLANGIÇ' THEN t.Quantity ELSE 0 END) as [Başlangıç Sayısı],
ROUND(SUM(CASE WHEN p.CustomField13 = 'BAŞLANGIÇ' THEN t.Quantity ELSE 0 END)/@paketdisitabak*100,2) as [Başlangıç Ziyaretçi sayısı %]
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders h WITH(NOLOCK) on h.OrderKey=t.OrderKey
INNER JOIN posProducts as p WITH (NOLOCK) on p.ProductKey=t.MenuItemKey
WHERE 1=1
AND t.OrderDateTime between @dt1 and @dt2
AND t.@BranchID
AND t.linedeleted=0
AND h.LineDeleted=0
AND h.OrderType<>5