select r.Şube,
cast(r.saat as varchar(2))+':00' as Saat,
sum(r.para) as Ciro,
sum(r.tabak) as [Tabak Sayısı]
from
(
select 
b.BranchName as Şube,
DATEPART(Hour, t.orderdatetime) AS saat,
 round(SUM(nullif(t.ExtendedPrice,0)*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0))),2) para,
sum(case when p.CustomField12='TABAKLAR' then  t.Quantity else 0 end ) as tabak
from  OrderTransactions t with(nolock)

INNER JOIN OrderHeaders h with(nolock) ON t.OrderKey=h.OrderKey
INNER JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
inner join efr_Branchs b on h.BranchID=b.BranchID
where t.OrderDateTime between @date1 and @date2
AND t.LineDeleted=0
AND h.OrderType=5
AND h.OrderTypeSourceExternalNo is  null
AND t.@BranchID
AND h.@BranchID
group by t.orderdatetime,t.MenuItemUnitPrice,t.Quantity,b.BranchName
) as r
group by r.saat,r.Şube
order by r.saat