

SELECT efr_Branchs.BranchName        AS [Sube Adı],
       ROUND(SUM(OrderHeaders.AmountDue), 2) AS [TOPLAM CİRO],
       SUM(h1.AmountDue)             AS [MASA CİRO],
       SUM(h1.GuestNumber)           AS [MASA KİŞİ SAYISI],
       ROUND(SUM(h1.AmountDue) / NULLIF(SUM(h1.GuestNumber), 0), 2) AS 
       [MASA SERVİS KİŞİ ORT],
       SUM(h2.AmountDue)             AS [PAKET CİRO],
       COUNT(h2.OrderKey)            AS [PAKET ADET],
       ROUND(
        SUM(h2.AmountDue) / NULLIF( COUNT(h2.OrderKey) , 0),
           2
       )                             AS [PAKET ORT]
FROM   OrderHeaders
       LEFT OUTER JOIN efr_Branchs
            ON  OrderHeaders.BranchID = efr_Branchs.BranchID
       LEFT OUTER JOIN OrderHeaders  AS h1
            ON  h1.OrderKey = OrderHeaders.OrderKey
            AND h1.OrderType = 1
       LEFT OUTER JOIN OrderHeaders  AS h2
            ON  h2.OrderKey = OrderHeaders.OrderKey
            AND h2.OrderType <> 1
WHERE  (OrderHeaders.LineDeleted = 0)
 AND (OrderHeaders.OrderDateTime >= @date1)
 AND (OrderHeaders.OrderDateTime <= @date2)
AND OrderHeaders.@BranchID


GROUP BY
       efr_Branchs.BranchName