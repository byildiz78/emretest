DELETE  FROM OrderTransactions WHERE MenuItemText='??' AND OrderDateTime>DATEADD(DAY,-30,GETDATE())  AND (ExtendedPrice = 0 OR LineDeleted = 1) ;
DECLARE @lcount INT;SET @lcount=(SELECT count(t.AutoID) FROM OrderTransactions AS t WHERE t.MenuItemText LIKE '??' AND t.OrderDateTime>DATEADD(DAY,-30,GETDATE()));
IF(@lcount>0)
BEGIN
	WITH kaynak AS (
	SELECT t.BranchID,t.MenuItemUnitPrice,MIN(m.MenuItemKey) AS MenuItemKey,MIN(m.MenuItemText) AS MenuItemText,
	MIN(m.MenuItemGroupText) AS grup, MIN(m.MenumItemCategoryText) AS kat
	  FROM OrderTransactions AS t WITH (NOLOCK)
	INNER JOIN OrderTransactions AS m ON t.MenuItemUnitPrice = m.MenuItemUnitPrice AND m.MenuItemText<>'??'
	AND t.BranchID = m.BranchID
	WHERE t.OrderDateTime>DATEADD(DAY,-5,GETDATE())
	AND t.MenuItemText='??' 
	GROUP BY t.BranchID,t.MenuItemUnitPrice)
	UPDATE OrderTransactions SET MenuItemText=k.MenuItemText,MenuItemKey=k.MenuItemKey,MenuItemGroupText=k.grup,MenumItemCategoryText=k.kat
	FROM OrderTransactions
	INNER JOIN kaynak AS k ON k.BranchID = OrderTransactions.BranchID AND k.MenuItemUnitPrice = OrderTransactions.MenuItemUnitPrice
	WHERE OrderTransactions.MenuItemText='??';
END;
SELECT ISNULL(efr_Branchs.BranchName, 'TANIMSIZ') AS [ŞUBE],r.ÜRÜN, r.GRUP,
 r.KATEGORİ, r.[BİRİM FİYAT], r.MİKTAR,r.[BİRİM FİYAT]*r.MİKTAR AS TUTAR
 FROM(
SELECT OrderTransactions.MenuItemText [ÜRÜN], OrderTransactions.MenuItemGroupText [GRUP], OrderTransactions.MenumItemCategoryText 
 [KATEGORİ], isnull(nullif(OrderTransactions.MenuItemUnitPrice,0),(OrderTransactions.ExtendedPrice/OrderTransactions.Quantity)) [BİRİM FİYAT], SUM(OrderTransactions.Quantity) [MİKTAR],OrderTransactions.BranchID
FROM OrderTransactions
INNER JOIN OrderHeaders AS h ON h.OrderKey = OrderTransactions.OrderKey AND h.BranchID = OrderTransactions.BranchID AND h.LineDeleted=0
WHERE OrderTransactions.LineDeleted = 0 AND OrderTransactions.OrderDateTime >= @date1 
AND OrderTransactions.OrderDateTime <= @date2 
AND OrderTransactions.Quantity>0
AND OrderTransactions.@BranchID
GROUP BY OrderTransactions.MenuItemText, OrderTransactions.MenuItemGroupText, OrderTransactions.MenumItemCategoryText, OrderTransactions.MenuItemUnitPrice,OrderTransactions.BranchID
,(OrderTransactions.ExtendedPrice/OrderTransactions.Quantity)
) AS r
LEFT OUTER JOIN efr_Branchs ON r.BranchID = efr_Branchs.BranchID
ORDER BY r.ÜRÜN