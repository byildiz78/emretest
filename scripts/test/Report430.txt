with sorgu as (SELECT h.BranchID,h.OrderDateTime,h.GuestNumber,h.AmountDue AS AmountDue,
DATEDIFF(minute,h.OrderDateTime,MAX(p.PaymentDateTime))  AS sure,SUM(t.Quantity) AS AnaYemek
FROM OrderHeaders AS h
INNER JOIN OrderPayments AS p ON p.BranchID = h.BranchID AND p.OrderKey = h.OrderKey
LEFT OUTER JOIN OrderTransactions AS t ON t.BranchID = h.BranchID AND t.OrderKey = h.OrderKey
AND t.LineDeleted=0
AND t.MenuItemGroupText LIKE '%büyük tabak%'
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
GROUP BY h.BranchID,h.OrderDateTime,h.GuestNumber,h.AmountDue,h.CustomField5)
SELECT b.BranchName AS [Şube],
round(sum(CASE WHEN s.sure>=0 AND s.sure<10 THEN s.AmountDue ELSE 0 END),2) AS [Ciro 0-10 dk],
sum(CASE WHEN s.sure>=0 AND s.sure<10 THEN s.GuestNumber ELSE 0 END) AS [Konuk 0-10 dk],
sum(CASE WHEN s.sure>=0 AND s.sure<10 THEN s.AnaYemek ELSE 0 END) AS [Büyük Tabak 0-10 dk],
round(sum(CASE WHEN s.sure>=10 AND s.sure<20 THEN s.AmountDue ELSE 0 END),2) AS [Ciro 10-20 dk],
sum(CASE WHEN s.sure>=10 AND s.sure<20 THEN s.GuestNumber ELSE 0 END) AS [Konuk 10-20 dk],
sum(CASE WHEN s.sure>=10 AND s.sure<20 THEN s.AnaYemek ELSE 0 END) AS [Büyük Tabak 10-20 dk],
round(sum(CASE WHEN s.sure>=20 AND s.sure<30 THEN s.AmountDue ELSE 0 END),2) AS [Ciro 20-30 dk],
sum(CASE WHEN s.sure>=20 AND s.sure<30 THEN s.GuestNumber ELSE 0 END) AS [Konuk 20-30 dk],
sum(CASE WHEN s.sure>=20 AND s.sure<30 THEN s.AnaYemek ELSE 0 END) AS [Büyük Tabak 20-30 dk],
round(sum(CASE WHEN s.sure>=30 AND s.sure<40 THEN s.AmountDue ELSE 0 END),2) AS [Ciro 30-40 dk],
sum(CASE WHEN s.sure>=30 AND s.sure<40 THEN s.GuestNumber ELSE 0 END) AS [Konuk 30-40 dk],
sum(CASE WHEN s.sure>=30 AND s.sure<40 THEN s.AnaYemek ELSE 0 END) AS [Büyük Tabak 30-40 dk],
round(sum(CASE WHEN s.sure>=40 AND s.sure<50 THEN s.AmountDue ELSE 0 END),2) AS [Ciro 40-50 dk],
sum(CASE WHEN s.sure>=40 AND s.sure<50 THEN s.GuestNumber ELSE 0 END) AS [Konuk 40-50 dk],
sum(CASE WHEN s.sure>=40 AND s.sure<50 THEN s.AnaYemek ELSE 0 END) AS [Büyük Tabak 40-50 dk],
round(sum(CASE WHEN s.sure>=50 AND s.sure<60 THEN s.AmountDue ELSE 0 END),2) AS [Ciro 50-60 dk],
sum(CASE WHEN s.sure>=50 AND s.sure<60 THEN s.GuestNumber ELSE 0 END) AS [Konuk 50-60 dk],
sum(CASE WHEN s.sure>=50 AND s.sure<60 THEN s.AnaYemek ELSE 0 END) AS [Büyük Tabak 50-60 dk],
round(sum(CASE WHEN s.sure>=60 THEN s.AmountDue ELSE 0 END),2) AS [Ciro 60+ dk],
sum(CASE WHEN s.sure>=60 THEN s.GuestNumber ELSE 0 END) AS [Konuk 60+ dk],
sum(CASE WHEN s.sure>=60 THEN s.AnaYemek ELSE 0 END) AS [Büyük Tabak 60+ dk]
FROM sorgu AS s
INNER JOIN efr_Branchs AS b ON b.BranchID = s.BranchID
GROUP BY s.BranchID,b.BranchName