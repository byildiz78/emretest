SELECT b.BranchName AS [Sube Adı],
CONVERT(VARCHAR, h.OrderDateTime ,103) as [Tarih],
CASE WHEN LEN(DATEPART(HOUR,h.OrderDateTime))=1 THEN '0'+CAST(DATEPART(HOUR,h.OrderDateTime) AS VARCHAR)+':00' ELSE CAST(DATEPART(HOUR,h.OrderDateTime) AS VARCHAR)+':00' END as Saat,
COUNT(1) AS [TOPLAM ADET],
ROUND(SUM(h.AmountDue), 2) AS [TOPLAM CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%sepet%' THEN 1 ELSE 0 END) [YEMEK SEPETİ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%sepet%' THEN h.AmountDue ELSE 0 END),2) [YEMEK SEPETİ CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%web%' and OrderSource=1 THEN 1 ELSE 0 END) [GARSON SİPARİŞ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%web%' and OrderSource=1 THEN h.AmountDue ELSE 0 END),2) [GARSON SİPARİŞ CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%trend%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderSource=3 THEN 1 ELSE 0 END) [WEB SİPARİŞ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%web%'  and OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%trend%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderSource=3 THEN h.AmountDue ELSE 0 END),2) [WEB SİPARİŞ CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%web%' and OrderSource=4 THEN 1 ELSE 0 END) [ÇM SİPARİŞ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%web%' and OrderSource=4 THEN h.AmountDue ELSE 0 END),2) [ÇM SİPARİŞ CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%getir%'  THEN 1 ELSE 0 END) [GETİR SİPARİŞ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%getir%' THEN h.AmountDue ELSE 0 END),2) [GETİR SİPARİŞ CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%trendyol%' THEN 1 ELSE 0 END) [TRENDYOL SİPARİŞ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%trendyol%' THEN h.AmountDue ELSE 0 END),2) [TRENDYOL SİPARİŞ CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%migros%' THEN 1 ELSE 0 END) [MİGROS SİPARİŞ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%migros%' THEN h.AmountDue ELSE 0 END),2) [MİGROS SİPARİŞ CİRO],

SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%QR%'  THEN 1 ELSE 0 END) [QR MENU SİPARİŞ ADET],
ROUND(SUM(CASE WHEN OrderTypeSourceExternalNo LIKE '%QR%' THEN h.AmountDue ELSE 0 END),2) [QR MENU SİPARİŞ CİRO],

SUM(CASE WHEN OrderType=1 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN 1 ELSE 0 END) [MASA ADET],
ROUND(SUM(CASE WHEN OrderType=1 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN h.AmountDue ELSE 0 END),2) [MASA CİRO],

SUM(CASE WHEN OrderType=2 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN 1 ELSE 0 END) [İSME ÇEK ADET],
ROUND(SUM(CASE WHEN OrderType=2 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN h.AmountDue ELSE 0 END),2) [İSME ÇEK CİRO],

SUM(CASE WHEN OrderType=3 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN 1 ELSE 0 END) [ALGÖTÜR ADET],

ROUND(SUM(CASE WHEN OrderType=3 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN h.AmountDue ELSE 0 END),2) [ALGÖTÜR CİRO],

SUM(CASE WHEN OrderType=4 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo=''))  THEN 1 ELSE 0 END) [TEZGAH ADET],
ROUND(SUM(CASE WHEN OrderType=4 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN h.AmountDue ELSE 0 END),2) [TEZGAH CİRO],

SUM(CASE WHEN OrderType=5 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN 1 ELSE 0 END) [PAKET ADET],
ROUND(SUM(CASE WHEN OrderType=5 and ((OrderTypeSourceExternalNo NOT LIKE '%sepet%' and OrderTypeSourceExternalNo NOT LIKE '%getir%' and OrderTypeSourceExternalNo NOT LIKE '%migros%' and OrderTypeSourceExternalNo NOT LIKE '%trendyol%' and OrderTypeSourceExternalNo NOT LIKE '%web%' and OrderTypeSourceExternalNo NOT LIKE '%QR%') or (OrderTypeSourceExternalNo IS NULL or OrderTypeSourceExternalNo='')) THEN h.AmountDue ELSE 0 END),2) [PAKET CİRO]

FROM OrderHeaders h
LEFT OUTER JOIN efr_Branchs b ON h.BranchID = b.BranchID
WHERE 
h.LineDeleted = 0
AND h.OrderDateTime BETWEEN @date1 and @date2
AND h.@BranchID
GROUP BY b.BranchName,CONVERT(VARCHAR, h.OrderDateTime ,103),CASE WHEN LEN(DATEPART(HOUR,h.OrderDateTime))=1 THEN '0'+CAST(DATEPART(HOUR,h.OrderDateTime) AS VARCHAR)+':00' ELSE CAST(DATEPART(HOUR,h.OrderDateTime) AS VARCHAR)+':00' END
order by b.BranchName,CONVERT(VARCHAR, h.OrderDateTime ,103)