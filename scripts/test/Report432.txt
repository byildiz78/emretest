SET NOCOUNT ON;
UPDATE OrderHeaders SET DiscountAmountValue=(round(DiscountOrderAmount/SubTotal*100,0))
WHERE OrderDateTime>DATEADD(DAY,-5,GETDATE())
AND LineDeleted=0 AND AmountDue<>SubTotal AND AmountDue>=0 AND DiscountOrderAmount>0 AND DiscountAmountValue=0;

SELECT b.BranchName AS [Şube], h.OrderID AS ÇekID,CONVERT(VARCHAR, DATEADD(hour,-4, h.OrderDateTime), 103) AS Gün,t.MenuItemText AS Ürün
,(cast(ROUND(cast((t.Quantity * t.MenuItemUnitPrice) as Decimal(18,5)), 2) as float))AS [Brüt],
ROUND(((cast(ROUND(cast((t.Quantity * t.MenuItemUnitPrice) as Decimal(18,5)), 2) as float))-round(t.ExtendedPrice,2)+0.001),2) AS [Ürün İndirimi],
round(round(t.ExtendedPrice,2)-(round(round(t.ExtendedPrice,2)-ISNULL((( 
 ROUND((h.SubTotal-h.AmountDue)-h.DiscountCashAmount,2)
)*round(t.ExtendedPrice,2)/nullif(h.SubTotal,0)),round(t.ExtendedPrice,2)),2)),2) AS [Çek İndirim],
round(round(t.ExtendedPrice,2)-(round(round(t.ExtendedPrice,2)-ISNULL((( 
h.DiscountCashAmount
)*round(t.ExtendedPrice,2)/nullif(h.SubTotal,0)),round(t.ExtendedPrice,2)),2)),2) AS [Nakit İndirim],
round(t.ExtendedPrice,2)-round(round(t.ExtendedPrice,2)-ISNULL((round(t.ExtendedPrice,2)*h.AmountDue/nullif(h.SubTotal,0)),round(t.ExtendedPrice,2)),2) AS [Net Tutar],
isnull(ISNULL(h.CustomerName,h.SpecificCustomerName),'') AS [Müşteri]
,isnull(isnull((isnull(d.DiscountText,d2.DiscountText)),CASE WHEN ISNULL(h.DiscountAmountValue,0)>0.1 THEN 'Müşteri %'+CAST(round(h.DiscountAmountValue,2) AS NVARCHAR(10)) ELSE 'YUVARLA-1' END) ,'') AS [İndirim Adı]
,isnull(isnull(h.CustomField2, t.CustomField2),'') AS Personel
--,ISNULL(t.EditUserName,isnull(t.CustomField2,t.AddUserName)) AS Personel
FROM OrderHeaders h WITH (NOLOCK)
INNER JOIN  OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.BranchID = h.BranchID AND t.LineDeleted=0
INNER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
LEFT OUTER JOIN Discounts AS d ON d.BranchID = b.BranchID AND d.DiscountKey = t.DiscountKey
LEFT OUTER JOIN Discounts AS d2 ON d2.BranchID = b.BranchID AND d2.DiscountKey = h.DiscountKey
WHERE h.LineDeleted = 0 
AND h.AmountDue>=0
AND h.OrderDateTime >=@date1
AND h.OrderDateTime <=@date2
and h.DiscountTotalAmount>0
AND (abs(ROUND((t.Quantity*t.MenuItemUnitPrice)-t.ExtendedPrice,2))>0.01 OR ABS((h.AmountDue-h.SubTotal))>0.01) 
AND h.@BranchID