DECLARE @ciro DECIMAL(18,2)
SELECT @ciro = SUM(AmountDue) from OrderHeaders as h  WITH (NOLOCK) where h.OrderDateTime>@date1 and h.OrderDateTime<@date2 and LineDeleted=0 and h.@BranchID

;with tabakSayisiResult as 
(
select 
    SUM(ISNULL(t.Quantity,0)) AS TabakSayisi,
	 b.BranchID
	from 
	OrderHeaders AS h WITH (NOLOCK)
	INNER JOIN efr_Branchs as b on h.BranchID = b.BranchID and b.paket_tipi is not null
	INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
	LEFT JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey 
where 
ISNULL(h.OrderType,0)=5 
AND (h.OrderDateTime>@date1 and h.OrderDateTime<@date2) 
AND h.LineDeleted=0 
AND h.@BranchID
AND p.CustomField12='TABAKLAR'
group by  b.BranchID

)

select	
    b.BranchName AS [Şube],
    b.Paket_Tipi AS [Paket Türü],
	b.CustomField12 AS [Bölge],
	SUM(isnull(h.AmountDue,0))  AS [Şeften İste Ciro] ,
	ROUND((SUM(isnull(h.AmountDue,0)) *100)/@ciro,2) as [Şeften İste Ciro %],
	t.TabakSayisi  As [Şeften İste Tabak],
	Count(isnull(h.OrderID,0)) as [Şeften İste Adisyon Sayısı],
	ROUND(SUM(isnull(h.AmountDue,0))/Count(isnull(h.OrderID,0)),2) as [Sepet Ortalama]
	from 
OrderHeaders AS h WITH (NOLOCK)
INNER JOIN efr_Branchs as b on h.BranchID = b.BranchID and b.paket_tipi is not null
LEFT JOIN tabakSayisiResult AS t on b.BranchID=t.BranchID
where 
ISNULL(h.OrderType,0)=5 
AND (h.OrderDateTime>@date1 and h.OrderDateTime<@date2) 
AND h.LineDeleted=0 
AND h.@BranchID
group by  b.BranchName,b.paket_tipi,b.CustomField12,t.TabakSayisi 

UNION ALL
	SELECT 
		b.BranchName,'','',
		0,
		0,
		0,
		0,
		0
		FROM efr_Branchs as b
	where b.BranchID NOT IN (select DISTINCT BranchID from OrderHeaders h where h.OrderDateTime>@date1 AND h.OrderDateTime<@date2 AND h.LineDeleted=0 and h.OrderType=5) 
	and b.IsActive=1 and b.paket_tipi is not null
