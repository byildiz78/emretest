SET NOCOUNT ON;
IF OBJECT_ID('tempdb..#tempDetail') IS NOT NULL DROP TABLE #tempDetail;
IF OBJECT_ID('tempdb..#tempHeader') IS NOT NULL DROP TABLE #tempHeader;
create table #tempDetail (OrderDateTime DATETIME,Brut float,UrunTutar FLOAT,BranchID INT);
create table #tempHeader (OrderDateTime DATETIME,DiscountCashAmount float,DiscountOrderAmount FLOAT,DiscountTotalAmount FLOAT,AmountDue FLOAT,OrderCount INT,GuestNumber INT,BranchID INT);
INSERT INTO #tempDetail (OrderDateTime,Brut,UrunTutar,BranchID)
SELECT DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, t.OrderDateTime))),round(SUM(((isnull(nullif(t.MenuItemUnitPrice,0),(t.ExtendedPrice/t.Quantity)))*t.Quantity)),2) AS Brut
,round(SUM(t.ExtendedPrice),2) AS UrunTutar,t.BranchID  FROM OrderTransactions AS t
WHERE t.OrderDateTime>@date1
AND t.OrderDateTime<@date2
AND t.@BranchID
AND t.Quantity>0
AND t.LineDeleted=0 GROUP BY DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, t.OrderDateTime))),t.BranchID;

 INSERT INTO #tempHeader(OrderDateTime, DiscountCashAmount, DiscountOrderAmount, DiscountTotalAmount, AmountDue, OrderCount, GuestNumber, BranchID)
SELECT 
DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, h.OrderDateTime))) as Gun,
sum(isnull(h.DiscountCashAmount,0)) AS DiscountCashAmount,
sum(isnull(h.DiscountOrderAmount,0)) AS DiscountOrderAmount,
sum(isnull(h.DiscountTotalAmount,0)) AS DiscountTotalAmount,
round(sum(h.AmountDue),2) AS AmountDue,
count(h.OrderID) AS OrderCount,
sum(h.GuestNumber) AS GuestNumber,h.BranchID
 FROM OrderHeaders h WITH (NOLOCK)
 WHERE h.LineDeleted = 0 AND h.OrderDateTime >= @date1
 AND h.OrderDateTime <= @date2
AND h.@BranchID
GROUP BY DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, h.OrderDateTime))),h.BranchID;

SELECT ISNULL(b.BranchName, '-') AS Şube
,CONVERT(VARCHAR, DATEADD(hour,-0,h.OrderDateTime), 103) AS Gün
,d.Brut AS [Brüt Satışlar]
,ROUND(d.Brut-d.UrunTutar, 2) AS [Ürün İndirimleri]
,ROUND((h.DiscountCashAmount), 2) AS  [Nakit İndirimler]
,ROUND((h.DiscountOrderAmount),2) AS [Çek İndirimler]
--,ROUND((d.Brut-h.AmountDue),2) AS [Toplam Indirimler]
,ROUND(d.brut-(ROUND((h.DiscountCashAmount), 2)+ROUND((h.DiscountOrderAmount),2)+ROUND(d.Brut-d.UrunTutar, 2)),2) as [Net Satışlar]
,ROUND((h.AmountDue) -(h.AmountDue) / 1.08, 2) AS [KDV]
,ROUND((h.AmountDue) / 1.08, 2) AS [KDV Hariç Net Satışlar]
--,(h.OrderCount) AS [Toplam Çek Sayısı]
--,(h.GuestNumber) AS [Toplam Konuk]
--,ROUND(((h.AmountDue) / NULLIF((h.GuestNumber), 0)), 3) AS [Kişi Başı Ortalama]
--,ROUND(((h.AmountDue) / NULLIF((h.OrderCount), 0)), 3) AS [Çek Ortalama]
FROM #tempHeader AS h
INNER JOIN #tempDetail AS d ON d.OrderDateTime = h.OrderDateTime AND d.BranchID = h.BranchID
INNER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
ORDER BY ISNULL(b.BranchName, '-'),h.OrderDateTime
IF OBJECT_ID('tempdb..#tempDetail') IS NOT NULL DROP TABLE #tempDetail;
IF OBJECT_ID('tempdb..#tempHeader') IS NOT NULL DROP TABLE #tempHeader;