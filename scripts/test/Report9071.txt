-- UPDATE OrderHeaders SET DiscountTotalAmount=ABS(DiscountOrderAmount)+ABS(DiscountCashAmount)+ABS(DiscountLineAmount),DiscountLineAmount=ABS(DiscountLineAmount) WHERE DiscountLineAmount<0 and @BranchID;
-- 
--DECLARE @totalSum FLOAT;SET @totalSum =(SELECT isnull((SELECT SUM(h.DiscountTotalAmount) FROM OrderHeaders AS h WITH(NOLOCK) WHERE h.@BranchID
--and h.lineDeleted=0
--AND h.OrderDateTime>@date1 AND h.OrderDateTime<@date2),0.0));
--
--SELECT r.BranchName AS [Şube Adı], isnull(r.DiscountText,'İndirim') AS [Indirim Adı], r.TotalDiscount AS [indirim Tutarı]
--,round(isnull((r.TotalDiscount/NULLIF(@totalSum,0)*100),0),2) AS Yuzde 
--FROM (
--SELECT sum(abs(t.DiscountTotalAmount)) AS TotalDiscount,t.DiscountKey,isnull(d.DiscountText,'Ürün İndirimi') as DiscountText,b.BranchName,'Satır İndirimi' AS indirimTipi
--  FROM OrderTransactions AS t WITH(NOLOCK)
--LEFT OUTER JOIN Discounts AS d ON d.DiscountKey = t.DiscountKey AND d.BranchID = t.BranchID 
--LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID
--WHERE t.OrderDateTime>@date1 AND t.OrderDateTime<@date2 AND t.@BranchID
--and t.lineDeleted=0
--GROUP BY t.DiscountKey,d.DiscountText,b.BranchName
--
--UNION ALL
--SELECT sum(h.DiscountCashAmount) AS TotalDiscount,newid(),'Nakit İndirim',b.BranchName,'Nakit İndirim' AS indirimTipi
--  FROM OrderHeaders AS h WITH(NOLOCK)
--LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
--WHERE h.OrderDateTime>@date1 AND h.OrderDateTime<@date2 AND h.@BranchID AND h.DiscountCashAmount>0
--and h.lineDeleted=0
--GROUP BY b.BranchName
--UNION ALL
--SELECT sum(h.DiscountOrderAmount) AS TotalDiscount,d.DiscountKey,--,d.DiscountText
--CASE WHEN ISNULL(h.DiscountAmountValue,0)>0 AND ISNULL(h.DiscountBasisValue,0)=0 THEN 'İNDİRİM %'+CAST(ISNULL(h.DiscountAmountValue,0) AS VARCHAR) ELSE '' END
--AS DiscountText
--,b.BranchName,'Çek İndirimi' AS indirimTipi
--  FROM OrderHeaders AS h WITH(NOLOCK)
--LEFT OUTER JOIN Discounts AS d ON d.DiscountKey = h.DiscountKey AND d.BranchID = h.BranchID 
--LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
--WHERE h.OrderDateTime>@date1 AND h.OrderDateTime<@date2 
--AND h.@BranchID AND h.DiscountOrderAmount>0
--and h.lineDeleted=0
--GROUP BY b.BranchName,d.DiscountKey,d.DiscountText,ISNULL(h.DiscountAmountValue,0),ISNULL(h.DiscountBasisValue,0)
--) AS r
--GROUP BY r.BranchName, r.indirimTipi, r.DiscountText, r.TotalDiscount
--ORDER BY r.TotalDiscount DESC

UPDATE OrderHeaders SET DiscountTotalAmount=ABS(DiscountOrderAmount)+ABS(DiscountCashAmount)+ABS(DiscountLineAmount),DiscountLineAmount=ABS(DiscountLineAmount) 
WHERE DiscountLineAmount<0 
and @BranchID;

DECLARE @totalSum FLOAT;SET @totalSum = (SELECT isnull((SELECT SUM(h.DiscountTotalAmount) FROM OrderHeaders AS h WITH(NOLOCK) 
WHERE h.lineDeleted=0 
AND h.@BranchID
AND h.OrderDateTime>@date1 
AND h.OrderDateTime<@date2 ),0.0));

SELECT
r.tarih as [Tarih],
r.BranchName AS [Şube Adı],
r.yer AS [Türü], 
isnull(r.DiscountText,'İndirim') AS [İndirim Adı], 
sum(r.TotalDiscount) AS [İndirim Tutarı],
sum(round(isnull((r.TotalDiscount/NULLIF(@totalSum,0)*100),0),2)) AS Yüzde 
FROM (
SELECT
Convert(varchar,t.orderdatetime,103) as tarih,
'Ürün İndirimi' as yer,
sum(abs(t.DiscountTotalAmount)) AS TotalDiscount,
'-' as DiscountText,b.BranchName
FROM OrderTransactions AS t WITH(NOLOCK)
LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID
WHERE t.lineDeleted=0

AND t.OrderDateTime>@date1 
AND t.OrderDateTime<@date2 
AND t.@BranchID
AND t.DiscountTotalAmount>0
GROUP BY b.BranchName,Convert(varchar,t.orderdatetime,103)

UNION ALL

SELECT 
Convert(Varchar,h.Orderdatetime,103) as Tarih,
'Çek Nakit İndirimi' as yer,
sum(h.DiscountCashAmount) AS TotalDiscount,
'-',
b.BranchName
FROM OrderHeaders AS h WITH(NOLOCK)
LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
WHERE h.lineDeleted=0

AND h.OrderDateTime>@date1 
AND h.OrderDateTime<@date2 
AND h.@BranchID 
AND h.DiscountCashAmount>0

GROUP BY b.BranchName,h.Orderdatetime

UNION ALL

SELECT
Convert(Varchar,h.Orderdatetime,103) as Tarih,
'Çek İndirimi' as yer,
sum(h.DiscountOrderAmount) AS TotalDiscount,
case when h.CustomerKey IS NOT NULL AND h.DiscountKey IS NULL THEN 'Müşteri İndirimi' ELSE d.DiscountText END AS DiscountText,
b.BranchName
FROM OrderHeaders AS h WITH(NOLOCK)
LEFT OUTER JOIN NewGlobalDiscounts AS d ON d.DiscountKey = h.DiscountKey AND d.BranchID = h.BranchID 
LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
WHERE h.lineDeleted=0
AND h.OrderDateTime>@date1 
AND h.OrderDateTime<@date2 
AND h.@BranchID 
AND h.DiscountOrderAmount>0

GROUP BY b.BranchName,d.DiscountText,h.CustomerKey ,h.DiscountKey,h.Orderdatetime 
) AS r
WHERE r.TotalDiscount>0
GROUP BY r.BranchName,r.yer,r.DiscountText,r.tarih
ORDER BY r.BranchName,r.yer,r.DiscountText DESC