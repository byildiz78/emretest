SELECT 
b.BranchName AS [Şube],
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END AS [Ürün Grubu],
ISNULL(m2.MenuItemText, m1.MenuItemText) AS [Ürün],round(sum(t.ExtendedPrice)/SUM(t.Quantity),2) AS [Birim Fiyatı],
round(sum(t.ExtendedPrice)/SUM(t.Quantity)*100/(100+ISNULL(m2.TaxPercent, m1.TaxPercent)),2) AS [Birim Fiyatı KDVsiz],
SUM(CASE WHEN h.OrderType=5 THEN t.Quantity ELSE 0.0 END) as [Paket Adet],SUM(CASE WHEN LOWER(h.OrderTypeSourceExternalNo) LIKE '%yemeksepeti%' THEN t.Quantity ELSE 0.0 END) as [Yemek Sepeti Adet],
sum(case when h.OrderTypeSourceExternalNo like 'Web%' then t.Quantity else 0.0 end) as [Web Sipariş Adet],
round(t.MenuItemCost*(100+ISNULL(m2.TaxPercent, m1.TaxPercent))/100,2) AS [Reçete Maliyeti]
,round(t.MenuItemCost,2) AS [Reçete Maliyeti KDVsiz]
,SUM(t.ExtendedPrice) AS [Satış Tutarı],round(SUM(t.ExtendedPrice)*100/(100+ISNULL(m2.TaxPercent, m1.TaxPercent)),2) AS [Satış Tutarı KDVsiz],
round(SUM(t.Quantity*t.MenuItemCost)*(100+ISNULL(m2.TaxPercent, m1.TaxPercent))/100,2) AS [Toplam Maliyet],
round(SUM(t.Quantity*t.MenuItemCost),2) AS [Toplam Maliyet KDVsiz],
round(isnull((SUM(t.Quantity*t.MenuItemCost*(100+ISNULL(m2.TaxPercent, m1.TaxPercent))/100)/nullif(SUM(t.ExtendedPrice),0)*100),0),2) AS [Yüzde]
FROM OrderTransactions AS t WITH (nolock)
LEFT JOIN GlobalMenuItems AS m1 ON m1.MenuItemKey = t.MenuItemKey and m1.BranchID = t.BranchID
LEFT JOIN NewGlobalMenuItems AS m2 ON m2.MenuItemKey = t.MenuItemKey
INNER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID
LEFT JOIN OrderHeaders h on h.OrderKey=t.OrderKey
WHERE 
t.@BranchID
and t.OrderDateTime BETWEEN @date1 and @date2
AND t.LineDeleted=0
AND h.OrderType=5
GROUP BY t.BranchID,ISNULL(m2.MenuItemText, m1.MenuItemText),t.MenuItemCost,t.MenuItemUnitPrice, ISNULL(m2.TaxPercent, m1.TaxPercent)
,b.BranchName,
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END
ORDER BY b.BranchName,[Ürün Grubu],ISNULL(m2.MenuItemText, m1.MenuItemText)