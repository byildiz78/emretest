SELECT

	k.[Tip],
	k.[Şube],
	k.[Bölge],
	k.[ToplamCiro] AS [Toplam Ciro],
	k.[YanUrunTutar] AS [Yan Ürün Tutar],
	ROUND( (k.[YanUrunTutar] / NULLIF(k.[ToplamCiro],0) * 100), 3) AS [Yan Ürün %],

	k.[IcecekTutar] AS [İçecek Tutar],
	ROUND( (k.[IcecekSayisi] / NULLIF(k.[TabakSayisi],0) * 100), 3) AS [İçecek/Tabak %],

	k.[CekSayisi] AS [Çek Sayısı],
	k.[TabakSayisi] AS [Tabak Sayısı],
	k.[IcecekSayisi] AS [İçecek Sayısı],

	ROUND( (k.[ToplamCiro] / NULLIF(k.[CekSayisi],0)), 2) AS [Ortalama Tutar (Ciro/Adisyon Sayısı)],
	ROUND( (k.[ToplamCiro] / NULLIF(k.[TabakSayisi],0)), 2) AS [Kişi Başı Harcama (Ciro/Tabak Sayısı)],

	k.[Gun] AS [Gün]

FROM
(
SELECT 
	(
	CASE 
		WHEN h.OrderType=1 THEN 'Masa Satış'
		WHEN h.OrderType=2 THEN 'İsme Çek'
		WHEN h.OrderType=3 THEN 'Kasa Satış'
		WHEN h.Ordertype=4 THEN 'Tezgah Satış'
		WHEN h.Ordertype=5 THEN 'Paket Servis'
		ELSE 'Satış'
	END
	) AS [Tip],
	br.BranchName AS [Şube],
	br.CustomField12 AS [Bölge],
	ROUND( SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ), 0)) ) ,5) AS [ToplamCiro], 
	ROUND( SUM(CASE WHEN p.CustomField12 = 'YAN ÜRÜNLER' THEN (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ), 0)) ELSE 0 END) ,5) AS [YanUrunTutar],
	ROUND( SUM(CASE WHEN p.CustomField12 = 'İÇECEKLER' THEN (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ), 0)) ELSE 0 END) ,5) AS [IcecekTutar],
	ROUND( SUM(CASE WHEN p.CustomField12 = 'TABAKLAR' THEN (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ), 0)) ELSE 0 END) ,5) AS [TabakTutar],
	COUNT(DISTINCT t.OrderKey) AS [CekSayisi],
	SUM(CASE WHEN p.CustomField12 = 'TABAKLAR' THEN t.Quantity ELSE 0 END) AS [TabakSayisi],
	SUM(CASE WHEN p.CustomField12 = 'İÇECEKLER' THEN t.Quantity ELSE 0 END) AS [IcecekSayisi],
	DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, t.OrderDateTime))) AS [Gun]
FROM
	OrderTransactions t WITH (NOLOCK)
INNER JOIN OrderHeaders h WITH (NOLOCK) ON h.OrderKey = t.OrderKey
INNER JOIN posProducts p WITH (NOLOCK) ON p.ProductKey = t.MenuItemKey
INNER JOIN efr_Branchs br WITH (NOLOCK) ON br.BranchID = t.BranchID
WHERE
	1=1
	AND t.OrderDateTime between @date1 and @date2
	AND t.@BranchID
  and h.OrderStatus=2
	AND t.LineDeleted = 0
	AND h.LineDeleted = 0
GROUP BY
	br.BranchName,
	br.CustomField12,
	DATEADD(D,0,DATEDIFF(dd, 0,DATEADD(hour,-6, t.OrderDateTime))),
	h.Ordertype
) AS k