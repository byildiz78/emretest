SELECT 
	b.BranchName AS [Şube],
	ROUND((isnull((SUM(r.PersonelMenu)/nullif(SUM(r.TabakSayisi),0)),0)*100),0) AS [Personel Menu Yüzde],
	SUM(r.PersonelMenu) as [Personel Menü Adet],
	SUM(r.TabakSayisi) as [Tabak Sayısı Adet],
	ROUND(SUM(Tutar),2) as Tutar
 FROM 
 (
	SELECT 
		h.BranchID,
		case when p.CustomField12='PERSONEL MENÜ'  then round((isnull((nullif(SUM(t.Quantity),0)),0)),0) else 0 end AS PersonelMenu,
		case when p.CustomField12='TABAKLAR'  then round((isnull((nullif(SUM(t.Quantity),0)),0)),0) else 0 end AS TabakSayisi,
		ROUND(SUM(t.ExtendedPrice * isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1) ), 2) as Tutar
	FROM 
		OrderHeaders AS h WITH (NOLOCK)
		INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
		LEFT JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
	WHERE 
		h.OrderDateTime between @date1 AND @date2
		AND h.LineDeleted=0		
		AND h.@BranchID
               and h.OrderType !=5
	GROUP BY 
		h.BranchID,h.OrderType,p.CustomField12
) AS r
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID
GROUP BY 
	b.BranchName
ORDER BY 
	ROUND((isnull((SUM(r.PersonelMenu)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) DESC