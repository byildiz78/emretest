UPDATE GlobalMenuItems
SET MenuItemCost = isnull(ISNULL(f.NetCost,f.FormulaCost),0)
FROM GlobalMenuItems
INNER JOIN posProducts AS p ON p.ProductKey=GlobalMenuItems.MenuItemGlobalKey
INNER JOIN posManafactureFormulaAssign AS a ON a.ProductID = p.ProductID AND a.BranchID = GlobalMenuItems.BranchID
INNER JOIN posManafactureFormula AS f ON f.FormulaID = a.FormulaID
WHERE 
GlobalMenuItems.BranchID=1;
SELECT isnull(r.PickValue,'DİĞER') AS Kategori,r.ProductName AS Menü, round(sum(r.tutar),2) AS Satis, round(sum(r.maliyet),2) AS Maliyet
,round(r.birimMaliyet,2) AS [Birim Maliyet]
,round(sum(r.tutar),2)-round(sum(r.maliyet),2) AS Kar
,round(isnull((round(sum(r.maliyet),2)/nullif(sum(r.tutar),0)*100),0),2) AS Yuzde FROM(
SELECT l.PickValue,p.ProductName, round(SUM(t.ExtendedPrice*100/(100+isnull(m.TaxPercent,0))),5) AS tutar, round(SUM(t.Quantity),5)*isnull(m.MenuItemCost,t.MenuItemUnitPrice/3) AS maliyet
,isnull(m.MenuItemCost,t.MenuItemUnitPrice/3) AS birimMaliyet
FROM OrderTransactions AS t WITH (NOLOCK) 
LEFT OUTER JOIN GlobalMenuItems AS m ON m.BranchID = t.BranchID AND m.MenuItemKey = t.MenuItemKey
LEFT OUTER JOIN posProducts AS p ON p.ProductKey=m.MenuItemGlobalKey
LEFT OUTER JOIN posPickList AS l ON l.ListID=p.GroupID
WHERE t.OrderDateTime>=@date1
AND t.OrderDateTime<=@date2
AND t.@BranchID
AND t.LineDeleted=0
GROUP BY l.PickValue,p.ProductName,m.MenuItemCost,m.MenuItemKey,t.MenuItemUnitPrice,m.TaxPercent)
AS r GROUP BY isnull(r.PickValue,'DİĞER'),r.ProductName,r.birimMaliyet
ORDER BY Satis DESC