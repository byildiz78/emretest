DECLARE @dt1 DATETIME,@dt2 DATETIME
SELECT @dt1=@date1,@dt2=@date2


SELECT 
	br.BranchName AS [Şube],
	DATENAME(MONTH, t.OrderDateTime) AS [Ay],
	--DATEADD(D,0,DATEDIFF(dd, 0,t.OrderDateTime)) AS Gün,
	CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, h.OrderDateTime )), 0 ), 23) AS [Gün],
	t.MenumItemCategoryText AS [Kategori],
	t.MenuItemGroupText AS [Grup],
	t.MenuItemText AS [Menü],
	CASE h.OrderType
            WHEN '1' THEN 'MASA SERVIS'
            WHEN '2' THEN 'İSME ÇEK'
            WHEN '3' THEN 'AL GÖTÜR'
            WHEN '4' THEN 'TEZGAH'
            WHEN '5' THEN 'PAKET SERVIS'
            ELSE 'TANIMSIZ'
       END AS 'Tip',
	t.MenuItemUnitPrice AS [Fiyat],
	SUM(t.Quantity) AS [Miktar],	
	ROUND( SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) ) ,5) AS [Net Tutar],
	ROUND( SUM(t.DiscountLineAmount + t.DiscountCashAmount) ,5) AS [Ürün İndirimi],
	round(SUM(t.ExtendedPrice),2) AS [Ürün Tutar],
	ROUND( SUM(h.DiscountCashAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) ) ,5) AS [Nakit İndirim],
	ROUND( SUM(h.DiscountOrderAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) ) ,5) AS [Çek İndirimi],
	ROUND( (
		SUM(t.DiscountLineAmount + t.DiscountCashAmount)
		+ SUM(h.DiscountCashAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) )
		+ SUM(h.DiscountOrderAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) )
	) ,5) AS [Toplam İndirim],
	---ROUND( SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) ) ,5) AS [Brüt Tutar]
	ROUND(SUM(t.MenuItemUnitPrice * t.Quantity) ,2)  AS [Net Tutar]

FROM
	OrderTransactions t WITH(NOLOCK)
	INNER JOIN OrderHeaders h ON h.OrderKey=t.OrderKey
	INNER JOIN efr_Branchs br ON br.BranchID = t.BranchID
WHERE
	1=1
AND t.@BranchID
	AND t.OrderDateTime BETWEEN @dt1 AND @dt2
	AND t.LineDeleted =0
	AND h.LineDeleted =0
GROUP BY
	br.BranchName,	
	--DATEADD(D,0,DATEDIFF(dd, 0,t.OrderDateTime)),
	CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, h.OrderDateTime )), 0 ), 23),
	t.MenumItemCategoryText,
	t.MenuItemGroupText,
	h.OrderType ,
	t.MenuItemText,
	t.MenuItemUnitPrice,
	DATENAME(MONTH, t.OrderDateTime)