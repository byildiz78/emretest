SELECT 
efr_branchs.BranchName AS Şube, 
FORMAT(t.TransactionDateTime,'dd/MM/yyyy hh:mm:ss') as Tarih,
d.DiscountText AS [İndirim Adı], 
t.MenuItemText AS Ürün, 
t.Quantity AS Adet, 
t.OrderID AS [Çek No], 
h.EmployeeName AS [PERSONEL],
d.DiscountAmount AS [İndirim Yüzdesi], 
t.MenuItemUnitPrice AS [Birim Fiyat], 
(t.Quantity * t.MenuItemUnitPrice) AS Tutar, 
round((ISNULL(((t.Quantity * t.MenuItemUnitPrice)*(h.AmountDue/NULLIF((h.AmountDue+h.DiscountTotalAmount),0))),(t.Quantity * t.MenuItemUnitPrice))),2) AS  [İndirimli Tutar], 
round((t.Quantity * t.MenuItemUnitPrice)-(ISNULL(((t.Quantity * t.MenuItemUnitPrice)*(h.AmountDue/NULLIF((h.AmountDue+h.DiscountTotalAmount),0))),(t.Quantity * t.MenuItemUnitPrice))),2) AS [İndirim Tutarı], 
'Çek İndirimi' AS Tipi, h.SpecificCustomerName AS Müşteri
FROM NewGlobalDiscounts d
RIGHT OUTER JOIN OrderHeaders as h ON d.DiscountKey = h.DiscountKey AND d.BranchID = h.BranchID
RIGHT OUTER JOIN OrderTransactions as t ON t.OrderKey = h.OrderKey
RIGHT OUTER JOIN efr_branchs ON h.BranchID = efr_branchs.BranchID
WHERE (h.DiscountOrderAmount > 0) AND h.OrderDateTime >= @date1 
AND h.OrderDateTime <= @date2 AND h.LineDeleted = 0 
AND t.LineDeleted = 0 
AND h.@BranchID
AND d.@BranchID

UNION ALL



SELECT 
efr_branchs.BranchName AS Şube, 
FORMAT(OrderTransactions.TransactionDateTime,'dd/MM/yyyy hh:mm:ss') as Tarih,
d.DiscountText AS [İndirim Adı], 
OrderTransactions.MenuItemText AS Ürün, 
OrderTransactions.Quantity AS Adet, 
OrderTransactions.OrderID AS [Çek No], 
OrderHeaders.EmployeeName AS [Personel],
d.DiscountAmount AS [İndirim Yüzdesi], 
OrderTransactions.MenuItemUnitPrice AS [Birim Fiyat], 
OrderTransactions.Quantity * OrderTransactions.MenuItemUnitPrice AS Tutar, 
(OrderTransactions.Quantity * OrderTransactions.MenuItemUnitPrice) * (1 - d.DiscountAmount / 100) AS [İndirimli Tutar], 
OrderTransactions.Quantity * OrderTransactions.MenuItemUnitPrice -(OrderTransactions.Quantity * OrderTransactions.MenuItemUnitPrice) * (1 - d.DiscountAmount / 100) AS [İndirim Tutarı], 
'Ürün İndirimi' AS Tipi, OrderHeaders.SpecificCustomerName AS Müşteri
FROM NewGlobalDiscounts d
RIGHT OUTER JOIN OrderTransactions  ON  d.DiscountKey = OrderTransactions.DiscountKey AND d.BranchID = OrderTransactions.BranchID
RIGHT OUTER JOIN OrderHeaders  ON  OrderTransactions.OrderKey = OrderHeaders.OrderKey
RIGHT OUTER JOIN efr_branchs  ON  OrderHeaders.BranchID = efr_branchs.BranchID
WHERE (OrderTransactions.DiscountLineAmount > 0) 
AND OrderHeaders.OrderDateTime >= @date1 
AND OrderHeaders.OrderDateTime <= @date2 
AND OrderHeaders.LineDeleted = 0 
AND OrderTransactions.LineDeleted = 0 
AND orderheaders.@BranchID 
AND d.@BranchID