DECLARE @subeSayisi INT;SET @subeSayisi=(
SELECT COUNT(DISTINCT h.BranchID) FROM OrderHeaders AS h WITH (NOLOCK)
WHERE h.OrderDateTime > @date1
AND h.OrderDateTime < @date2
AND h.LineDeleted=0
AND h.@BranchID
);
DECLARE @biletSayisi INT;
DECLARE @biletTutar FLOAT;
SELECT @biletSayisi=SUM(t.Quantity),@biletTutar=SUM(t.ExtendedPrice) FROM OrderTransactions AS t WITH(NOLOCK)
WHERE t.OrderDateTime>@date1
AND t.OrderDateTime<@date2
AND t.LineDeleted=0
AND t.@BranchID
AND t.MenuItemText='SİNEMA BİLETİ';

SELECT @biletSayisi as [BiletSayisi], @biletTutar as [BiletTutar], SUM(r.AktifSubeSayisi) AS AktifSubeSayisi,SUM(r.ToplamCiro) AS ToplamCiro
,SUM(r.YanUrunTutar) AS YanUrunTutar,round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.KonukSayisi),0),0),2) AS [OrtalamaCekTutari],
round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.TabakSayisi),0),0),2) AS [OrtalamaTabakTutari],
ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) AS YanUrunYuzde
,ROUND((isnull((SUM(r.IcecekSayisi)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) AS IcecekTabakYuzde
,SUM(r.IcecekTutar) AS IcecekTutar
,SUM(r.TabakSayisi) AS TabakSayisi,SUM(r.IcecekSayisi) AS IcecekSayisi
 FROM (
SELECT @subeSayisi AS AktifSubeSayisi,SUM(h.AmountDue) AS ToplamCiro, 0.0 AS YanUrunTutar, 0.0 AS IcecekTutar
,COUNT(h.AutoID) AS CekSayisi,0 AS TabakSayisi,0 AS IcecekSayisi,COUNT(isnull(nullif(h.GuestNumber,0),1)) AS KonukSayisi
 FROM OrderHeaders AS h WITH (NOLOCK)
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
UNION ALL
SELECT 0 AS AktifSubeSayisi,0.0 AS ToplamCiro, 
SUM(CASE WHEN ISNULL(m.CustomField4,'')='YAN ÜRÜN' THEN ( isnull(nullif(t.ExtendedPrice,0),t.Quantity*m.DefaultUnitPrice) /* ISNULL(((h.AmountDue/nullif(isnull(nullif(h.SubTotal,0),h.AmountDue),0))),1) */) ELSE 0 END) AS YanUrunTutar,
SUM(CASE WHEN isnull(t.MenumItemCategoryText,'') LIKE '%ÇECEKLER%' THEN t.ExtendedPrice ELSE 0 END) AS IcecekTutar
,0 AS CekSayisi,
SUM(CASE WHEN ISNULL(m.CustomField4,'')='TABAK' THEN t.Quantity ELSE 0 END) AS TabakSayisi,
SUM(CASE WHEN ISNULL(t.MenumItemCategoryText,'') LIKE '%ÇECEKLER%' THEN t.Quantity ELSE 0 END) AS IcecekSayisi,0 AS KonukSayisi
 FROM OrderHeaders AS h WITH (NOLOCK)
 INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN GlobalMenuItems AS m ON m.BranchID = t.BranchID AND  m.MenuItemKey=t.MenuItemKey
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
) AS r