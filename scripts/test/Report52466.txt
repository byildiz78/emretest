
SELECT 
	b.BranchName AS [Şube],
	pp.externalcode AS [Stok Kodu],
	t.MenuItemText AS [Ürün Adı],
	t.MenuItemGroupText AS [Grubu], 
	t.MenumItemCategoryText AS [Kategori],
	ROUND(SUM(t.Quantity), 3) AS Adet,
	SUM(t.ExtendedPrice) AS Tutar, 
	SUM(t.ExtendedPrice) * 100 / (100 + ISNULL(t.TaxPercent,8)) AS [KDV Hariç Tutar],
	t.MenuItemUnitPrice AS [Birim Fiyat]
FROM OrderTransactions  AS t WITH(NOLOCK)
INNER JOIN efr_Branchs AS b WITH(NOLOCK) ON b.BranchID = t.BranchID
INNER JOIN OrderHeaders h WITH(NOLOCK) ON h.OrderKey = t.OrderKey
LEFT JOIN posProducts as pp WITH(NOLOCK) on pp.ProductKey=MenuItemKey
WHERE 
	t.OrderDateTime BETWEEN @date1 AND @date2
	AND h.LineDeleted = 0 
	AND t.LineDeleted = 0 
	AND t.@BranchID
GROUP BY 
	b.BranchName,
	t.MenuItemKey, 
	t.MenuItemText, 
	t.MenuItemGroupText, 
	t.MenumItemCategoryText,
	t.TaxPercent,
	t.MenuItemUnitPrice,
	pp.externalcode
ORDER BY 
	t.MenuItemText
