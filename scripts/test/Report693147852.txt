select * from(
SELECT 
	br.BranchName AS [Şube],
	DATEPART(MONTH, t.OrderDateTime) AS [Ay],
	CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, h.OrderDateTime )), 0 ), 23) AS [Tarih],
	(
	CASE ISNULL(h.OrderType, 0)
		WHEN 1 THEN 'MASA SERVIS'
		WHEN 2 THEN 'İSME ÇEK'
		WHEN 3 THEN 'AL GÖTÜR'
		WHEN 4 THEN 'TEZGAH'
		WHEN 5 THEN 'PAKET SERVIS'
		ELSE 'TANIMSIZ'
	END
	) AS [Satış Türü],
	t.MenumItemCategoryText AS [Kategori],
	t.MenuItemGroupText AS [Grup],
	t.MenuItemText AS [Ürün],
	t.MenuItemUnitPrice AS [Birim Fiyat],
	SUM(t.Quantity) AS [Miktar],
	ROUND( (t.MenuItemUnitPrice * SUM(t.Quantity)) ,5) AS [Satır Toplamı],
	ROUND( SUM(t.DiscountLineAmount + t.DiscountCashAmount) ,5) AS [Ürün İndirimi],
	ROUND( SUM(h.DiscountCashAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) ) ,5) AS [Nakit İndirim],
	ROUND( SUM(h.DiscountOrderAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) ) ,5) AS [Çek İndirimi],
	ROUND( (
		SUM(t.DiscountLineAmount + t.DiscountCashAmount)
		+ SUM(h.DiscountCashAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) )
		+ SUM(h.DiscountOrderAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) )
	) ,5) AS [Toplam İndirim],
	ROUND( SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) ) ,5) AS [Toplam (KDV Dahil)],
	ROUND( SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) / ( 1+t.TaxPercent / 100.0 ) ) ,5) AS [Toplam (KDV Hariç)],
	ROUND( SUM((t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0))) - SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) / ( 1+t.TaxPercent / 100.0 ) ) ,5) AS [Kdv Tutarı],
	t.TaxPercent AS [Kdv Oranı],
	
	STUFF((SELECT ' + ' + t2.MenuItemText 
	FROM OrderTransactions t2 WITH (NOLOCK)
	WHERE t2.LineDeleted = 0 AND t2.OrderKey = t.OrderKey AND t2.MainMenuItemTransactionKey = t.TransactionKey
	group by t2.MenuItemKey,t2.MenuItemText
	having
	( t2.MenuItemKey='3bed3fb1-840e-4407-9090-d61ddb22a007'
		or
		t2.MenuItemKey='31ee4679-7ee3-40d9-a45b-2d9520011842'
		or
		t2.MenuItemKey='7cc39c99-1790-49f1-937a-d211e4a0daca'
		or
		t2.MenuItemKey='27b018f1-ecad-4583-9adc-33a4ce7c4bf6'
		or
		t2.MenuItemKey='80235FC8-7A79-44B4-9343-5938BC25B765'
		or
		t2.MenuItemKey='4E5FDB0A-2D40-49C1-930E-871025FB8932'
		or
		t2.MenuItemKey='ACF1AC84-909D-4371-97B4-BE8BE1FE2ABC'
		or
		t2.MenuItemKey='4414DDCC-9941-48EF-8E7B-3DDBCEB0B6DA'
		)
	FOR XML PATH('')), 1, 3, '') [ALT ÜRÜNLER]
	
FROM
	OrderTransactions t WITH (NOLOCK)
	INNER JOIN OrderHeaders h WITH (NOLOCK) ON h.OrderKey=t.OrderKey
	INNER JOIN posProducts p WITH ( NOLOCK ) ON p.ProductKey = t.MenuItemKey AND p.IsKto = 1
	INNER JOIN efr_Branchs br WITH (NOLOCK) ON br.BranchID = t.BranchID
WHERE
	1=1
	AND t.@BranchID
	AND t.OrderDateTime BETWEEN @date1 and @date2
	AND t.LineDeleted =0
	AND h.LineDeleted =0
	AND t.IsMainCombo = 1
	and h.OrderType=5
GROUP BY
	br.BranchName,
	DATEPART(MONTH, t.OrderDateTime),
	CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, h.OrderDateTime )), 0 ), 23),
	t.MenumItemCategoryText,
	t.MenuItemGroupText,
	t.MenuItemText,
	t.MenuItemUnitPrice,
	t.TaxPercent,
	ISNULL(h.OrderType, 0),
	t.OrderKey,
	t.TransactionKey
	) as r

	where r.[ALT ÜRÜNLER] is not null