SELECT efr_Branchs.Branchname as Şube,
p.CustomField5 as [Yan Ürün],
t.MenuItemText[ÜRÜN],
 t.MenumItemCategoryText [KATEGORİ],
  t.MenuItemGroupText [GRUP],
 SUM(t.Quantity) [MİKTAR],
 isnull(nullif(t.MenuItemUnitPrice,0),(t.ExtendedPrice/t.Quantity)) AS [Birim Fiyat],
ROUND(SUM(t.ExtendedPrice * ISNULL( h.AmountDue / NULLIF( h.SubTotal ,0)  ,0))  ,4) AS Tutar
FROM OrderTransactions AS t
INNER JOIN posproducts as p on p.ProductKey = t.MenuItemKey
INNER JOIN OrderHeaders AS h ON h.OrderKey = t.OrderKey AND h.BranchID = t.BranchID AND h.LineDeleted=0
 LEFT OUTER JOIN efr_Branchs ON t.BranchID = efr_Branchs.BranchID
WHERE t.LineDeleted = 0 
 AND h.OrderDateTime >= @date1
 AND h.OrderDateTime<= @date2
AND t.Quantity>0
 AND h.@BranchID
GROUP BY
 t.MenuItemText,
 t.MenumItemCategoryText,t.MenuItemGroupText,
 t.MenuItemUnitPrice,isnull(nullif(t.MenuItemUnitPrice,0),(t.ExtendedPrice/t.Quantity)),
efr_Branchs.Branchname,p.CustomField5
ORDER BY
 t.MenumItemCategoryText, 
 t.MenuItemText,
 t.MenuItemUnitPrice DESC