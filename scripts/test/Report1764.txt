DECLARE @subeSayisi INT;SET @subeSayisi=(SELECT COUNT(b.BranchID) FROM efr_Branchs AS b WITH (NOLOCK)
 WHERE b.@BranchID
 AND b.VerisonInfo IS NOT NULL
 AND ISNULL(b.IsActive,1)=1);
SELECT b.Customfield12 AS [Bölge],round(SUM(r.ToplamCiro),2) AS [Satış]
,round(SUM(r.YanUrunTutar),2) AS [Yan Ürün Tutar],round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.KonukSayisi),0),0),2) AS [Ortalama Çek Tutarı],
round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.TabakSayisi),0),0),2) AS [Ortalama Tabak Tutarı],
ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) AS [Yan Ürün Yüzde]
,ROUND((isnull((SUM(r.IcecekSayisi)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) AS [İçecek Tabak Yüzde]
,SUM(r.IcecekTutar) AS [İçecek Tutar]
,SUM(r.TabakSayisi) AS TabakSayisi,SUM(r.IcecekSayisi) AS [İçecek Sayısı]
 FROM (
SELECT h.BranchID,SUM(h.AmountDue) AS ToplamCiro, 0.0 AS YanUrunTutar, 0.0 AS IcecekTutar
,COUNT(h.AutoID) AS CekSayisi,0 AS TabakSayisi,0 AS IcecekSayisi,COUNT(isnull(nullif(h.GuestNumber,0),1)) AS KonukSayisi
 FROM OrderHeaders AS h WITH (NOLOCK)
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
GROUP BY h.BranchID
UNION ALL
SELECT h.BranchID,0.0 AS ToplamCiro, 
SUM(CASE WHEN ISNULL(m.CustomField4,'')='YAN ÜRÜN' THEN (isnull(nullif(t.ExtendedPrice,0),t.Quantity*m.DefaultUnitPrice) *ISNULL(((h.AmountDue/nullif(isnull(nullif(h.SubTotal,0),h.AmountDue),0))),1)) ELSE 0 END) AS YanUrunTutar,
SUM(CASE WHEN isnull(t.MenumItemCategoryText,'') LIKE '%ÇECEKLER%' THEN t.ExtendedPrice ELSE 0 END) AS IcecekTutar
,0 AS CekSayisi,
SUM(CASE WHEN ISNULL(m.CustomField4,'')='TABAK' THEN t.Quantity ELSE 0 END) AS TabakSayisi,
SUM(CASE WHEN ISNULL(t.MenumItemCategoryText,'') LIKE '%ÇECEKLER%' THEN t.Quantity ELSE 0 END) AS IcecekSayisi,0 AS KonukSayisi
 FROM OrderHeaders AS h WITH (NOLOCK)
 INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN GlobalMenuItems AS m ON m.BranchID=t.BranchID AND m.MenuItemKey=t.MenuItemKey
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
GROUP BY h.BranchID
) AS r
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID
GROUP BY b.CustomField12
ORDER BY ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) DESC;