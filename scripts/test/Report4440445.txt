SELECT p.ProductName AS [Stok Adı],iSNULL(sum(d.IncomingMain),0) AS [Mal Kabul Miktarı],
(r.[USED]) AS [Reçeteden Tüketim],iSNULL(sum(d.IncomingMain),0)-(r.[USED]) AS [Fark Miktarı]
,u.UnitName AS [Birim]
FROM(
SELECT r.BranchID, r.ProductID,SUM(round(r.[Used],2)) AS USED FROM (
SELECT t.BranchID,fd.ProductID,(fd.Amount*t.Quantity) AS Used
FROM ( SELECT t.MenuItemKey,t.MenuItemText,SUM(t.Quantity) AS Quantity,t.BranchID
FROM OrderTransactions AS t WITH (NOLOCK)
WHERE t.OrderDateTime>=@date1 AND t.OrderDateTime<=@date2 
AND t.BranchID=16
AND t.LineDeleted=0
GROUP BY t.MenuItemKey,t.MenuItemText,t.BranchID
) AS t
INNER JOIN GlobalMenuItems AS gm ON gm.MenuItemKey=t.MenuItemKey AND t.BranchID=gm.BranchID
INNER JOIN posProducts AS p ON p.ProductKey=gm.MenuItemGlobalKey 
INNER JOIN posManafactureFormulaAssign  AS fa ON fa.BranchID=t.BranchID AND fa.ProductID=p.ProductID
INNER JOIN posManafactureFormulaDetail AS fd ON fd.FormulaID = fa.FormulaID 
) AS r GROUP BY r.BranchID,r.ProductID) AS r
INNER JOIN posBranchs AS pb ON pb.BranchCode=r.BranchID
INNER JOIN posProducts AS p ON p.ProductID=r.ProductID-- AND p.CustomField6 LIKE 'zor%'
INNER JOIN posProductUnits AS u ON u.UnitID = p.UnitID
LEFT OUTER JOIN posOrderDetail AS d ON d.WarehouseID=pb.WarehouseID AND d.DocumentDateTime>=@date1 AND d.DocumentDateTime<=@date2 AND d.ProductID=r.ProductID AND d.DocumentTypeID=42
GROUP BY r.BranchID,r.ProductID,u.UnitName, p.ProductName,r.[USED] ORDER BY p.ProductName