-- NORMAL ŞEKİLDE SATILAN KTO LAR
SELECT 
	br.BranchName AS [Şube],
	DATEPART(MONTH, t.OrderDateTime) AS [Ay],
	CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, h.OrderDateTime )), 0 ), 23) AS [Tarih],
	(
	CASE ISNULL(h.OrderType, 0)
		WHEN 1 THEN 'MASA SERVIS'
		WHEN 2 THEN 'İSME ÇEK'
		WHEN 3 THEN 'AL GÖTÜR'
		WHEN 4 THEN 'TEZGAH'
		WHEN 5 THEN 'PAKET SERVIS'
		ELSE 'TANIMSIZ'
	END
	) AS [Satış Türü],
	t.MenumItemCategoryText AS [Kategori],
	t.MenuItemGroupText AS [Grup],
	t.MenuItemText AS [Ürün],
	t.MenuItemUnitPrice AS [Birim Fiyat],
	SUM(t.Quantity) AS [Miktar],
	ROUND( (t.MenuItemUnitPrice * SUM(t.Quantity)) ,5) AS [Satır Toplamı],
	ROUND( SUM(t.DiscountLineAmount + t.DiscountCashAmount) ,5) AS [Ürün İndirimi],
	ROUND( SUM(h.DiscountCashAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) ) ,5) AS [Nakit İndirim],
	ROUND( SUM(h.DiscountOrderAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) ) ,5) AS [Çek İndirimi],
	ROUND( (
		SUM(t.DiscountLineAmount + t.DiscountCashAmount)
		+ SUM(h.DiscountCashAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) )
		+ SUM(h.DiscountOrderAmount * ISNULL(((t.MenuItemUnitPrice * t.Quantity) / NULLIF(h.SubTotal,0)) ,0) )
	) ,5) AS [Toplam İndirim],
	ROUND( SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) ) ,5) AS [Toplam (KDV Dahil)],
	ROUND( SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) / ( 1+t.TaxPercent / 100.0 ) ) ,5) AS [Toplam (KDV Hariç)],
	ROUND( SUM((t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0))) - SUM( (t.ExtendedPrice * ISNULL((h.AmountDue / NULLIF(h.SubTotal,0) ),0)) / ( 1+t.TaxPercent / 100.0 ) ) ,5) AS [Kdv Tutarı],
	t.TaxPercent AS [Kdv Oranı],
	
	STUFF((SELECT ' + ' + t2.MenuItemText 
	FROM OrderTransactions t2 WITH (NOLOCK)
	WHERE t2.LineDeleted = 0 AND t2.OrderKey = t.OrderKey AND t2.MainMenuItemTransactionKey = t.TransactionKey
	FOR XML PATH('')), 1, 3, '') [ALT ÜRÜNLER]
	
FROM
	OrderTransactions t WITH (NOLOCK)
	INNER JOIN OrderHeaders h WITH (NOLOCK) ON h.OrderKey=t.OrderKey
	INNER JOIN posProducts p WITH ( NOLOCK ) ON p.ProductKey = t.MenuItemKey AND p.IsKto = 1
	INNER JOIN efr_Branchs br WITH (NOLOCK) ON br.BranchID = t.BranchID
WHERE
	1=1
	AND t.@BranchID
	AND t.OrderDateTime BETWEEN @date1 and @date2
	AND t.LineDeleted =0
	AND h.LineDeleted =0
	AND t.IsMainCombo = 1
GROUP BY
	br.BranchName,
	DATEPART(MONTH, t.OrderDateTime),
	CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, h.OrderDateTime )), 0 ), 23),
	t.MenumItemCategoryText,
	t.MenuItemGroupText,
	t.MenuItemText,
	t.MenuItemUnitPrice,
	t.TaxPercent,
	ISNULL(h.OrderType, 0),
	t.OrderKey,
	t.TransactionKey