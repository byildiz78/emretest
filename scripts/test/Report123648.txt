SELECT efr_Branchs.BranchName AS Şube,OrderTransactions.MenuItemText AS [Ürün Adı],OrderTransactions.MenuItemGroupText AS Grubu,OrderTransactions.MenumItemCategoryText AS Kategorisi,
ROUND(SUM(OrderTransactions.Quantity), 3) AS  Miktar,p.ExternalCode AS [Stok Kodu],
ROUND(SUM(OrderTransactions.ExtendedPrice * h.AmountDue / NULLIF(h.SubTotal, 0)), 2) AS Tutar,
ROUND(SUM(OrderTransactions.ExtendedPrice *(100/(100+OrderTransactions.TaxPercent)) * h.AmountDue / NULLIF(h.SubTotal, 0)), 2) AS [Tutar (KDV siz)],
ISNULL(OrderTransactions.MenuItemCost, 0) AS [Birim Maliyet (KDV siz)]
,ISNULL(OrderTransactions.MenuItemCost, 0)*1.08 AS [Birim Maliyet (KDV li)]
,SUM(OrderTransactions.quantity * ISNULL(OrderTransactions.MenuItemCost, 0)) AS [Toplam Maliyet (KDV siz)]
,SUM(OrderTransactions.quantity *1.08* ISNULL(OrderTransactions.MenuItemCost, 0)) AS [Toplam Maliyet (KDV li)],ISNULL(OrderTransactions.MenuItemCostDate,'1/1/2017 12:00') AS [Maliyet Tarihi]
FROM OrderTransactions WITH (NOLOCK)
LEFT OUTER JOIN efr_Branchs ON OrderTransactions.BranchID = efr_Branchs.BranchID
LEFT JOIN GlobalMenuItems AS m2 ON OrderTransactions.MenuItemKey = m2.MenuItemKey AND OrderTransactions.BranchID = m2.BranchID
LEFT JOIN NewGlobalMenuItems AS m1 ON OrderTransactions.MenuItemKey = m1.MenuItemKey 
LEFT OUTER JOIN posProducts AS p ON p.ProductKey = ISNULL(m1.MenuItemGlobalKey,m2.MenuItemGlobalKey)
LEFT OUTER JOIN orderheaders AS h ON OrderTransactions.OrderKey = h.OrderKey
LEFT OUTER JOIN posPickList ON p.MainCategoryID = posPickList.ListID
WHERE OrderTransactions.OrderDateTime >= @date1 AND OrderTransactions.OrderDateTime <= @date2 AND OrderTransactions.LineDeleted = 0 
AND OrderTransactions.@BranchID
AND OrderTransactions.MenuItemtext <> '??'
GROUP BY OrderTransactions.MenuItemText,OrderTransactions.MenuItemCostDate,OrderTransactions.MenuItemGroupText,OrderTransactions.MenumItemCategoryText,efr_Branchs.BranchName,p.ExternalCode,OrderTransactions.MenuItemCost,posPickList.PickValue

/*

UPDATE NewGlobalMenuItems SET MenuItemCost =p.PurchasePrice5
FROM NewGlobalMenuItems
INNER JOIN efr_Branchs AS b ON b.BranchID = NewGlobalMenuItems.BranchID
INNER JOIN posProducts AS p ON p.ProductKey=NewGlobalMenuItems.MenuItemGlobalKey
WHERE p.PurchasePrice5>0;
UPDATE OrderTransactions SET MenuItemCost = m.MenuItemCost
FROM OrderTransactions
INNER JOIN efr_Branchs AS b ON b.BranchID = OrderTransactions.BranchID
INNER JOIN NewGlobalMenuItems AS m ON m.MenuItemKey = OrderTransactions.MenuItemKey
WHERE OrderTransactions.OrderDateTime>DATEADD(DAY,-10,GETDATE())
AND ISNULL(OrderTransactions.MenuItemCost,0)=0
AND m.MenuItemCost>0;

SELECT efr_Branchs.BranchName AS Şube,OrderTransactions.MenuItemText AS [Ürün Adı],OrderTransactions.MenuItemGroupText AS Grubu,OrderTransactions.MenumItemCategoryText AS Kategorisi,
ROUND(SUM(OrderTransactions.Quantity), 3) AS  Miktar,p.ExternalCode AS [Stok Kodu],
ROUND(SUM(OrderTransactions.ExtendedPrice * h.AmountDue / NULLIF(h.SubTotal, 0)), 2) AS Tutar,
ROUND(SUM(OrderTransactions.ExtendedPrice *(100/(100+OrderTransactions.TaxPercent)) * h.AmountDue / NULLIF(h.SubTotal, 0)), 2) AS [Tutar (KDV siz)],
ISNULL(OrderTransactions.MenuItemCost, 0) AS [Birim Maliyet (KDV siz)]
,ISNULL(OrderTransactions.MenuItemCost, 0)*1.08 AS [Birim Maliyet (KDV li)]
,SUM(OrderTransactions.quantity * ISNULL(OrderTransactions.MenuItemCost, 0)) AS [Toplam Maliyet (KDV siz)]
,SUM(OrderTransactions.quantity *1.08* ISNULL(OrderTransactions.MenuItemCost, 0)) AS [Toplam Maliyet (KDV li)],ISNULL(OrderTransactions.MenuItemCostDate,'1/1/2017 12:00') AS [Maliyet Tarihi]
FROM OrderTransactions WITH (NOLOCK)
LEFT OUTER JOIN efr_Branchs ON OrderTransactions.BranchID = efr_Branchs.BranchID
INNER JOIN NewGlobalMenuItems AS m ON OrderTransactions.MenuItemKey = m.MenuItemKey 
LEFT OUTER JOIN posProducts AS p ON p.ProductKey = m.MenuItemGlobalKey
LEFT OUTER JOIN orderheaders AS h ON OrderTransactions.OrderKey = h.OrderKey
LEFT OUTER JOIN posPickList ON p.MainCategoryID = posPickList.ListID
WHERE OrderTransactions.OrderDateTime >= @date1 AND OrderTransactions.OrderDateTime <= @date2 AND OrderTransactions.LineDeleted = 0 
AND OrderTransactions.@BranchID
AND OrderTransactions.MenuItemtext <> '??'
GROUP BY OrderTransactions.MenuItemText,OrderTransactions.MenuItemCostDate,OrderTransactions.MenuItemGroupText,OrderTransactions.MenumItemCategoryText,efr_Branchs.BranchName,p.ExternalCode,OrderTransactions.MenuItemCost,posPickList.PickValue

*/