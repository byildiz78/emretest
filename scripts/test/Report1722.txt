SET NOCOUNT ON;
IF OBJECT_ID('tempdb..#tempSale') IS NOT NULL DROP TABLE #tempSale; 
CREATE TABLE #tempSale(BranchID int,OrderKey UNIQUEIDENTIFIER,MenuItemText NVARCHAR(100),UnitPrice FLOAT,Notes NVARCHAR(10),DefaultPrice FLOAT,Quantity FLOAT,ExtendedPrice FLOAT,MenuTotal FLOAT); 
INSERT INTO #tempSale(BranchID, OrderKey, MenuItemText, UnitPrice, Notes, DefaultPrice,Quantity,ExtendedPrice)
SELECT t.BranchID, t.OrderKey,t.MenuItemText,t.MenuItemUnitPrice,t.CustomField1,m.DefaultUnitPrice,t.Quantity,t.ExtendedPrice
FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0 AND t.CustomField1 LIKE 'xcm%'
INNER JOIN GlobalMenuItems AS m ON t.BranchID=m.BranchID AND m.MenuItemKey = t.MenuItemKey
--AND t.CustomField1 LIKE '%-'
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.@BranchID
AND h.LineDeleted=0;
UPDATE #tempSale SET MenuTotal =0;
UPDATE #tempSale SET MenuTotal = (
SELECT SUM(x.Quantity*x.DefaultPrice) FROM #tempSale AS x WHERE x.OrderKey=#tempSale.OrderKey
AND x.Notes LIKE SUBSTRING(#tempSale.Notes,1,4)+'%' AND x.Notes not LIKE '%-')
WHERE Notes not LIKE '%-';
SELECT b.BranchName AS [Şube],x.MenuItemText AS Kombo,s.MenuItemText AS Menü,ROUND((s.DefaultPrice*x.ExtendedPrice/s.MenuTotal),2) AS [Menü Fiyat]
,SUM(s.Quantity) AS Miktar
FROM #tempSale AS s
INNER JOIN #tempSale AS x ON x.OrderKey = s.OrderKey AND x.Notes LIKE SUBSTRING(s.Notes,1,4)+'%' AND x.Notes LIKE '%-'
INNER JOIN efr_Branchs AS b ON b.BranchID=s.BranchID
WHERE s.Notes not LIKE '%-'
GROUP BY b.BranchName,s.BranchID,s.MenuItemText,x.MenuItemText,ROUND((s.DefaultPrice*x.ExtendedPrice/s.MenuTotal),2)
ORDER BY b.BranchName,x.MenuItemText,s.MenuItemText
IF OBJECT_ID('tempdb..#tempSale') IS NOT NULL DROP TABLE #tempSale; 
