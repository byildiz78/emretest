
SELECT OrderTransactions.MenuItemText   AS [ÜRÜN ADI],
       OrderTransactions.MenuItemGroupText AS GRUBU,
       SUM(OrderTransactions.Quantity)  AS [SATILAN ADET],
       SUM(OrderTransactions.ExtendedPrice) AS [TOPLAM SATIS TUTARI],
       (GlobalMenuItems.MenuItemCost)   AS [BİRİM MALİYET],
       SUM(GlobalMenuItems.MenuItemCost * OrderTransactions.Quantity) AS 
       [TOPLAM MALİYET TUTAR], 
       
  ROUND(SUM(GlobalMenuItems.MenuItemCost * OrderTransactions.Quantity) /NULLIF(SUM(OrderTransactions.ExtendedPrice), 0) * 100,2) AS [COST %]
FROM   OrderHeaders WITH(NOLOCK)
       INNER JOIN OrderTransactions 
            ON  OrderHeaders.OrderKey = OrderTransactions.OrderKey
            AND OrderHeaders.BranchID = OrderTransactions.BranchID
       LEFT OUTER JOIN GlobalMenuItems
            ON  OrderTransactions.MenuItemKey = GlobalMenuItems.MenuItemKey
            AND GlobalMenuItems.BranchID = OrderHeaders.BranchID
WHERE  OrderHeaders.OrderDateTime >= @date1
       AND OrderHeaders.OrderDateTime <= @date2
       AND OrderHeaders.LineDeleted = 0
       AND OrderHeaders.LineDeleted = 0
       AND OrderHeaders.@BranchID
GROUP BY
       OrderTransactions.MenuItemText,
       OrderTransactions.MenuItemGroupText,
       GlobalMenuItems.MenuItemCost
ORDER BY
       OrderTransactions.MenuItemGroupText ASC,
       OrderTransactions.MenuItemText   ASC