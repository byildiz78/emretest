WITH r AS (
SELECT h.BranchID,DATEADD(dd, 0, DATEDIFF(dd, 0 ,h.OrderDateTime)) AS SaleDate,SUM(h.AmountDue) AS AmountDue,h.OrderType,sum(h.GuestNumber) AS GuestNumber,COUNT(h.AutoID) AS OrderCount,SUM(h.DiscountTotalAmount) AS DiscountTotal,0.0 AS VoidAmount
FROM OrderHeaders AS h WITH(NOLOCK) WHERE (h.OrderDateTime >= @date1) AND (h.OrderDateTime <= @date2) AND h.@BranchID AND h.OrderStatus<3 GROUP BY DATEADD(dd, 0, DATEDIFF(dd, 0 ,h.OrderDateTime)),h.OrderType,h.BranchID
UNION ALL 
SELECT h.BranchID,DATEADD(dd, 0, DATEDIFF(dd, 0 ,h.OrderDateTime)) AS SaleDate,0.0 AS AmountDue,h.OrderType,sum(h.GuestNumber) AS GuestNumber,COUNT(h.AutoID) AS OrderCount,SUM(h.DiscountTotalAmount) AS DiscountTotal,SUM(h.AmountDue) AS VoidAmount
FROM OrderHeaders AS h WITH(NOLOCK) WHERE (h.OrderDateTime >= @date1) AND (h.OrderDateTime <= @date2) AND h.@BranchID AND h.OrderStatus>2 GROUP BY DATEADD(dd, 0, DATEDIFF(dd, 0 ,h.OrderDateTime)),h.OrderType,h.BranchID
)
SELECT b.BranchName AS [ŞUBE],CONVERT(VARCHAR(20), r.SaleDate, 103) AS [TARİH], r.AmountDue AS [NET SATIŞ],r.OrderCount AS [ÇEK SAYISI],ROUND((r.AmountDue/r.OrderCount),2) AS [ÇEK ORTALAMA],
r.GuestNumber AS [KİŞİ SAYISI],(r.AmountDue/r.GuestNumber) AS [ORTALAMA KİŞİ], r.AmountDue AS [MASA SATIŞ],r.OrderCount AS [MASA SAYISI],0.0 AS [PAKET SATIŞ],0 AS [PAKET SAYISI],
r.voidAmount AS [İPTAL TUTARI],r.DiscountTotal AS [İNDİRİM TUTARI]
 FROM r INNER JOIN efr_Branchs AS b ON b.BranchID=r.BranchID WHERE r.OrderType=1
UNION ALL
SELECT b.BranchName AS [ŞUBE],CONVERT(VARCHAR(20), r.SaleDate, 103) AS [TARİH], r.AmountDue AS [NET SATIŞ],r.OrderCount AS [ÇEK SAYISI],ROUND((r.AmountDue/r.OrderCount),2) AS [ÇEK ORTALAMA],
0 AS [KİŞİ SAYISI],0  AS [ORTALAMA KİŞİ], 0.0 AS [MASA SATIŞ],0 AS [MASA SAYISI],r.AmountDue AS [PAKET SATIŞ],0 AS [PAKET SAYISI],
r.voidAmount AS [İPTAL TUTARI],r.DiscountTotal AS [İNDİRİM TUTARI]
FROM r INNER JOIN efr_Branchs AS b ON b.BranchID=r.BranchID WHERE r.OrderType<>1