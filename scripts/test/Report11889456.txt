declare @paketdisitabak int
set @paketdisitabak=(
SELECT 
round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) AS reportValue
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
LEFT JOIN posProducts as p WITH (NOLOCK) on p.ProductKey=t.MenuItemKey 
WHERE 
1=1
AND t.OrderDateTime between @date1 and @date2
AND t.@BranchID
AND t.linedeleted=0
AND h.linedeleted=0
and h.OrderType<>5
AND p.CustomField12='TABAKLAR'
);

SELECT 
	b.BranchName AS [Şube],
	ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) AS [Yan Ürün Yüzde],
	ROUND((isnull((SUM(r.Saglikliiceceksayisi)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) AS [Sağlıklı İçecek Tabak Yüzde],
	---ROUND((isnull((SUM(r.IcecekSayisi)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) AS [İçecek Tabak Yüzde],
	ROUND(SUM([ToplamIcecekSayisi])/@paketdisitabak*100,2) as [Toplam İçecek Ziyaretçi Sayısı %]
 FROM 
 (
	SELECT 
		h.BranchID,
		SUM(T.ExtendedPrice * isnull(nullif(H.AmountDue,0),0) / isnull(nullif(H.SubTotal,0),1)) AS ToplamCiro,
		SUM(CASE WHEN ISNULL(p.CustomField12,'')='YAN ÜRÜNLER' THEN (isnull(nullif(t.ExtendedPrice,0),t.Quantity*t.MenuItemUnitPrice) *ISNULL(((h.AmountDue/nullif(isnull(nullif(h.SubTotal,0),h.AmountDue),0))),1)) ELSE 0 END) AS YanUrunTutar,
		SUM(CASE WHEN ISNULL(p.CustomField12,'')='İÇECEKLER' THEN t.Quantity ELSE 0 END) AS IcecekSayisi,
		SUM(CASE WHEN ISNULL(p.CustomField12,'') LIKE '%İÇECEK%' THEN t.Quantity ELSE 0 END) AS ToplamIcecekSayisi,
		case when p.CustomField12='TABAKLAR'  then round((isnull((nullif(SUM(t.Quantity),0)),0)),0) else 0 end AS TabakSayisi,
		case when p.CustomField12='SAĞLIKLI İÇECEK'  then round((isnull((nullif(SUM(t.Quantity),0)),0)),0) else 0 end AS Saglikliiceceksayisi
	FROM 
		OrderTransactions  AS t WITH (NOLOCK)
		INNER JOIN OrderHeaders AS h ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
		LEFT JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
	WHERE 
		1=1
		AND t.OrderDateTime between @date1 AND @date2
		AND t.@BranchID
		AND t.LineDeleted=0
		and h.OrderType <> 5
		AND h.LineDeleted=0
	GROUP BY 
		h.BranchID,h.OrderType,p.CustomField12
) AS r
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID
GROUP BY 
	b.CustomField12,b.BranchName
ORDER BY 
	ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) DESC