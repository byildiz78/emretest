
SELECT 
	b.BranchName AS [Şube],
	pp.ExternalCode AS [Stok Kodu],
	t.MenuItemText AS [Ürün Adı],
	ppl2.Pickvalue AS [Grubu], 
	ppl.Pickvalue AS [Kategori],
	ROUND(SUM(t.Quantity),3) AS Adet,
	SUM(t.ExtendedPrice) AS Tutar, 
	SUM(t.ExtendedPrice) * 100 / NULLIF(100 + ISNULL(t.TaxPercent,8),0) AS [KDV Hariç Tutar],
	t.MenuItemUnitPrice AS [Birim Fiyat]
FROM OrderTransactions  AS t WITH(NOLOCK)
INNER JOIN efr_Branchs AS b WITH(NOLOCK) ON b.BranchID = t.BranchID
INNER JOIN posProducts AS pp WITH(NOLOCK) ON pp.ProductKey = t.ProductKey
INNER JOIN OrderHeaders h WITH(NOLOCK) ON h.OrderKey = t.OrderKey
INNER JOIN posPickList ppl WITH(NOLOCK) ON ppl.ListID = pp.CategoryID
INNER JOIN posPickList ppl2 WITH(NOLOCK) ON ppl2.ListID = pp.GroupID

WHERE 
	t.OrderDateTime BETWEEN @date1 AND @date2
	AND h.LineDeleted = 0 
	AND t.LineDeleted = 0 
	AND t.@BranchID
GROUP BY 
	b.BranchName,
	t.AccountingCode,
	t.MenuItemKey, 
	t.MenuItemText, 
	ppl.Pickvalue,
        ppl2.Pickvalue,
	t.TaxPercent,
	t.MenuItemUnitPrice,
        pp.ExternalCode
ORDER BY 
	t.MenuItemText