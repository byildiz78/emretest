select *
from (
SELECT 
b.BranchName AS [Şube],
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END AS [Ürün Grubu],
t.MenuItemText AS [Ürün],(SELECT DISTINCT ExtendedMenuName from NewGlobalMenuComboItems combo where combo.ComboMenuItemKey=menu.MenuItemPopUpChoiceText) as Kombo,
round(sum(t.ExtendedPrice)/SUM(t.Quantity),2) AS [Al Götür Satış Fiyatı KDVli],
round(sum(t.ExtendedPrice)/SUM(t.Quantity)*100/(100+t.TaxPercent),2) AS [Al Götür Satış Fiyatı KDVsiz],
SUM(t.Quantity) AS [Al Götür Satış Adedi],
SUM(t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0))) AS [Al Götür Satış Toplamı KDVli],
round(SUM(t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)))*100/(100+t.TaxPercent),2) AS [Al Götür Satış Toplamı KDVsiz],

round(pp.PurchasePrice5,4) as [Masa Satış Birim Maliyeti KDVsiz],
ROUND((pp.PurchasePrice5 * (100.0 + t.TaxPercent) / 100.0),4) as [Masa Satış Birim Maliyeti KDVli],


round(pp.PurchasePrice5,4) * Sum(t.quantity) AS [Al Götür Satış Toplam Maliyeti KDVsiz],
ROUND((pp.PurchasePrice5 * (100.0 + t.TaxPercent) / 100.0),4) * sum(t.quantity) AS [Al Götür Satış Toplam Maliyeti KDVli],


round(isnull((SUM(t.Quantity*pp.PurchasePrice5*(100+t.TaxPercent)/100)/nullif(SUM(t.ExtendedPrice),0)*100),0),2) AS [Al Götür Maliyet Yüzde KDVsiz]


FROM OrderTransactions AS t WITH (nolock)
LEFT JOIN OrderTransactions t1 on t1.TransactionKey=t.MainMenuItemTransactionKey
LEFT JOIN NewGlobalMenuItems menu on menu.MenuItemKey=t1.MenuItemKey
INNER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID
LEFT JOIN OrderHeaders h on h.OrderKey=t.OrderKey
LEFT JOIN posProducts pp on pp.ProductKey=t.ProductKey
WHERE t.@BranchID AND
t.OrderDateTime BETWEEN @date1 and @date2
--WHERE t.BranchID=226 AND
--t.OrderDateTime BETWEEN '2020-06-01' and '2020-06-30'
AND t.LineDeleted=0 AND h.OrderType=3
GROUP BY t.BranchID,t.MenuItemText,t.TaxPercent,menu.MenuItemPopUpChoiceText,ROUND((pp.PurchasePrice5 * (100.0 + t.TaxPercent) / 100.0),4),round(pp.PurchasePrice5,4)
,b.BranchName,
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END) AS TABLO
ORDER BY Şube,[Ürün Grubu],[Ürün]