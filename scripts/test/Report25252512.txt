SELECT b.BranchName, r.[Stok Kodu], r.[Harici Kodu], r.[Menü],r.[Fiyat],r.[Paket Fiyat],l.DisplayIndex AS [Ekran Sıra No]
FROM(
SELECT isnull(p.ProductCode,'') AS [Stok Kodu],isnull(p.ExternalCode,'') AS [Harici Kodu]
,m.MenuItemText AS Menü,m.defaultunitprice as [Fiyat],m.DeliveryPrice as [Paket Fiyat] ,COUNT(distinct l.BranchID) AS [Şube Sayısı],m.MenuItemGlobalKey
FROM GlobalMenuItemLayout AS l WITH(NOLOCK)
INNER JOIN efr_Branchs AS b ON b.BranchID = l.BranchID AND b.StartDateTime>'1/1/2018'
INNER JOIN GlobalMenuItems AS m ON m.BranchID = l.BranchID AND m.MenuItemKey = l.MenuItemKey
INNER JOIN GlobalMenuGroups AS mg ON mg.BranchID=b.BranchID AND mg.MenuGroupKey=l.MenuGroupKey AND ISNULL(mg.MenuGroupActive,1)=1
INNER JOIN posProducts AS p ON p.ProductKey=m.MenuItemGlobalKey
WHERE b.CountryName='Türkiye'
GROUP BY isnull(p.ProductCode,''),isnull(p.ExternalCode,''),m.MenuItemText,m.MenuItemGlobalKey,m.DefaultUnitPrice,m.DeliveryPrice
HAVING COUNT(distinct l.BranchID)<10
) AS r
INNER JOIN GlobalMenuItems AS m ON m.MenuItemGlobalKey = r.MenuItemGlobalKey
INNER JOIN GlobalMenuItemLayout AS l ON l.BranchID = m.BranchID AND l.MenuItemKey = m.MenuItemKey
INNER JOIN efr_Branchs AS b ON b.BranchID = l.BranchID
ORDER BY m.MenuItemText,b.BranchName