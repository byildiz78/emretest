select 
[Şube],
[Ürün Grubu],
[Ürün],
Kombo,
[Birim Satış Fiyatı KDVli],
[Birim Satış Fiyatı KDVsiz],
[Diğer Satış Adedi]+[Paket Satış Adedi] as [Satış Adedi],
[Diğer Satış Toplamı KDVli]+[Paket Satış Toplamı KDVli] as [Satış Toplamı KDVli],
[Diğer Satış Toplamı KDVsiz]+[Paket Satış Toplamı KDVsiz] as [Satış Toplamı KDVsiz],
[Diğer Satış Maliyeti KDVli]+[Paket Satış Maliyeti KDVli] as [Satış Maliyeti KDVli],
[Diğer Satış Maliyeti KDVsiz]+[Paket Satış Maliyeti KDVsiz] as [Satış Maliyeti KDVsiz],
([Diğer Maliyet Yüzde KDVsiz]*[Paket Maliyet Yüzde KDVsiz]/2) as [Maliyet Yüzde KDVsiz],
[Diğer Birim Satış Fiyatı KDVli],
[Diğer Birim Satış Fiyatı KDVsiz],
[Diğer Satış Adedi],
[Diğer Satış Toplamı KDVli],
[Diğer Satış Toplamı KDVsiz],
[Diğer Satış Maliyeti KDVli],
[Diğer Satış Maliyeti KDVsiz],
[Diğer Maliyet Yüzde KDVsiz],
[Paket Birim Satış Fiyatı KDVli],
[Paket Birim Satış Fiyatı KDVsiz],
[Paket Satış Adedi],
[Paket Satış Toplamı KDVli],
[Paket Satış Toplamı KDVsiz],
[Paket Satış Maliyeti KDVli],
[Paket Satış Maliyeti KDVsiz],
[Paket Maliyet Yüzde KDVsiz]
from (
SELECT 
b.BranchName AS [Şube],
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END AS [Ürün Grubu],
t.MenuItemText as [Ürün],(SELECT DISTINCT ExtendedMenuName from NewGlobalMenuComboItems combo where combo.ComboMenuItemKey=menu.MenuItemPopUpChoiceText) as Kombo,
round(sum(t.ExtendedPrice)/SUM(t.Quantity),2) AS [Birim Satış Fiyatı KDVli],
round(sum(t.ExtendedPrice)/SUM(t.Quantity)*100/(100+t.TaxPercent),2) AS [Birim Satış Fiyatı KDVsiz],
round(NULLIF(sum(CASE WHEN OrderType<>5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END),0),2) AS [Diğer Birim Satış Fiyatı KDVli],
round(NULLIF(sum(CASE WHEN OrderType<>5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END),0)*100/(100+t.TaxPercent),2) AS [Diğer Birim Satış Fiyatı KDVsiz],
SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END) AS [Diğer Satış Adedi],
SUM(CASE WHEN OrderType<>5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END) AS [Diğer Satış Toplamı KDVli],
round(SUM(CASE WHEN OrderType<>5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END)*100/(100+t.TaxPercent),2) AS [Diğer Satış Toplamı KDVsiz],
round((pp.PurchasePrice5 * SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END))*(100+t.TaxPercent)/100,4) AS [Diğer Satış Maliyeti KDVli],
round(pp.PurchasePrice5 * SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END),4) AS [Diğer Satış Maliyeti KDVsiz],
round(isnull((SUM((CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END*pp.PurchasePrice5)*(100+t.TaxPercent)/100)/nullif(SUM(t.ExtendedPrice),0)*100),0),2) AS [Diğer Maliyet Yüzde KDVsiz],

round(NULLIF(sum(CASE WHEN OrderType=5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END),0),2) AS [Paket Birim Satış Fiyatı KDVli],
round(NULLIF(sum(CASE WHEN OrderType=5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END),0)*100/(100+t.TaxPercent),2) AS [Paket Birim Satış Fiyatı KDVsiz],
SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END) AS [Paket Satış Adedi],
SUM(CASE WHEN OrderType=5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END) AS [Paket Satış Toplamı KDVli],
round(SUM(CASE WHEN OrderType=5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END)*100/(100+t.TaxPercent),2) AS [Paket Satış Toplamı KDVsiz],
round((pp.PurchasePrice6 * SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END))*(100+t.TaxPercent)/100,4) AS [Paket Satış Maliyeti KDVli],
round(pp.PurchasePrice6 * SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END),4) AS [Paket Satış Maliyeti KDVsiz],
round(isnull((SUM((CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END*pp.PurchasePrice6)*(100+t.TaxPercent)/100)/nullif(SUM(t.ExtendedPrice),0)*100),0),2) AS [Paket Maliyet Yüzde KDVsiz]
FROM OrderTransactions AS t WITH (nolock)
LEFT JOIN OrderTransactions t1 on t1.TransactionKey=t.MainMenuItemTransactionKey
LEFT JOIN NewGlobalMenuItems menu on menu.MenuItemKey=t1.MenuItemKey
INNER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID
LEFT JOIN posProducts pp on pp.ProductKey=t.ProductKey
LEFT JOIN OrderHeaders h on h.OrderKey=t.OrderKey
WHERE t.@BranchID AND
t.OrderDateTime BETWEEN @date1 and @date2
AND t.LineDeleted=0
GROUP BY t.BranchID,t.MenuItemtext,t.TaxPercent,menu.MenuItemPopUpChoiceText,pp.PurchasePrice6,pp.PurchasePrice5
,b.BranchName,
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END) AS TABLO
ORDER BY Şube,[Ürün Grubu],[Ürün]