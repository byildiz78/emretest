SELECT
	b.BranchName AS [Şube],
r.AddUserName AS [Ekleyen Personel],
        ROUND(r.YanUrunTutar/NULLIF(r.ToplamCiro,0)*100,3) AS [Yan Ürün Yüzde],
	ROUND(r.IcecekTutar/NULLIF(r.ToplamCiro,0)*100,3) AS [İçecek Yüzde],
	ROUND(r.SaglikliIcecekTutar/NULLIF(r.ToplamCiro,0)*100,3) AS [Sağlıklı İçecek Yüzde]
 FROM 
 (
	SELECT 
		h.BranchID,
		SUM(T.ExtendedPrice * isnull(nullif(H.AmountDue,0),0) / isnull(nullif(H.SubTotal,0),1)) AS ToplamCiro,
		SUM(CASE WHEN ISNULL(p.CustomField12,'')='YAN ÜRÜNLER' THEN T.ExtendedPrice * isnull(nullif(H.AmountDue,0),0) / isnull(nullif(H.SubTotal,0),1) ELSE 0 END) AS YanUrunTutar,
		SUM(CASE WHEN ISNULL(p.CustomField12,'')='İÇECEKLER' THEN T.ExtendedPrice * isnull(nullif(H.AmountDue,0),0) / isnull(nullif(H.SubTotal,0),1) ELSE 0 END) AS IcecekTutar,
		SUM(case when p.CustomField12='SAĞLIKLI İÇECEK'  then T.ExtendedPrice * isnull(nullif(H.AmountDue,0),0) / isnull(nullif(H.SubTotal,0),1) else 0 end) as SaglikliIcecekTutar,
		t.AddUserName
	FROM 
		OrderTransactions AS t WITH (NOLOCK)
		INNER JOIN OrderHeaders AS h ON t.OrderKey = h.OrderKey
		LEFT JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
	WHERE 
		t.OrderDateTime between @date1 AND @date2
		AND t.LineDeleted=0
		AND h.LineDeleted=0
		and h.OrderType <> 5
		AND t.@BranchID
		AND p.CustomField12 IN ('YAN ÜRÜNLER','İÇECEKLER','SAĞLIKLI İÇECEK')
	GROUP BY 
		h.BranchID,t.AddUserName
		) AS r
INNER JOIN efr_Branchs AS b ON b.BranchID = r.BranchID
GROUP BY 
	b.CustomField12,b.BranchName,r.AddUserName,r.ToplamCiro,r.YanUrunTutar,r.IcecekTutar,r.SaglikliIcecekTutar
ORDER BY 
	ROUND((isnull((SUM(r.YanUrunTutar)/nullif(SUM(r.ToplamCiro),0)),0)*100),3) DESC