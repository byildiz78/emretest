;with orders as 
 (select 
 h.OrderKey,
 h.orderID,
 h.BranchID,
 ABS(DATEDIFF(SECOND,MAX(h.DriverDepartureTime),h.OrderDateTime)) as KuryeyeAtanmaSuresi,
 ABS(DATEDIFF(SECOND,MAX(p.PaymentDateTime),h.DriverDepartureTime)) as TahsilatSuresi,
 ABS(DATEDIFF(SECOND,MAX(h.DriverArrivalTime),h.DriverDepartureTime)) as SubeyeGelmeSuresi
 FROM 
 OrderHeaders as h
 INNER JOIN OrderPayments p WITH (NOLOCK) ON p.OrderKey = h.OrderKey AND ISNULL(p.LineDeleted,0)=0 
 WHERE 
1=1
--AND h.DriverDepartureTime IS NOT NULL 
--AND h.DriverArrivalTime IS NOT NULL 
AND ISNULL(h.LineDeleted,0)=0 
AND ISNULL(h.OrderStatus,0)=2
AND (h.OrderDateTime>=@date1 AND h.OrderDateTime<=@date2)
AND h.OrderType IN (5)--Paket Satış
and h.@BranchID
group by 
h.OrderKey,
h.OrderID, 
h.BranchID,	
h.DriverDepartureTime, 
h.DriverArrivalTime,
h.OrderDateTime) 
  
SELECT 
 b.BranchID as [ŞUBE KODU]
,b.BranchName AS [ŞUBE ADI]
,COUNT(distinct h.orderID) AS [PAKET SAYISI]
,(SUM(ISNULL(h.KuryeyeAtanmaSuresi,0))/COUNT(h.orderID))/60 AS [ORTALAMA KURYE ATANMA SÜRESİ (dk)]
,(SUM(ISNULL(h.KuryeyeAtanmaSuresi,0)+ISNULL(h.TahsilatSuresi,0))/COUNT(h.orderID))/60 AS [ORTALAMA TAHSİLAT SÜRESİ (dk)]
,(SUM(ISNULL(h.KuryeyeAtanmaSuresi,0)+ISNULL(h.TahsilatSuresi,0)+ISNULL(h.SubeyeGelmeSuresi,0))/COUNT(h.orderID))/60 AS [ORTALAMA KURYE GELİŞ SÜRESİ (dk)],
(select round(sum(r.[Kişi Sayısı]),0) as repval from(
	SELECT 
	SUM(t.Quantity) AS [Kişi Sayısı]
	FROM
	OrderTransactions as t with(nolock)
	inner join posproducts p on p.ProductKey=t.MenuItemKey
	inner join OrderHeaders h on h.OrderKey=t.OrderKey and h.LineDeleted=0
WHERE
	t.OrderDateTime between @date1 and @date2
	AND t.BranchID=b.BranchID
	and h.OrderType=5
	and p.CustomField12='TABAKLAR'
	AND t.LineDeleted= 0 
	) as r) as [Kişi Sayısı],
(SELECT ROUND(  (SUM((t.ExtendedPrice * isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1)) / ((100.0 + t.TaxPercent) / 100.0))) , 2)  AS reportValue
FROM   OrderHeaders h WITH(NOLOCK)
inner join OrderTransactions t on t.OrderKey=h.OrderKey and t.LineDeleted=0
WHERE  h.OrderDateTime between @date1 and @date2
       AND h.BranchID=b.BranchID
	   and h.OrderType=5
       AND h.linedeleted=0) as Ciro
FROM 
efr_Branchs as b
INNER JOIN orders as h WITH (NOLOCK) ON b.BranchID=h.BranchID
GROUP BY
b.BranchID,
b.BranchName