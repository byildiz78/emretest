;WITH list AS (
	SELECT
		t.BranchID,
		CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, t.OrderDateTime )), 0 ), 23) AS [Date],
		SUM(t.Quantity) AS [Quantity]
	FROM
		OrderTransactions t WITH ( NOLOCK )
		INNER JOIN OrderHeaders h on h.OrderKey=t.OrderKey and h.LineDeleted=0
		INNER JOIN posProducts p WITH ( NOLOCK ) ON p.ProductKey = t.MenuItemKey AND p.CustomField12 = 'TABAKLAR'
	WHERE
		1=1
		AND t.LineDeleted = 0
		and h.OrderType=5
		AND t.OrderDateTime BETWEEN @date1 AND @date2
		AND t.@BranchID
	GROUP BY
		t.BranchID,
		CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, t.OrderDateTime )), 0 ), 23)
),
kto AS (

	SELECT
		k.BranchID,
		k.[Date],
		SUM(k.[NormalQuantity]) AS [NormalQuantity],
		SUM(k.[PersonalQuantity]) AS [PersonalQuantity]
	FROM
	(
	SELECT
		t.BranchID,
		CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, t.OrderDateTime )), 0 ), 23) AS [Date],
		t.Quantity AS [NormalQuantity],
		0 AS [PersonalQuantity]
	FROM
		OrderTransactions t WITH ( NOLOCK )
		INNER JOIN OrderHeaders h on h.OrderKey=t.OrderKey and h.LineDeleted=0
		INNER JOIN posProducts p WITH ( NOLOCK ) ON p.ProductKey = t.MenuItemKey AND p.IsKto = 1
		LEFT JOIN OrderTransactions t2 WITH ( NOLOCK ) ON t2.OrderKey = t.OrderKey AND t2.MainMenuItemTransactionKey = t.TransactionKey AND t2.LineDeleted = 0
	WHERE
		1=1
		AND t.LineDeleted = 0
		and h.OrderType=5
		AND t.OrderDateTime BETWEEN @date1 AND @date2
		AND t.@BranchID
		AND t.IsMainCombo = 1
	GROUP BY
		t.BranchID,
		CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, t.OrderDateTime )), 0 ), 23),
		t.OrderKey,
		t.TransactionKey,
		t.Quantity,
		t2.MenuItemKey
	HAVING
		( t2.MenuItemKey='3bed3fb1-840e-4407-9090-d61ddb22a007'
		or
		t2.MenuItemKey='31ee4679-7ee3-40d9-a45b-2d9520011842'
		or
		--t2.MenuItemKey='7cc39c99-1790-49f1-937a-d211e4a0daca'
		--or
		t2.MenuItemKey='27b018f1-ecad-4583-9adc-33a4ce7c4bf6'
		or
		t2.MenuItemKey='80235FC8-7A79-44B4-9343-5938BC25B765'
		or
		t2.MenuItemKey='4E5FDB0A-2D40-49C1-930E-871025FB8932'
		or
		t2.MenuItemKey='ACF1AC84-909D-4371-97B4-BE8BE1FE2ABC'
		or
		t2.MenuItemKey='4414DDCC-9941-48EF-8E7B-3DDBCEB0B6DA'
		)
	) as k
	GROUP BY
		k.BranchID,
		k.[Date]
),
result AS (

SELECT
	b.BranchName AS [Şube],
	l.[Date] AS [Tarih],
	isnull(l.[Quantity],0) AS [Toplam Tabak Sayısı],
	isnull((k.[NormalQuantity] + k.[PersonalQuantity]),0) AS [Toplam Kto Sayısı],
	isnull(k.[NormalQuantity],0) AS [Normal Kto Sayısı],
	isnull(k.[PersonalQuantity],0) AS [Personel Kto Sayısı],
	ROUND( isnull((( (k.[NormalQuantity] + k.[PersonalQuantity]) * 100) / l.[Quantity]),0) , 2) AS [Yüzde %]
FROM
	list l
LEFT JOIN kto k ON k.BranchID = l.BranchID AND k.[Date] = l.[Date]
inner join efr_Branchs b on b.BranchID= l.BranchID

)

SELECT
	* 
FROM
	result