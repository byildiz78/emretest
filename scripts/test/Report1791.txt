SET LANGUAGE english;
SET NOCOUNT ON;
IF OBJECT_ID('tempdb..#tempReport') IS NOT NULL DROP TABLE #tempReport; 
CREATE TABLE #tempReport (Yil int,Donem INT,Bolge NVARCHAR(50),Konuk INT,Ciro FLOAT,YanUrun FLOAT,Maliyet FLOAT); 
INSERT INTO #tempReport(Yil, Donem, Bolge, Konuk, Ciro, YanUrun, Maliyet)
SELECT datepart(year,h.OrderDateTime) AS Yil,datepart(MONTH,h.OrderDateTime) AS Ay,b.Region,SUM(h.GuestNumber) AS Konuk,
round(SUM(h.AmountDue),2) AS tutar,round(SUM(isnull(h.OrderCost,0)),2) AS Maliyet
,round(SUM(isnull(h.ByProduct,0)),2) AS YanUrun
 FROM efr_Branchs AS b WITH (NOLOCK)
INNER JOIN OrderHeaders AS h ON h.BranchID = b.BranchID
AND h.LineDeleted=0
AND h.OrderDateTime>'1/1/2016'
AND h.OrderDateTime<'9/1/2017'
AND h.@BranchID
WHERE b.CountryName='Türkiye'
AND ISNULL(b.Region,'')<>''
GROUP BY b.Region,datepart(MONTH,h.OrderDateTime),datepart(year,h.OrderDateTime);
SET LANGUAGE turkish;
SELECT DateName(month,DateAdd(month,c.Donem,0)-1) AS Dönem, c.Bolge AS Bölge,
ROUND(((c.Ciro-p.Ciro)/p.Ciro*100),2) AS [Aylık Ciro Artış %],
ROUND(((c.YanUrun-p.YanUrun)/p.YanUrun*100),2) AS [Yan Ürün Aylık %],
ROUND((c.Ciro/c.Konuk),2) AS [Kişi/Ciro Ortalama],
ROUND((((c.Ciro/c.Konuk)-(p.Ciro/p.Konuk))/(p.Ciro/p.Konuk)*100),2) AS [Kişi/Ciro Ortalama %],
ROUND(((c.Maliyet-p.Maliyet)/p.Maliyet*100),2) AS [Maliyet Aylık %]
FROM #tempReport AS c
INNER JOIN #tempReport AS p ON p.Yil=c.Yil-1 AND p.Donem = c.Donem AND p.Bolge = c.Bolge
WHERE c.Yil=2017
ORDER BY c.Donem
IF OBJECT_ID('tempdb..#tempReport') IS NOT NULL DROP TABLE #tempReport; 