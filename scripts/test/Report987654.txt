SELECT 
	b.BranchName AS [Şube],
	convert(varchar,tablo.tarih,104) as Tarih,
	SUM(tablo.IcecekSayisi) AS [İçecek Sayısı],
	SUM(tablo.YanUrunSayisi) AS [İçecek Sayısı],
	SUM(tablo.TabakSayisi) AS [Tabak Sayisi],
	sum(tablo.PaketTabakSayisi) As [Şeften İste Tabak],
	sum(tablo.TDPSSAdisyon) as [Şeften İste Adisyon Sayısı]
	

 FROM 
 (
	select 
	h.BranchID,
	convert(varchar,h.OrderDateTime,104) as tarih,
	0 AS IcecekSayisi,
	0 AS YanUrunSayisi,
	0.0 as PaketTabakSayisi,
	0.0 as TabakSayisi,
	count(1) as TDPSSAdisyon
	from OrderHeaders h
	where h.OrderDateTime>@date1 
	AND h.OrderDateTime<@date2
	and h.LineDeleted=0
	and h.OrderType = 5
	AND h.@BranchID
	group by h.BranchID,h.OrderDateTime

 union all
	
	SELECT 
		h.BranchID,
		convert(varchar,h.OrderDateTime,104) as tarih,
		SUM(CASE WHEN ISNULL(p.CustomField12,'')='İÇECEKLER' THEN t.Quantity ELSE 0 END) AS IcecekSayisi,
		SUM(CASE WHEN ISNULL(p.CustomField12,'')='YAN ÜRÜNLER' THEN t.Quantity ELSE 0 END) AS YanUrunSayisi,
		case when p.CustomField12='TABAKLAR' and h.OrderType=5 then round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) else 0 end AS PaketTabakSayisi,
		case when p.CustomField12='TABAKLAR'  then round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) else 0 end AS TabakSayisi,
		0.0 as TDPSSAdisyon
		
		
		
	FROM 
		OrderHeaders AS h WITH (NOLOCK)
		INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
		INNER JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
		INNER JOIN NewGlobalMenuItems m1 ON m1.MenuItemKey = t.MenuItemKey
	WHERE 
		h.OrderDateTime>@date1 AND h.OrderDateTime<@date2
		AND h.LineDeleted=0
		AND h.@BranchID
	GROUP BY 
		h.BranchID,h.OrderType,p.CustomField12,h.OrderDateTime
) AS tablo
INNER JOIN efr_Branchs AS b ON b.BranchID = tablo.BranchID
GROUP BY 
	b.CustomField12, b.BranchName,tablo.tarih
ORDER BY 
	b.BranchName