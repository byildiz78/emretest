UPDATE OrderHeaders SET DiscountTotalAmount=ABS(DiscountOrderAmount)+ABS(DiscountCashAmount)+ABS(DiscountLineAmount),DiscountLineAmount=ABS(DiscountLineAmount) 
WHERE DiscountLineAmount<0 
and @BranchID;

DECLARE @totalSum FLOAT;SET @totalSum = (SELECT isnull((SELECT SUM(h.DiscountTotalAmount) FROM OrderHeaders AS h WITH(NOLOCK) 
WHERE h.lineDeleted=0 
AND h.@BranchID
AND h.OrderDateTime>@date1 
AND h.OrderDateTime<@date2 ),0.0));

SELECT
r.tarih as [Tarih],
r.BranchName AS [Şube Adı],
r.yer AS [Türü], 
isnull(r.DiscountText,'-') AS [İndirim Adı], 
sum(r.TotalDiscount) AS [İndirim Tutarı],
sum(round(isnull((r.TotalDiscount/NULLIF(@totalSum,0)*100),0),2)) AS Yüzde 
FROM (
SELECT
Convert(varchar,t.orderdatetime,103) as tarih,
'Ürün İndirimi' as yer,
sum(abs(t.DiscountTotalAmount)) AS TotalDiscount,
'-' as DiscountText,b.BranchName
FROM OrderTransactions AS t WITH(NOLOCK)
LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID
WHERE t.lineDeleted=0

AND t.OrderDateTime>@date1 
AND t.OrderDateTime<@date2 
AND t.@BranchID
AND t.DiscountTotalAmount>0
GROUP BY b.BranchName,Convert(varchar,t.orderdatetime,103)

UNION ALL

SELECT 
Convert(Varchar,h.Orderdatetime,103) as Tarih,
'Çek Nakit İndirimi' as yer,
sum(h.DiscountCashAmount) AS TotalDiscount,
'-',
b.BranchName
FROM OrderHeaders AS h WITH(NOLOCK)
LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
WHERE h.lineDeleted=0

AND h.OrderDateTime>@date1 
AND h.OrderDateTime<@date2 
AND h.@BranchID 
AND h.DiscountCashAmount>0

GROUP BY b.BranchName,h.Orderdatetime

UNION ALL

SELECT
Convert(Varchar,h.Orderdatetime,103) as Tarih,
'Çek İndirimi' as yer,
sum(h.DiscountOrderAmount) AS TotalDiscount,
case when h.CustomerKey IS NOT NULL AND h.DiscountKey IS NULL THEN 'Müşteri İndirimi' ELSE d.DiscountText END AS DiscountText,
b.BranchName
FROM OrderHeaders AS h WITH(NOLOCK)
LEFT OUTER JOIN NewGlobalDiscounts AS d ON d.DiscountKey = h.DiscountKey AND d.BranchID = h.BranchID 
LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = h.BranchID
WHERE h.lineDeleted=0
AND h.OrderDateTime>@date1 
AND h.OrderDateTime<@date2 
AND h.@BranchID 
AND h.DiscountOrderAmount>0

GROUP BY b.BranchName,d.DiscountText,h.CustomerKey ,h.DiscountKey,h.Orderdatetime 
) AS r
WHERE r.TotalDiscount>0
GROUP BY r.BranchName,r.yer,r.DiscountText,r.tarih
ORDER BY r.BranchName,r.yer,r.DiscountText DESC