Detail |DECLARE @subeSayisi INT;SET @subeSayisi=(SELECT COUNT(b.BranchID) FROM efr_Branchs AS b WITH (NOLOCK)
 WHERE b.@BranchID
 AND ISNULL(b.IsActive,1)=1
);

DECLARE @ciro FLOAT;
SET @ciro=(SELECT SUM(h.AmountDue) AS reportValue
FROM OrderHeaders AS h WITH(NOLOCK)
WHERE h.OrderDateTime > @date1
AND h.OrderDateTime < @date2
and h.OrderType !=5
AND h.@BranchID
AND h.linedeleted=0
);

DECLARE @tabakSayisi FLOAT;
DECLARE @tabakOran FLOAT;
DECLARE @TabakAdet FLOAT;
SET @tabakSayisi=(SELECT round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) AS reportValue
FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField12='TABAKLAR'
WHERE h.OrderDateTime >@date1
AND h.OrderDateTime < @date2
AND h.@BranchID
AND h.linedeleted=0
and h.OrderType != 5
);

SELECT @tabakOran=round((isnull((SUM(t.Quantity)/nullif(@tabakSayisi,0))*100,0.0)),0) ,@TabakAdet= SUM(t.Quantity)
 FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.BranchID = h.BranchID AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField12='SAĞLIKLI İÇECEK'
WHERE h.LineDeleted=0
and h.OrderType != 5
AND h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.@BranchID


SELECT 
@tabakOran as [TabakOran],
@TabakAdet as [TabakAdet], 
SUM(r.AktifSubeSayisi) AS AktifSubeSayisi,
SUM(r.ToplamCiro) AS ToplamCiro
,SUM(r.YanUrunTutar) AS YanUrunTutar,
round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.KonukSayisi),0),0),2) AS [OrtalamaCekTutari],
round(isnull(SUM(r.ToplamCiro)/nullif(SUM(r.TabakSayisi),0),0),2) AS [OrtalamaTabakTutari],
ROUND((isnull((SUM(r.YanUrunTutar)/nullif(@ciro,0)),0)*100),3) AS YanUrunYuzde
,ROUND((isnull((SUM(r.IcecekSayisi)/nullif(SUM(r.TabakSayisi),0)),0)*100),3) AS IcecekTabakYuzde
,SUM(r.IcecekTutar) AS IcecekTutar
,SUM(r.TabakSayisi) AS TabakSayisi,SUM(r.IcecekSayisi) AS IcecekSayisi
 FROM (
SELECT @subeSayisi AS AktifSubeSayisi,SUM(h.AmountDue) AS ToplamCiro, 0.0 AS YanUrunTutar, 0.0 AS IcecekTutar
,COUNT(h.AutoID) AS CekSayisi,0 AS TabakSayisi,0 AS IcecekSayisi,COUNT(isnull(nullif(h.GuestNumber,0),1)) AS KonukSayisi
 FROM OrderHeaders AS h WITH (NOLOCK)
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
and h.OrderType !=5
AND h.@BranchID
UNION ALL
SELECT 0 AS AktifSubeSayisi,0.0 AS ToplamCiro, 
SUM(CASE WHEN ISNULL(p.CustomField12,'')='YAN ÜRÜNLER'  THEN (t.ExtendedPrice *isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1)) ELSE 0 END) AS YanUrunTutar,
SUM(CASE WHEN isnull(p.CustomField12,'')='İÇECEKLER' THEN (t.ExtendedPrice *isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1)) ELSE 0 END) AS IcecekTutar
,0 AS CekSayisi,
SUM(CASE WHEN ISNULL(p.CustomField12,'')='TABAKLAR' THEN t.Quantity ELSE 0 END) AS TabakSayisi,
SUM(CASE WHEN ISNULL(p.CustomField12,'')='İÇECEKLER' THEN t.Quantity ELSE 0 END) AS IcecekSayisi,0 AS KonukSayisi
 FROM OrderHeaders AS h WITH (NOLOCK)
 INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN NewGlobalMenuItems AS m ON m.MenuItemKey=t.MenuItemKey
INNER JOIN posProducts AS p ON p.ProductKey=t.MenuItemKey
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
and h.OrderType !=5
AND h.@BranchID
) AS r