SELECT DISTINCT p.ProductName AS [Adı],isnull(p.ExternalCode,'') AS [Logo Kodu]
,COUNT(m.BranchID) AS [Şube Sayısı]
FROM posProducts AS p
INNER JOIN GlobalMenuItems AS m ON m.MenuItemGlobalKey=p.ProductKey
INNER JOIN GlobalMenuItemLayout AS l ON l.BranchID=m.BranchID AND l.MenuItemKey=m.MenuItemKey
INNER JOIN GlobalMenuGroups AS mg ON mg.BranchID=l.BranchID AND mg.MenuGroupKey=l.MenuGroupKey AND ISNULL(mg.MenuGroupActive,1)=1
INNER JOIN efr_Branchs AS b ON b.BranchID = m.BranchID AND b.CountryName='Türkiye'
WHERE p.IsSaleProduct = 1
AND b.StartDateTime>DATEADD(DAY,-15,GETDATE())
GROUP BY p.ProductName,isnull(p.ExternalCode,'')
ORDER BY p.ProductName