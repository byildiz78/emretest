UPDATE GlobalMenuItems
SET MenuItemCost = round((isnull(posManafactureFormula.TaxedNetCost,0)),3)
FROM posManafactureFormulaAssign INNER JOIN
 posProducts ON posManafactureFormulaAssign.ProductID = posProducts.ProductID INNER JOIN
 GlobalMenuItems ON posProducts.ProductKey = GlobalMenuItems.MenuItemGlobalKey INNER JOIN
 posManafactureFormula ON posManafactureFormulaAssign.FormulaID = posManafactureFormula.FormulaID;


SELECT b.BranchName, t.MenuItemText, t.MenuItemGroupText, SUM(t.Quantity) AS SatilanMiktar, ROUND((SUM(t.ExtendedPrice)), 2) AS SatisTutari, 
 t.MenuItemUnitPrice AS [Birim Fiyat], ROUND(SUM(isnull(t.Quantity,0)) * isnull(gm.MenuItemCost,0), 2) AS ReceteMaliyet
FROM OrderTransactions as t WITH (NOLOCK)
LEFT OUTER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID  
LEFT OUTER JOIN GlobalMenuItems AS gm ON gm.BranchID=t.BranchID AND gm.MenuItemKey=t.MenuItemKey 
WHERE t.OrderDateTime>@date1 AND t.OrderDateTime<@date2 AND t.@BranchID and t.LineDeleted=0  
GROUP BY b.BranchName,t.MenuItemText,t.MenuItemGroupText,t.MenuItemUnitPrice,gm.MenuItemCost