SELECT b.BranchName AS [Şube], r.PaymentName AS [Ödeme Tipi],round(SUM(isnull(p.AmountPaid,0)),2) AS [Tahsilat], round(r.PaymentClose,2) AS [Teslim]
  FROM(
SELECT r.BranchID, sum(isnull(r.PaymentTotal,0)) AS PaymentTotal,sum(isnull(r.PaymentClose,0)) AS PaymentClose,r.PaymentName
FROM (
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod1, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod1, 0) AS PaymentClose, isnull(rs.PaymentMethodName1,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod2, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod2, 0) AS PaymentClose, isnull(rs.PaymentMethodName2,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod3, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod3, 0) AS PaymentClose, isnull(rs.PaymentMethodName3,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod4, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod4, 0) AS PaymentClose, isnull(rs.PaymentMethodName4,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod5, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod5, 0) AS PaymentClose, isnull(rs.PaymentMethodName5,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod6, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod6, 0) AS PaymentClose, isnull(rs.PaymentMethodName6,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod7, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod7, 0) AS PaymentClose,isnull(rs.PaymentMethodName7,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod8, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod8, 0) AS PaymentClose, isnull(rs.PaymentMethodName8,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod9, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod9, 0) AS PaymentClose, isnull(rs.PaymentMethodName9,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod10, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod10, 0) AS PaymentClose, isnull(rs.PaymentMethodName10,'') AS PaymentName
FROM RegisterSessions AS rs WHERE rs.SignInDateTime<=@date2 AND rs.SignInDateTime>@date1
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod11, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod11, 0) AS PaymentClose, isnull(rs.PaymentMethodName11,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod12, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod12, 0) AS PaymentClose, isnull(rs.PaymentMethodName12,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod13, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod13, 0) AS PaymentClose, isnull(rs.PaymentMethodName13,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod14, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod14, 0) AS PaymentClose, isnull(rs.PaymentMethodName14,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod15, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod15, 0) AS PaymentClose, isnull(rs.PaymentMethodName15,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod16, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod16, 0) AS PaymentClose, isnull(rs.PaymentMethodName16,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod17, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod17, 0) AS PaymentClose, isnull(rs.PaymentMethodName17,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod18, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod18, 0) AS PaymentClose, isnull(rs.PaymentMethodName18,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod19, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod19, 0) AS PaymentClose, isnull(rs.PaymentMethodName19,'') AS PaymentName
FROM RegisterSessions AS rs WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
UNION ALL 
SELECT rs.BranchID,rs.RegisterSessionID,ISNULL(rs.TotalPaymentMethod20, 0) AS PaymentTotal, ISNULL(rs.ClosePaymentMethod20, 0) AS PaymentClose, isnull(rs.PaymentMethodName20,'') AS PaymentName
FROM RegisterSessions AS rs  WHERE (rs.SignOutDateTime IS NOT NULL) and rs.SignInDateTime>=@date1 AND rs.SignInDateTime<=@date2 and rs.@BranchID
)AS r
WHERE r.PaymentTotal>0 OR r.PaymentClose>0
GROUP BY r.PaymentName,r.BranchID
) AS r
INNER JOIN OrderPayments AS p ON r.PaymentName=p.PaymentMethodName AND p.BranchID=r.BranchID
INNER JOIN efr_Branchs AS b ON b.BranchID = p.BranchID
AND p.@BranchID
AND p.LineDeleted=0
AND p.PaymentDateTime>=@date1
AND p.PaymentDateTime<=@date2
GROUP BY r.PaymentName,r.PaymentTotal, PaymentClose,b.BranchName