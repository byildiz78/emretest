DECLARE @ciro FLOAT;

SET @ciro=(SELECT SUM(h.AmountDue) AS reportValue
FROM OrderHeaders AS h WITH(NOLOCK)
WHERE h.OrderDateTime BETWEEN @date1 and @date2
AND h.linedeleted=0 and h.@BranchID
);

DECLARE @tabakSayisi FLOAT;
SET @tabakSayisi=(SELECT round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) AS reportValue
FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField12='TABAKLAR'
WHERE h.OrderDateTime BETWEEN @date1 and @date2
AND h.linedeleted=0 and h.@BranchID
and h.OrderType !=5
);

select 
b.BranchName as [Şube],
(select 
ROUND(SUM(t.ExtendedPrice * isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1) ), 2)
from OrderTransactions t
inner join OrderHeaders h on h.OrderKey=t.OrderKey and h.LineDeleted=0
where h.OrderDateTime between @date1 and @date2 and h.BranchID=b.BranchID
and t.LineDeleted=0) as Ciro,
(SELECT SUM(t.Quantity) AS reportValue
FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField12='TABAKLAR'
WHERE h.OrderDateTime between @date1 and @date2 
AND h.BranchID=b.BranchID
AND h.linedeleted=0) as [Tabak Sayısı],
(SELECT
round((ISNULL((SUM(CASE WHEN ISNULL(m.CustomField12,'')='YAN ÜRÜNLER' 
THEN ( isnull(nullif(t.ExtendedPrice,0),t.Quantity*m1.DefaultUnitPrice) /*ISNULL(((h.AmountDue/nullif(isnull(nullif(h.SubTotal,0),h.AmountDue),0))),1)*/
) ELSE 0 END)),0)/nullif(@ciro,0)*100),2) reportValue3
FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN NewGlobalMenuItems m1 ON m1.MenuItemKey = t.MenuItemKey
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey
WHERE h.OrderDateTime between @date1 and @date2 
and h.BranchID = b.BranchID
AND h.linedeleted=0) as [Yan Ürün Yüzde],
(SELECT round((isnull((100*SUM(t.Quantity)/nullif(@tabakSayisi,0)),0.0)),2) as Oran
 FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.BranchID = h.BranchID AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField12 LIKE'%SAĞLIKLI%'
WHERE h.LineDeleted=0
AND h.OrderDateTime between @date1 and @date2 
AND h.BranchID=b.BranchID
and h.OrderType !=5) as [Sağlıklı İçecek Yüzde],
(SELECT round((isnull((100*SUM(t.Quantity)/nullif(@tabakSayisi,0)),0.0)),2) as Oran
 FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.BranchID = h.BranchID AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField12='İÇECEKLER'
WHERE h.LineDeleted=0
AND h.OrderDateTime between @date1 and @date2 
AND h.BranchID=b.BranchID
and h.OrderType !=5) as [Toplam İçecek Yüzde],
(SELECT round((isnull((100*SUM(t.Quantity)/nullif(@tabakSayisi,0)),0.0)),2) as Oran
 FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.BranchID = h.BranchID AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField13='BAŞLANGIÇ'
WHERE h.LineDeleted=0
AND h.OrderDateTime between @date1 and @date2 
AND h.BranchID=b.BranchID
and h.OrderType !=5) as [Başlangıç Yüzde],
(SELECT round((isnull((100*SUM(t.Quantity)/nullif(@tabakSayisi,0)),0.0)),2) as Oran
 FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.BranchID = h.BranchID AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField13='ÇORBA'
WHERE h.LineDeleted=0
AND h.OrderDateTime between @date1 and @date2 
AND h.BranchID=b.BranchID
and h.OrderType !=5) [Çorba Yüzde],
(SELECT ROUND(SUM(h.AmountDue),2) AS reportValue
FROM OrderHeaders AS h WITH(NOLOCK)
WHERE h.OrderDateTime BETWEEN @date1 and @date2
AND h.linedeleted=0 and h.OrderType=5 and h.BranchID=b.BranchID
) as [Paket Ciro],
(SELECT SUM(t.Quantity) AS reportValue
FROM OrderHeaders AS h WITH(NOLOCK)
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey AND t.LineDeleted=0
INNER JOIN posProducts as m on m.ProductKey=t.MenuItemKey and m.CustomField12='TABAKLAR'
WHERE h.OrderDateTime between @date1 and @date2 
AND h.BranchID=b.BranchID
AND h.linedeleted=0 and h.OrderType=5) as [Paket Tabak Sayısı],
(select count(1) from OrderHeaders h
where OrderType=5
and h.LineDeleted=0
and h.OrderDateTime between @date1 and @date2
AND h.BranchID=b.BranchID) [Paket Adisyon Sayısı]
from efr_Branchs b
where b.IsActive=1 and b.@BranchID
order by b.BranchName