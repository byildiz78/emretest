WITH satis as (
SELECT t.BranchID,t.MenuItemKey,sum(t.Quantity) AS Quantity FROM OrderHeaders AS h
INNER JOIN OrderTransactions AS t ON t.OrderKey = h.OrderKey
AND t.BranchID = h.BranchID AND t.LineDeleted=0
WHERE h.OrderDateTime>@date1
AND h.OrderDateTime<@date2
AND h.LineDeleted=0
AND h.@BranchID
GROUP BY t.BranchID,t.MenuItemKey)
SELECT b.BranchName AS [Şube], p.ProductCode AS [Satılan Ürün Kodu], p.ProductName AS [Satılan Ürün],s.Quantity AS [Satış Miktar]
,fp.ProductCode AS [Tüketilen Ürün Kodu], fp.ProductName AS [Tüketilen Ürün],round(s.Quantity*fd.Amount,3) AS [Tüketim]
FROM satis AS s
INNER JOIN GlobalMenuItems AS m ON m.BranchID=s.BranchID AND s.MenuItemKey = m.MenuItemKey
INNER JOIN posProducts AS p ON p.ProductKey=m.MenuItemGlobalKey
INNER JOIN posManafactureFormulaAssign AS fa ON fa.BranchID=s.BranchID AND fa.ProductID=p.ProductID
INNER JOIN posManafactureFormulaDetail AS fd ON fd.FormulaID = fa.FormulaID
INNER JOIN posProducts AS fp ON fp.ProductID = fd.ProductID
INNER JOIN efr_Branchs AS b ON b.BranchID = s.BranchID