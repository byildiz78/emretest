select 
k.Şube,
k.ürün as Ürün,
sum(k.SumAlt) as Adet,
isnull(round((sum(k.SumAlt)/sum(nullif(k.GrandTotal,0)))*100,2),0) as Oran

from(
SELECT 
r.BranchName as Şube,
r.MenuItemText as ürün,
SUM(r.alt) AS SumAlt,
(select sum(y.ktot) from(
SELECT SUM(r2.alt) as ktot FROM (
    SELECT
      br.BranchName,
      CONVERT(VARCHAR, DATEADD(DAY, DATEDIFF(dd, 0, DATEADD(HOUR, -6, t.OrderDateTime)), 0), 23) AS [Date],
      t2.MenuItemText,
      SUM(t2.Quantity) AS alt

    FROM

      OrderTransactions t WITH (NOLOCK)
      INNER JOIN efr_Branchs br WITH (NOLOCK) ON br.BranchID = t.BranchID
      INNER JOIN posProducts p WITH (NOLOCK) ON p.ProductKey = t.MenuItemKey AND p.IsKto = 1
      LEFT JOIN OrderTransactions t2 WITH (NOLOCK) ON t2.OrderKey = t.OrderKey AND t2.MainMenuItemTransactionKey = t.TransactionKey AND t2.LineDeleted = 0
    WHERE

      1=1
      AND t.LineDeleted = 0
      AND t.OrderDateTime BETWEEN @date1 AND @date2
      AND t.@BranchID
      AND t.IsMainCombo = 1
    GROUP BY
      br.BranchName,
      CONVERT(VARCHAR, DATEADD(DAY, DATEDIFF(dd, 0, DATEADD(HOUR, -6, t.OrderDateTime)), 0), 23),
      t2.MenuItemText

      ) AS r2


union all

SELECT SUM(r3.alt) as ktot FROM (
    SELECT
br.BranchName,
    CONVERT(VARCHAR, DATEADD(DAY, DATEDIFF(dd, 0, DATEADD(HOUR, -6, t.OrderDateTime)), 0), 23) AS [Date],
    t2.MenuItemText,
    SUM(t2.Quantity) AS alt
FROM
OrderTransactions t WITH ( NOLOCK )
INNER JOIN efr_Branchs br WITH ( NOLOCK ) ON br.BranchID = t.BranchID
INNER JOIN posProducts p WITH ( NOLOCK ) ON p.ProductKey = t.MenuItemKey AND p.IsKto = 1 
LEFT JOIN OrderTransactions t2 WITH ( NOLOCK ) ON t2.OrderKey = t.OrderKey AND t2.MainMenuItemTransactionKey = t.MainMenuItemTransactionKey AND t2.LineDeleted = 0

WHERE

1=1
AND t.LineDeleted = 0
AND t.OrderDateTime BETWEEN @date1 AND @date2
AND t.@BranchID
AND t.MainMenuItemText IN ('PERSONEL MENÜ (KTO)')
and t2.MenuItemText not like '%KTO%'
and t2.MenumItemCategoryText ='KTO SEÇİM'

GROUP BY

br.BranchName,
CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, t.OrderDateTime )), 0 ), 23),
t2.MenuItemText

  ) AS r3
) as y) AS GrandTotal

FROM (
  SELECT
    br.BranchName,
    CONVERT(VARCHAR, DATEADD(DAY, DATEDIFF(dd, 0, DATEADD(HOUR, -6, t.OrderDateTime)), 0), 23) AS [Date],
    t2.MenuItemText,
    SUM(t2.Quantity) AS alt

  FROM

    OrderTransactions t WITH (NOLOCK)
    INNER JOIN efr_Branchs br WITH (NOLOCK) ON br.BranchID = t.BranchID
    INNER JOIN posProducts p WITH (NOLOCK) ON p.ProductKey = t.MenuItemKey AND p.IsKto = 1
    LEFT JOIN OrderTransactions t2 WITH (NOLOCK) ON t2.OrderKey = t.OrderKey AND t2.MainMenuItemTransactionKey = t.TransactionKey AND t2.LineDeleted = 0

  WHERE

    1=1
    AND t.LineDeleted = 0
    AND t.OrderDateTime BETWEEN @date1 AND @date2
    AND t.@BranchID
    AND t.IsMainCombo = 1

  GROUP BY

    br.BranchName,
    CONVERT(VARCHAR, DATEADD(DAY, DATEDIFF(dd, 0, DATEADD(HOUR, -6, t.OrderDateTime)), 0), 23),
    t2.MenuItemText
) AS r

GROUP BY r.MenuItemText,r.BranchName

UNION ALL

select 

l.BranchName as Şube,
l.MenuItemText as ürün,
SUM(l.alt) AS SumAlt,
  0 AS GrandTotal
 from(

SELECT
br.BranchName,
    CONVERT(VARCHAR, DATEADD(DAY, DATEDIFF(dd, 0, DATEADD(HOUR, -6, t.OrderDateTime)), 0), 23) AS [Date],
    t2.MenuItemText,
    SUM(t2.Quantity) AS alt

FROM

OrderTransactions t WITH ( NOLOCK )
INNER JOIN efr_Branchs br WITH ( NOLOCK ) ON br.BranchID = t.BranchID
INNER JOIN posProducts p WITH ( NOLOCK ) ON p.ProductKey = t.MenuItemKey AND p.IsKto = 1 
LEFT JOIN OrderTransactions t2 WITH ( NOLOCK ) ON t2.OrderKey = t.OrderKey AND t2.MainMenuItemTransactionKey = t.MainMenuItemTransactionKey AND t2.LineDeleted = 0

WHERE

1=1
AND t.LineDeleted = 0
AND t.OrderDateTime BETWEEN @date1 AND @date2
AND t.@BranchID
AND t.MainMenuItemText IN ('PERSONEL MENÜ (KTO)')
and t2.MenuItemText not like '%KTO%'
and t2.MenumItemCategoryText ='KTO SEÇİM'

GROUP BY

br.BranchName,
CONVERT(VARCHAR, DATEADD( DAY, DATEDIFF( dd, 0, DATEADD( HOUR, -6, t.OrderDateTime )), 0 ), 23),
t2.MenuItemText



) as l
group by l.BranchName,l.MenuItemText
) as k

group by k.Şube,k.ürün