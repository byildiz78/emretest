DECLARE @dt1 DATETIME,@dt2 DATETIME
SELECT @dt1=@date1,@dt2=@date2

;with cirolar as(
select b.BranchID,ROUND(SUM(CASE WHEN h.OrderType<>5 THEN h.AmountDue ELSE 0 END),2) as PaketDisiCiro,ROUND(SUM(h.AmountDue),2) as Ciro from OrderHeaders h with(nolock)
INNER JOIN efr_Branchs b with(nolock) On b.BranchID=h.BranchID
where 1=1
AND h.OrderDateTime between @dt1 and @dt2
AND h.LineDeleted=0
AND b.@BranchID
group by b.BranchID
),
 tabaklar as (
SELECT 
h.BranchID,round(SUM(t.Quantity),0) AS Adet,round(SUM(CASE WHEN h.OrderType<>5 THEN t.Quantity ELSE 0 END),0) as PaketDisiAdet
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey 
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
AND h.linedeleted=0
AND t.LineDeleted=0
and m.CustomField12='TABAKLAR'
AND t.@BranchID
group by h.BranchID
),
adisyonlar as (
select h.BranchID,SUM(CASE WHEN OrderType=5 THEN 1 ELSE 0 END) as Seftenisteadisyonsayisi 
from OrderHeaders h WITH (NOLOCK)
where 
h.LineDeleted=0
and OrderDateTime between @dt1 and @dt2
AND h.@BranchID
group by h.BranchID
)

select 
b.BranchName as [Şube],
c.Ciro as [Toplam Ciro],
(SELECT round((isnull((nullif(SUM(t.Quantity),0)),0.0)),0) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
AND t.linedeleted=0
and m.CustomField12='TABAKLAR') as [Ziyaretçi Sayısı],
(SELECT round((isnull((c.Ciro / nullif(SUM(t.Quantity),0)),0.0)),2) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
AND t.linedeleted=0
and m.CustomField12='TABAKLAR') as [Ciro / Kişi Ortalama Tutar],
(
SELECT paketciro  FROM (
	SELECT 		
		round(SUM(h.AmountDue),2) as paketciro
		
	FROM 
		OrderHeaders AS h WITH (NOLOCK)		
	WHERE 
		h.OrderDateTime between @dt1 AND @dt2
		AND h.LineDeleted=0
		AND h.OrderType=5
		AND h.BranchID=b.BranchID) AS TABLO
) as [Şeften İste Ciro],
(
SELECT ROUND(paketciro/c.ciro*100,1)  FROM (
	SELECT 		
		round(SUM(h.AmountDue),2) as paketciro
		
	FROM 
		OrderHeaders AS h WITH (NOLOCK)		
	WHERE 
		h.OrderDateTime between @dt1 AND @dt2
		AND h.LineDeleted=0
		AND h.OrderType=5
		AND h.BranchID=b.BranchID) AS TABLO
) as [Şeften İste Ciro % ],
(
SELECT
SUM(t.Quantity)
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey 
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
and h.OrderType=5
AND t.BranchID=b.BranchID
AND h.linedeleted=0
AND t.LineDeleted=0
and m.CustomField12='TABAKLAR'
) as [Şeften İste Tabak],
(
SELECT
ROUND(SUM(t.Quantity)/tabak.Adet*100,1) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey 
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE t.OrderDateTime between @dt1 and @dt2
and h.OrderType=5
AND t.BranchID=b.BranchID
AND h.linedeleted=0
AND t.LineDeleted=0
and m.CustomField12='TABAKLAR'
) as [Şeften İste Tabak %],
(adisyon.Seftenisteadisyonsayisi  ) as [Şeften İste Adisyon Sayısı],
(
select 
round(SUM(isnull(h.AmountDue,0))/(case when adisyon.Seftenisteadisyonsayisi=0 then 1 else adisyon.Seftenisteadisyonsayisi end),2) 
from OrderHeaders h WITH (NOLOCK)
where h.OrderType=5
and h.LineDeleted=0
and h.BranchID=b.BranchID
and h.OrderDateTime between @dt1 and @dt2
) AS [Sepet Ortalaması (TL)],
(
SELECT 
ROUND(SUM(t.ExtendedPrice * isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1) ), 2) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON h.OrderKey = t.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey
WHERE t.OrderDateTime BETWEEN @dt1 AND @dt2
and t.BranchID=b.BranchID
AND t.LineDeleted=0
and h.OrderType <> 5
AND h.linedeleted=0
AND ISNULL(m.CustomField12,'')='YAN ÜRÜNLER') as [Restoran Yan Ürün Tutar],
(
SELECT 
ROUND((SUM(t.ExtendedPrice * isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1))/ NULLIF(c.PaketDisiCiro,0))*100, 1) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON h.OrderKey = t.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey
WHERE t.OrderDateTime BETWEEN @dt1 AND @dt2
and t.BranchID=b.BranchID
AND t.LineDeleted=0
and h.OrderType <> 5
AND h.linedeleted=0
AND ISNULL(m.CustomField12,'')='YAN ÜRÜNLER') as [Restoran Yan Ürün Yüzdesi],
(SELECT 
SUM(t.Quantity) 
 FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
AND t.LineDeleted=0
and h.OrderType !=5
and m.CustomField12='PERSONEL MENÜ') as [Personel Menü Adet],
(SELECT 
round((isnull(((SUM(t.Quantity)/nullif(tabak.PaketDisiAdet,0))*100),0.0)),1) 
 FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
AND t.LineDeleted=0
and h.OrderType !=5
and m.CustomField12='PERSONEL MENÜ') as [Personel Menü Yüzde],
(SELECT 
round((isnull((SUM(t.Quantity)/nullif(tabak.PaketDisiAdet,0))*100,0.0)),1) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.LineDeleted=0
AND t.BranchID=b.BranchID
and h.OrderType <>5
and m.CustomField12 like '%İÇECEK%') as [Toplam İçecek / Ziy Sayısı %],
(SELECT 
SUM(t.Quantity) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.LineDeleted=0
AND t.BranchID=b.BranchID
and h.OrderType <>5
and m.CustomField12 like '%İÇECEK%') as [İçecek Sayısı],
(SELECT 
SUM(t.Quantity) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.LineDeleted=0
AND t.BranchID=b.BranchID
and h.OrderType <>5
and m.CustomField12 ='SAĞLIKLI İÇECEK') as [Sağlıklı İçecek Sayısı ],
(SELECT 
round((isnull((SUM(t.Quantity)/nullif(tabak.PaketDisiAdet,0))*100,0.0)),1) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.LineDeleted=0
AND t.BranchID=b.BranchID
and h.OrderType <>5
and m.CustomField12 ='SAĞLIKLI İÇECEK') as [Sağlıklı İçecek / Ziy Sayısı %],
(SELECT 
SUM(t.Quantity) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
AND t.LineDeleted=0
and h.OrderType !=5
and m.CustomField13='ÇORBA') as [Çorba sayısı],
(SELECT 
round((isnull((100*SUM(t.Quantity)/nullif(tabak.PaketDisiAdet,0)),0.0)),1) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
AND t.LineDeleted=0
and h.OrderType !=5
and m.CustomField13='ÇORBA') as [Çorba / Ziyaretçi sayısı %],
(SELECT 
SUM(t.Quantity) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
and h.OrderType !=5
AND t.LineDeleted=0
and m.CustomField13='BAŞLANGIÇ') AS [Başlangıç sayısı],
(SELECT 
round((isnull((100*SUM(t.Quantity)/nullif(tabak.PaketDisiAdet,0)),0.0)),1) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
and h.OrderType !=5
AND t.LineDeleted=0
and m.CustomField13='BAŞLANGIÇ') AS [Başlangıç / Ziy sayısı %],
(SELECT 
SUM(t.Quantity) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
and h.OrderType !=5
AND t.LineDeleted=0
and t.MenuItemKey='255DD31E-C140-4C67-91A0-4710F27F9035') as [Dolu Dolu Ramazan Menü Adet],
(SELECT 
round((isnull((100*SUM(t.Quantity)/nullif(tabak.PaketDisiAdet,0)),0.0)),1) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON t.OrderKey = h.OrderKey
INNER JOIN posProducts as m WITH (NOLOCK) on m.ProductKey=t.MenuItemKey 
WHERE h.LineDeleted=0
AND t.OrderDateTime between @dt1 and @dt2
AND t.BranchID=b.BranchID
and h.OrderType !=5
AND t.LineDeleted=0
and t.MenuItemKey='255DD31E-C140-4C67-91A0-4710F27F9035') AS [Dolu Dolu Ramazan / Ziy sayısı %],
(
SELECT 
ROUND(SUM(t.ExtendedPrice * isnull(nullif(h.AmountDue,0),1) / isnull(nullif(h.SubTotal,0),1) ), 2) 
FROM OrderTransactions AS t WITH(NOLOCK)
INNER JOIN OrderHeaders AS h WITH (NOLOCK) ON h.OrderKey = t.OrderKey
WHERE t.OrderDateTime BETWEEN @dt1 AND @dt2
and t.BranchID=b.BranchID
AND t.LineDeleted=0
and h.OrderType <> 5
AND h.linedeleted=0
and t.MenuItemKey='255DD31E-C140-4C67-91A0-4710F27F9035') as [Dolu Dolu Ramazan Tutar]
from efr_Branchs b
LEFT JOIN cirolar c on c.BranchID=b.BranchID
LEFT JOIN tabaklar tabak on tabak.BranchID=b.BranchID
LEFT JOIN adisyonlar adisyon on adisyon.BranchID=b.BranchID
WHERE b.@BranchID
order by b.BranchName