IF OBJECT_ID('tempdb..#temp') IS NOT NULL DROP TABLE #temp; 
CREATE TABLE #temp (MenuItemText NVARCHAR(100),Quantity FLOAT,ExtendedPrice FLOAT,MenuItemKey UNIQUEIDENTIFIER,BranchID INT,OrderID INT,Tarih DATE); 
INSERT INTO #temp (MenuItemText,Quantity,ExtendedPrice,MenuItemKey,	BranchID,orderID,Tarih)
SELECT t.MenuItemText,t.Quantity,t.ExtendedPrice,t.MenuItemKey,t.BranchID,t.OrderID,CONVERT(DATE,t.OrderDateTime) as Tarih
 FROM OrderTransactions AS t
WHERE t.OrderDateTime>@date1
AND t.OrderDateTime<@date2
AND t.LineDeleted=0
AND t.@BranchID
AND t.CustomField1 LIKE '%-'

IF OBJECT_ID('tempdb..#combo') IS NOT NULL DROP TABLE combo; 
CREATE TABLE #combo (MainMenuItemKey UNIQUEIDENTIFIER,MenuItemText NVARCHAR(100),Quantity FLOAT,ExtendedPrice FLOAT,BranchID INT,MainMenuItemText NVARCHAR(100),OrderID INT,Tarih DATE); 

INSERT INTO #combo 
(MainMenuItemKey,MenuItemText,Quantity,ExtendedPrice,BranchID,MainMenuItemText,OrderID,Tarih)
SELECT t.MenuItemKey,c.MenuItemText,c.Quantity,c.ExtendedPrice as ExtendedPrice,t.BranchID,t.MenuItemText,t.orderID,CONVERT(DATE,t.OrderDateTime) as Tarih
 FROM OrderTransactions AS t
INNER JOIN OrderTransactions AS c ON c.BranchID = t.BranchID AND c.OrderKey = t.OrderKey
AND c.TransactionKey<>t.TransactionKey AND c.LineDeleted=0
AND c.CustomField1 LIKE t.CustomField1+'%'
WHERE t.OrderDateTime>@date1
AND t.OrderDateTime<@date2
AND t.LineDeleted=0
AND t.@BranchID
AND t.CustomField1 LIKE '%-'

IF OBJECT_ID('tempdb..#sonuc') IS NOT NULL DROP TABLE #sonuc; 
CREATE TABLE #sonuc (Tarih DATE, BranchName VARCHAR(100),OrderID INT,MenuItemText VARCHAR(100),Ürün VARCHAR(100),uruntutar FLOAT,Miktar FLOAT,  Quantity FLOAT, ExtendedPrice FLOAT); 
INSERT INTO #sonuc 
SELECT Tarih,b.BranchName, r.OrderID, r.MenuItemText ,r.Ürün,r.uruntutar,r.Miktar, r.Quantity , r.ExtendedPrice 
FROM(
SELECT Tarih,t.OrderID,t.MenuItemText, t.Quantity,0 as uruntutar, t.ExtendedPrice,'' AS Ürün,0 AS Miktar,0 AS SiraNo,t.MenuItemKey,t.BranchID  FROM #temp AS t
UNION ALL
SELECT Tarih,c.orderID,c.MainMenuItemText,0,ExtendedPrice as uruntutar,0,c.MenuItemText,c.Quantity,1,c.MainMenuItemKey,c.BranchID FROM #combo AS c
)AS r 
INNER JOIN efr_Branchs AS b ON b.BranchID=r.BranchID
ORDER BY  b.BranchName,OrderID,r.MenuItemKey,r.SiraNo,r.MenuItemText,r.Ürün

select DISTINCT Tarih,BranchName as Şube,OrderID as [Çek No],MenuItemText as Ürün,Menüler = STUFF((
            SELECT ',' + T2.Ürün
            FROM #sonuc T2
            WHERE T1.OrderID = T2.OrderID AND T1.MenuItemText=T2.MenuItemText
            FOR XML PATH ('')), 1, 1, '') from #sonuc T1 order by Tarih,MenuItemText,OrderID

IF OBJECT_ID('tempdb..#temp') IS NOT NULL DROP TABLE #temp;
IF OBJECT_ID('tempdb..#combo') IS NOT NULL DROP TABLE #combo;