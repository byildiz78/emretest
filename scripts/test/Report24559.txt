
SELECT r.ProductName AS [SATIS URUNU],
       r.Quantity AS [MIKTAR],
       r.ExtendedPrice AS [TUTAR],
       (r.price1 * r.Quantity) AS [FABRIKA MALIYETI],
       (r.price2 * r.Quantity) AS [BAYI MALIYETI],
       (r.price2 * r.Quantity)/nullif(r.ExtendedPrice,0) * 100 AS [Bayi Cost],
       (r.price1 * r.Quantity)/nullif(r.ExtendedPrice,0) * 100 AS [Fabrika Cost]


       
FROM   (
           SELECT p.ProductName,
                  CAST(REPLACE(ISNULL(p.CustomField4, '0'), ',', '.') AS FLOAT) AS 
                  price1,
                  CAST(REPLACE(ISNULL(p.CustomField5, '0'), ',', '.') AS FLOAT) AS 
                  price2,
                  SUM(t.Quantity) AS Quantity,
                  SUM(t.ExtendedPrice) AS ExtendedPrice
           FROM   (
                      SELECT pp.ProductName,
                             MAX(pp.CustomField4) AS CustomField4,
                             MAX(pp.CustomField5) AS CustomField5
                      FROM   posProducts AS pp WITH (NOLOCK)
                      WHERE  pp.CustomField4 IS NOT NULL
                             AND pp.CustomField5 IS NOT NULL
                             AND pp.IsSaleProduct = 1
                      GROUP BY
                             pp.ProductName
                  ) AS p
                  INNER JOIN OrderTransactions AS t WITH (NOLOCK)
                       ON  t.MenuItemText = p.ProductName
           WHERE  t.@BranchID
                  AND t.OrderDateTime >= @date1
                  AND t.LineDeleted = 0
                  AND t.OrderDateTime <= @date2
           GROUP BY
                  p.ProductName,
                  p.CustomField4,
                  p.CustomField5
       ) AS r
ORDER BY
       r.ProductName