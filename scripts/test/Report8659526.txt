select [Şube],
ROUND(SUM([Birim Satış Fiyatı KDVli]),2) [Birim Satış Fiyatı KDVli],
ROUND(SUM([Birim Satış Fiyatı KDVsiz]),2) [Birim Satış Fiyatı KDVsiz],
ROUND(SUM([Satış Adedi]),2) [Satış Adedi],
ROUND(SUM([Satış Toplamı KDVli]),2) [Satış Toplamı KDVli],
ROUND(SUM([Satış Toplamı KDVsiz]),2) [Satış Toplamı KDVsiz],
ROUND(SUM([Satış Maliyeti KDVli]),2) [Satış Maliyeti KDVli],
ROUND(SUM([Satış Maliyeti KDVsiz]),2) [Satış Maliyeti KDVsiz],
ROUND((NULLIF(SUM([Satış Maliyeti KDVsiz]),0)/NULLIF(SUM([Satış Toplamı KDVsiz]),0))*100,2) [Maliyet Yüzde KDVsiz],
ROUND(SUM([Diğer Birim Satış Fiyatı KDVli]),2) [Diğer Birim Satış Fiyatı KDVli],
ROUND(SUM([Diğer Birim Satış Fiyatı KDVsiz]),2) [Diğer Birim Satış Fiyatı KDVsiz],
ROUND(SUM([Diğer Satış Adedi]),2) [Diğer Satış Adedi],
ROUND(SUM([Diğer Satış Toplamı KDVli]),2) [Diğer Satış Toplamı KDVli],
ROUND(SUM([Diğer Satış Toplamı KDVsiz]),2) [Diğer Satış Toplamı KDVsiz],
ROUND(SUM([Diğer Satış Maliyeti KDVli]),2) [Diğer Satış Maliyeti KDVli],
ROUND(SUM([Diğer Satış Maliyeti KDVsiz]),2) [Diğer Satış Maliyeti KDVsiz],
ROUND((NULLIF(SUM([Diğer Satış Maliyeti KDVsiz]),0)/NULLIF(SUM([Diğer Satış Toplamı KDVsiz]),0))*100,2) [Diğer Maliyet Yüzde KDVsiz],
ROUND(SUM([Paket Birim Satış Fiyatı KDVli]),2) [Paket Birim Satış Fiyatı KDVli],
ROUND(SUM([Paket Birim Satış Fiyatı KDVsiz]),2) [Paket Birim Satış Fiyatı KDVsiz],
ROUND(SUM([Paket Satış Adedi]),2) [Paket Satış Adedi],
ROUND(SUM([Paket Satış Toplamı KDVli]),2) [Paket Satış Toplamı KDVli],
ROUND(SUM([Paket Satış Toplamı KDVsiz]),2) [Paket Satış Toplamı KDVsiz],
ROUND(SUM([Paket Satış Maliyeti KDVli]),2) [Paket Satış Maliyeti KDVli],
ROUND(SUM([Paket Satış Maliyeti KDVsiz]),2) [Paket Satış Maliyeti KDVsiz],
ROUND((NULLIF(SUM([Paket Satış Maliyeti KDVsiz]),0)/NULLIF(SUM([Paket Satış Toplamı KDVsiz]),0))*100,2) [Paket Maliyet Yüzde KDVsiz]
from (
select 
[Şube],
[Ürün Grubu],
[Ürün],
Kombo,
[Birim Satış Fiyatı KDVli],
[Birim Satış Fiyatı KDVsiz],
[Diğer Satış Adedi]+[Paket Satış Adedi] as [Satış Adedi],
[Diğer Satış Toplamı KDVli]+[Paket Satış Toplamı KDVli] as [Satış Toplamı KDVli],
[Diğer Satış Toplamı KDVsiz]+[Paket Satış Toplamı KDVsiz] as [Satış Toplamı KDVsiz],
[Diğer Satış Maliyeti KDVli]+[Paket Satış Maliyeti KDVli] as [Satış Maliyeti KDVli],
[Diğer Satış Maliyeti KDVsiz]+[Paket Satış Maliyeti KDVsiz] as [Satış Maliyeti KDVsiz],
[Diğer Birim Satış Fiyatı KDVli],
[Diğer Birim Satış Fiyatı KDVsiz],
[Diğer Satış Adedi],
[Diğer Satış Toplamı KDVli],
[Diğer Satış Toplamı KDVsiz],
[Diğer Satış Maliyeti KDVli],
[Diğer Satış Maliyeti KDVsiz],
[Paket Birim Satış Fiyatı KDVli],
[Paket Birim Satış Fiyatı KDVsiz],
[Paket Satış Adedi],
[Paket Satış Toplamı KDVli],
[Paket Satış Toplamı KDVsiz],
[Paket Satış Maliyeti KDVli],
[Paket Satış Maliyeti KDVsiz]
from (
SELECT 
b.BranchName AS [Şube],
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END AS [Ürün Grubu],
t.MenuItemText as [Ürün],(SELECT DISTINCT ExtendedMenuName from NewGlobalMenuComboItems combo where combo.ComboMenuItemKey=menu.MenuItemPopUpChoiceText) as Kombo,
round(sum(t.ExtendedPrice)/SUM(t.Quantity),2) AS [Birim Satış Fiyatı KDVli],
round(sum(t.ExtendedPrice)/SUM(t.Quantity)*100/(100+t.TaxPercent),2) AS [Birim Satış Fiyatı KDVsiz],
round(NULLIF(sum(CASE WHEN OrderType<>5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END),0),2) AS [Diğer Birim Satış Fiyatı KDVli],
round(NULLIF(sum(CASE WHEN OrderType<>5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END),0)*100/(100+t.TaxPercent),2) AS [Diğer Birim Satış Fiyatı KDVsiz],
SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END) AS [Diğer Satış Adedi],
SUM(CASE WHEN OrderType<>5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END) AS [Diğer Satış Toplamı KDVli],
round(SUM(CASE WHEN OrderType<>5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END)*100/(100+t.TaxPercent),2) AS [Diğer Satış Toplamı KDVsiz],
round((pp.PurchasePrice5 * SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END))*(100+t.TaxPercent)/100,4) AS [Diğer Satış Maliyeti KDVli],
round(pp.PurchasePrice5 * SUM(CASE WHEN OrderType<>5 THEN t.Quantity ELSE 0.00 END),4) AS [Diğer Satış Maliyeti KDVsiz],

round(NULLIF(sum(CASE WHEN OrderType=5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END),0),2) AS [Paket Birim Satış Fiyatı KDVli],
round(NULLIF(sum(CASE WHEN OrderType=5 THEN t.ExtendedPrice ELSE 0.00 END),0)/NULLIF(SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END),0)*100/(100+t.TaxPercent),2) AS [Paket Birim Satış Fiyatı KDVsiz],
SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END) AS [Paket Satış Adedi],
SUM(CASE WHEN OrderType=5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END) AS [Paket Satış Toplamı KDVli],
round(SUM(CASE WHEN OrderType=5 THEN t.ExtendedPrice*(NULLIF(h.AmountDue,0)/NULLIF(h.SubTotal,0)) ELSE 0.00 END)*100/(100+t.TaxPercent),2) AS [Paket Satış Toplamı KDVsiz],
round((pp.PurchasePrice6 * SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END))*(100+t.TaxPercent)/100,4) AS [Paket Satış Maliyeti KDVli],
round(pp.PurchasePrice6 * SUM(CASE WHEN OrderType=5 THEN t.Quantity ELSE 0.00 END),4) AS [Paket Satış Maliyeti KDVsiz]
FROM OrderTransactions AS t WITH (nolock)
LEFT JOIN OrderTransactions t1 on t1.TransactionKey=t.MainMenuItemTransactionKey
LEFT JOIN NewGlobalMenuItems menu on menu.MenuItemKey=t1.MenuItemKey
INNER JOIN efr_Branchs AS b ON b.BranchID = t.BranchID
LEFT JOIN posProducts pp on pp.ProductKey=t.ProductKey
LEFT JOIN OrderHeaders h on h.OrderKey=t.OrderKey
WHERE t.@BranchID AND
t.OrderDateTime BETWEEN @date1 and @date2
AND t.LineDeleted=0
GROUP BY t.BranchID,t.MenuItemtext,t.TaxPercent,menu.MenuItemPopUpChoiceText,pp.PurchasePrice6,pp.PurchasePrice5
,b.BranchName,
CASE WHEN t.MenuItemGroupText like '%KIRMIZI%' THEN '03-KIRMIZILAR'
WHEN t.MenuItemGroupText like '%TAVUK%' THEN '02-TAVUKLAR'
WHEN t.MenuItemGroupText like '%FTEL%' THEN '04-KÖFTELER'
WHEN t.MenuItemGroupText like '%LANG%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%ORBA%' THEN '01-BAŞLANGIÇLAR'
WHEN t.MenuItemGroupText like '%TATL%' THEN '05-TATLI'
WHEN t.MenuItemGroupText like '%CEKLER%' THEN '06-İÇECEKLER'
WHEN t.MenuItemGroupText like '%menü%' THEN '02-TAVUKLAR'
ELSE '02-TAVUKLAR' END) AS TABLO) AS TABLO1
GROUP BY Şube
ORDER BY Şube